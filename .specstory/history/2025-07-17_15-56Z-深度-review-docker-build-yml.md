<!-- Generated by SpecStory -->

# æ·±åº¦ review docker-build.yml (2025-07-17 15:56Z)

_**User**_

æ·±åº¦ review @docker-build.yml 

---

_**Assistant**_



---

ä»¥ä¸‹ä»è§¦å‘æ¡ä»¶ã€çŸ©é˜µé€»è¾‘ã€å„ Job åŠæ­¥éª¤å®ç°ã€ç¼“å­˜ä¸æ€§èƒ½ã€å®‰å…¨åˆè§„ã€å¯ç»´æŠ¤æ€§ 6 ä¸ªç»´åº¦ï¼Œå¯¹ `.github/workflows/docker-build.yml` è¿›è¡Œé€è¡Œ/é€æ®µæ·±åº¦ Reviewã€‚è‹¥æ— ç‰¹åˆ«è¯´æ˜ï¼Œè¡Œå·å‡æŒ‡å‘åŸæ–‡ä»¶ã€‚  
ï¼ˆä¸ºä¿è¯å¯è¯»æ€§ï¼Œåªåœ¨æå°‘æ•°å…³é”®ä½ç½®ä½¿ç”¨ä»£ç å¼•ç”¨å½¢å¼ï¼Œæ–¹ä¾¿ä½ å¿«é€Ÿå®šä½ã€‚ï¼‰

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ä¸€ã€è§¦å‘å™¨ (on) â€“ è¡Œ 1-30
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. åˆ†æ”¯ä¸ Tag  
   â€¢ `branches: [main, develop]` ä¸ `tags: ['v*']` ç»„åˆåˆç†ã€‚è‹¥å¸Œæœ›æ¯æ¬¡ **å‘å¸ƒ Tag ä¸”åå­—ä¸ä»¥ v å¼€å¤´** æ—¶ä¹Ÿè§¦å‘ï¼Œåº”æ”¹ä¸º `tags: ['*']` æˆ–å¢åŠ å¹¶åˆ—è§„åˆ™ã€‚  
2. paths è¿‡æ»¤  
   â€¢ å¯¹ `pull_request` ä»…ç›‘å¬ `main` åˆ†æ”¯ä¼šæ¼æ‰ `develop â†’ main` ä»¥å¤–çš„ PRï¼ˆä¾‹å¦‚ feature-branch â†’ developï¼‰ã€‚å¦‚æƒ³åœ¨æ‰€æœ‰ PR ä¸Šè¿è¡Œï¼Œå¯å»æ‰ `branches` é™åˆ¶ã€‚  

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
äºŒã€detect-changes Job â€“ è¡Œ 35-103
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. Paths-filter  
   â€¢ è·¯å¾„æ¨¡å¼å†™å¾—å¾ˆç»†ï¼Œä½†æ³¨æ„ `apps/backend/**` ä¼šåœ¨ **åˆ é™¤** æ–‡ä»¶æ—¶å¤±æ•ˆï¼ˆdorny/paths-filter v3 ä»…æ£€æµ‹ä¿®æ”¹/æ–°å¢ï¼‰ã€‚å¦‚æœåˆ é™¤æŸåç«¯æ–‡ä»¶æƒ³å¼ºåˆ¶é‡å»ºï¼Œå¯æ‰‹åŠ¨è§¦å‘æˆ–åœ¨ commit å†…ä¿®æ”¹ä»»æ„åŒ¹é…è·¯å¾„ã€‚  
2. è¾“å‡ºé€»è¾‘  
   â€¢ Job è¾“å‡º `services` â†’ `steps.matrix.outputs.services` ï¼ˆè¡Œ 55ï¼‰æ˜¯å¯è¡Œçš„ï¼Œå› ä¸º `matrix` æ­¥éª¤åœ¨åŒä¸€ Job ä¸”æ—©äº Job ç»“æŸã€‚  
3. services ä¸ºç©ºçš„å…œåº•é€»è¾‘  
   â€¢ åªåœ¨ `pushâ†’main` ä¸”æ— æ”¹åŠ¨æ—¶å¼ºåˆ¶æ„å»ºå…¨éƒ¨æœåŠ¡æ˜¯åˆç†çš„ã€‚è‹¥æƒ³åœ¨ **Tag å‘å¸ƒ** æ—¶åŒæ ·å…¨é‡æ„å»ºï¼Œå¯é™„åŠ åˆ¤æ–­ `github.ref_type == 'tag'`ã€‚  

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ä¸‰ã€test Job â€“ è¡Œ 106-141
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. è§¦å‘æ¡ä»¶  
   â€¢ `if: needs.detect-changes.outputs.services != '[]'` okã€‚ä½†å½“æœåŠ¡çŸ©é˜µ JSON ä¸º `["backend"]` æ—¶å­—ç¬¦ä¸²æ¯”è¾ƒä»æˆç«‹ï¼Œæ²¡é—®é¢˜ã€‚  
2. Python æµ‹è¯•  
   â€¢ å»ºè®®æŠŠ `ruff`ã€`mypy` ä¸ `pytest` æ‹†æˆç‹¬ç«‹æ­¥éª¤ï¼Œä¾¿äºä¸€æ¬¡æ€§å¤±è´¥ä¸”è¾“å‡ºæ›´æ¸…æ™°ã€‚  
   â€¢ è‹¥ `uv sync` å®‰è£…ä¾èµ–è€—æ—¶ï¼Œå¯åŠ  `cache: pip`ï¼ˆactions/setup-python æ”¯æŒï¼‰æˆ–ä½¿ç”¨ `uv` è‡ªå¸¦ç¼“å­˜æ–‡ä»¶ã€‚  
3. Frontend æµ‹è¯•  
   â€¢ å…ˆ `pnpm install` å† `cd apps/frontend` æ‰§è¡Œå­å‘½ä»¤æ²¡é—®é¢˜ï¼Œä½† `pnpm install` ä¼šåœ¨æ ¹ç›®å½•å†™ `.pnpm-store` å¹¶å®‰è£…æ‰€æœ‰ workspace ä¾èµ–ï¼Œbuild-context å¤§æ—¶æµªè´¹ã€‚å¯ç›´æ¥åœ¨ `apps/frontend` è¿è¡Œ `pnpm install -w`ï¼ˆä»…è£…å±€éƒ¨ä¾èµ–ï¼‰ã€‚  

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å››ã€build Job â€“ è¡Œ 144-275
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. å¤šæ¶æ„æ„å»º  
   â€¢ QEMU + Buildx v3 ç»„åˆ okã€‚CI æœºå‹æ˜¯ `x86_64`ï¼Œ`linux/arm64` æ„å»ºé€Ÿåº¦ä¼šæ…¢ï¼›å¦‚æ—¶é—´ç“¶é¢ˆæ˜æ˜¾ï¼Œå¯è€ƒè™‘ self-hosted ARM runner åšåŸç”Ÿç¼–è¯‘ã€‚  
2. Build ä¸Šä¸‹æ–‡  
   â€¢ `context=.` æ„å‘³ç€å§‹ç»ˆæŠŠæ•´ä¸ªä»“åº“å‘é€ç»™ Docker å®ˆæŠ¤è¿›ç¨‹ï¼Œä¸Šä¼ æµé‡å¤§ã€ç¼“å­˜å‘½ä¸­ä½ã€‚  
     å»ºè®®ï¼š  
     ```yaml
     backend)  echo "context=apps/backend"  >> $GITHUB_OUTPUT ;;
     frontend) echo "context=apps/frontend" >> $GITHUB_OUTPUT ;;
     ```  
3. Cache-from / Cache-to è¡¨è¾¾å¼  
   â€¢ å½“ `force_rebuild` æœªè®¾ç½®ï¼ˆpush/pull é»˜è®¤ï¼‰æ—¶è¡¨è¾¾å¼è¿”å› `'type=gha'`ï¼ŒOKï¼›è¿”å›ç©ºå­—ç¬¦ä¸²æ—¶ build-push-action ä¼šå°†å…¶è§†ä¸º â€œæœªè®¾ç½®â€ï¼Œä¸ä¼šæŠ¥é”™ã€‚  
   â€¢ è‹¥æƒ³æ˜¾å¼å…³é—­ç¼“å­˜ï¼Œæ¨èç›´æ¥åœ¨ `with:` å—é‡Œä½¿ç”¨ `if:` æ¡ä»¶åŒ…è£¹ `cache-from`ã€`cache-to` å­—æ®µï¼Œè€Œä¸æ˜¯ç©ºå­—ç¬¦ä¸²æŠ€å·§ã€‚  
4. å…ƒæ•°æ®æ ‡ç­¾  
   â€¢ OCI æ ‡å‡†æ ‡ç­¾å®Œå¤‡ã€‚å¯é¢å¤–æ·»åŠ  `org.opencontainers.image.created=${{ steps.build.outputs.created }}ï¼ˆæˆ– dateï¼‰` æé«˜ SBOM/æº¯æºã€‚  
5. Cosign ç­¾å  
   â€¢ ä½¿ç”¨ `timeout 300` + ä¸‰æ¬¡é‡è¯•éå¸¸åˆ°ä½ ğŸ‘  
   â€¢ å»ºè®®åœ¨ç­¾åå‰æ‰§è¡Œ `cosign attest` ç”Ÿæˆ SLSA-provenanceï¼ˆå°¤å…¶è‹¥ä½ å¯ç”¨äº† GitHub OIDCï¼‰ã€‚  
6. Trivy  
   â€¢ `exit-code: 0` ä¿è¯æ¼æ´ä¸é˜»æ–­æµæ°´çº¿ï¼›è‹¥æƒ³â€œè½¯å¤±è´¥â€åªå¯¹ Critical å¼€çº¢ï¼Œå¯æ”¹ä¸º `exit-code: 1` å¹¶ä½¿ç”¨ `continue-on-error: true`ï¼Œè¿™æ ·æŠ¥å‘Šä»ç„¶æ˜¾ç¤ºä¸º âš ï¸ é»„ã€‚  
7. SBOM  
   â€¢ Anchore sbom-action å·²ç»ç”Ÿæˆæ–‡ä»¶å¹¶ä¸Šä¼  artifactï¼Œå®Œå¤‡ã€‚  
8. å¹³å° ID å¤„ç†  
   â€¢ `sed 's/\//-/g'` okï¼Œä½†è‹¥åç»­æƒ³åŒºåˆ†å¤šç‰ˆæœ¬ OSï¼Œå¯æŠŠ `linux/amd64` â†’ `linux-amd64` ä¿ç•™æ¸…æ™°åº¦ã€‚  

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
äº”ã€create-manifest Job â€“ è¡Œ 278-318
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. ä»…ä¸º `latest` åˆ›å»º manifest  
   â€¢ é€‚ç”¨äº main åˆ†æ”¯ï¼›ä½† **Tag/ç‰ˆæœ¬é•œåƒ**ï¼ˆå¦‚ `v1.2.0`ï¼‰ä»æ˜¯ä¸€é•œåƒå¤šæ¶æ„ digestï¼Œè€Œé manifestã€‚å¯åœ¨ `meta` action ä¸­ç”Ÿæˆç»Ÿä¸€ tagï¼Œå†æ­¤ Job æ‹¼æ¥ã€‚  
   â€¢ `docker buildx imagetools create` çš„ `+` è¯­æ³•ï¼ˆåˆå¹¶å¤šä¸ª digestï¼‰æœªä½¿ç”¨ã€‚å¦‚æœä¸¤ä¸ªå¹³å°é•œåƒæœª push å®Œæˆæˆ– tag ä¸ä¸€è‡´ä¼šå¤±è´¥ï¼Œå»ºè®®ï¼š  
     ```bash
     docker buildx imagetools create \
       -t ${IMAGE_NAME}:${TAG} \
       ${IMAGE_NAME}:${TAG}-linux-amd64 \
       ${IMAGE_NAME}:${TAG}-linux-arm64
     ```  

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å…­ã€cleanup Job â€“ è¡Œ 321-351
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. ä»…åˆ é™¤ **untagged** ç‰ˆæœ¬  
   â€¢ `min-versions-to-keep: 20` + `delete-only-untagged-versions: true` å¾ˆå®‰å…¨ã€‚  
   â€¢ å¦‚éœ€ **æŒ‰æ—¶é—´** æ¸…ç†å¸¦ tag çš„æ—§é•œåƒï¼Œå¯é…åˆ `package-version-pattern` æŒ‡å®š semverï¼Œæˆ–æ”¹ç”¨å¼€æº gha-ghcr-cleanup actionã€‚  

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ä¸ƒã€å®‰å…¨ä¸åˆè§„
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. æƒé™æœ€å°åŒ–  
   â€¢ å„ Job `permissions:` å£°æ˜ç²¾å‡†ï¼›`id-token: write` åªåœ¨ build Job ä¸­éœ€è¦ï¼ŒğŸ‘  
2. Secrets ä½¿ç”¨  
   â€¢ ä»…ä½¿ç”¨ GitHub Tokenï¼ˆæ¨é•œåƒï¼‰æ— ç¡¬ç¼–ç å¯†ç ã€‚è‹¥åç»­å¼•å…¥å¤–éƒ¨ä»“åº“ï¼Œè®°å¾—ç”¨ `secrets.*`ã€‚  
3. Dependabot / Renovate  
   â€¢ å¦‚å¸Œæœ›åˆ©ç”¨ CI è‡ªåŠ¨æ„å»ºæµ‹è¯• PRï¼Œä¸º PR è§¦å‘æ·»åŠ  `paths: ['**']` ä¼šæ›´é è°±ã€‚  

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å…«ã€å¯ç»´æŠ¤æ€§ä¸å»ºè®®æ”¹è¿›æ¸…å•
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. **åŠ å…¥ `concurrency`** é˜²æ­¢å¤šæ¬¡æ¨åŒä¸€ Tagï¼ˆç‰¹åˆ«æ˜¯ workflow_dispatch + manual-suffixï¼‰ã€‚  
2. **æ‹†åˆ†** test / build Job é€»è¾‘ä¸ºä¸¤ä¸ªç‹¬ç«‹ YAMLï¼ˆæˆ–ä½¿ç”¨å¤ç”¨ `workflow_call`ï¼‰ï¼Œè®©é¡¶å±‚æ–‡ä»¶æ›´ä¸“æ³¨äº orchestrateã€‚  
3. **é‡ç”¨ action ç‰ˆæœ¬å·**ï¼šæŠŠ `@vX` å›ºå®šåˆ°æ¬¡è¦ç‰ˆæœ¬ï¼ˆ`@v3.0.0`ï¼‰æˆ–ä½¿ç”¨ Dependabot ç›‘æ§æ›´æ–°ï¼Œé¿å…éšå¼ç ´åã€‚  
4. **æ„å»ºä¸Šä¸‹æ–‡ç˜¦èº«**ï¼ˆè§ç¬¬å››èŠ‚ç¬¬ 2 ç‚¹ï¼‰ã€‚  
5. **å¤š Tag manifest**ï¼ˆè§ç¬¬äº”èŠ‚ï¼‰ã€‚  
6. **æ·»åŠ  SBOM ä¸Šä¼ åˆ° GitHub Advanced Security**ï¼ˆæˆ– OSS Review Toolkitï¼‰ï¼Œå½¢æˆç«¯åˆ°ç«¯é“¾è·¯ã€‚  
7. **æ€§èƒ½åŸºå‡†**ï¼šå¯å¯ç”¨ build-push-action çš„ `provenance: true`ï¼ˆ>=v5.1.0ï¼‰é…åˆ Cosignã€‚  

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ç»“è®º
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ•´ä½“ Workflow è®¾è®¡ **ç»“æ„æ¸…æ™°ã€åŠŸèƒ½è¦†ç›–å…¨é¢**ï¼šåŒ…æ‹¬å¢é‡æ„å»ºã€æµ‹è¯•ã€å¤šæ¶æ„é•œåƒã€æ¼æ´æ‰«æã€SBOMã€ç­¾åä¸åºŸå¼ƒé•œåƒæ¸…ç†ï¼Œå·²ç»è¾¾åˆ°ç”Ÿäº§çº§æ°´å¹³ã€‚  
å¦‚èƒ½å¼•å…¥ä¸Šè¿° **æ„å»ºä¸Šä¸‹æ–‡ä¼˜åŒ–ã€manifest åˆå¹¶ã€å¹¶å‘æ§åˆ¶** ç­‰æ”¹è¿›ï¼Œå°†è¿›ä¸€æ­¥æå‡æ€§èƒ½ã€å¯é æ€§ä¸ä¾›åº”é“¾å®‰å…¨ã€‚

---

_**User**_

å·²ç»ä¿®æ”¹å†æ¬¡æ·±åº¦ review

---

_**Assistant**_



---

ä¸‹é¢åŸºäºä½ æœ€æ–°ç‰ˆæœ¬çš„ `.github/workflows/docker-build.yml`ï¼ˆè¡Œ 1-372ï¼‰ï¼Œå†æ¬¡åšä¸€æ¬¡é€æ®µæ·±åº¦ Reviewï¼Œé‡ç‚¹æ”¾åœ¨æœ¬è½®æ”¹åŠ¨åŠä»å¯æ”¹è¿›ä¹‹å¤„ã€‚è‹¥æ— ç‰¹åˆ«è¯´æ˜ï¼Œè¡Œå·å‡æŒ‡å‘æ–°æ–‡ä»¶ã€‚

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
A. å…³é”®ä¿¡æ¯å˜æ›´å›é¡¾
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. **å¤šæ¶æ„é€»è¾‘**  
   â€¢ åŸå…ˆ `matrix: {platform}` è¢«ç§»é™¤ï¼Œæ”¹ä¸ºå•æ­¥ Buildx ä¸€æ¬¡æ€§æ„å»º `linux/amd64,linux/arm64`ï¼Œå¤§å¹…å‡å°‘ Job æ•°é‡ ğŸ‘  
2. **å¹¶å‘æ§åˆ¶**  
   â€¢ `concurrency:` å·²æ·»åŠ åˆ° build / cleanup Jobï¼Œå¯é¿å…å¹¶è¡Œæ¨åŒä¸€é•œåƒæˆ–åˆ é™¤åŒä¸€åŒ…ï¼Œååˆ†å¿…è¦ã€‚  
3. **è¯­è¨€è¿è¡Œæ—¶ç¼“å­˜**  
   â€¢ é’ˆå¯¹ Node ä½¿ç”¨ `setup-node@v4` å¹¶å¼€å¯ `cache: pnpm`ï¼›é’ˆå¯¹ Python å•ç‹¬å®‰è£…ç¯å¢ƒ â†’ æ›´ç»†ç²’åº¦ç¼“å­˜ ğŸ‘  
4. **ä¾›åº”é“¾å®‰å…¨**  
   â€¢ æ–°å¢ `github/attest-build-provenance@v1`ï¼ˆè¡Œ 342-347ï¼‰ï¼Œå°è¯•ç”Ÿæˆ SLSA è¯æ˜ï¼›Cosign ç°åœ¨ `--recursive` ç­¾åå¤šæ¶æ„é•œåƒã€‚  
5. **Trivy / SBOM æ”¹å**  
   â€¢ Trivy å’Œ SBOM æ–‡ä»¶åç®€åŒ–ä¸ºå•æœåŠ¡ï¼Œæ— å¹³å°åç¼€ï¼Œç¬¦åˆå¤šæ¶æ„åˆå¹¶åçš„è¯­ä¹‰ã€‚

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
B. è¯¦ç»†é€æ®µ Review
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. **è§¦å‘å™¨ & è·¯å¾„è¿‡æ»¤**ï¼ˆè¡Œ 1-34ï¼‰  
   â€¢ ä¸ä¸Šä¸€è½®ä¸€è‡´ï¼Œæ— æ–°é—®é¢˜ã€‚  
   â€¢ å¦‚éœ€å¯¹ `develop â†’ main` ä»¥å¤–çš„ PR è·‘å·¥ä½œæµï¼Œä»å»ºè®®å»æ‰ `pull_request.branches` é™åˆ¶ã€‚

2. **detect-changes Job**ï¼ˆè¡Œ 37-104ï¼‰  
   â€¢ `backend` è¿‡æ»¤æ–°å¢ `'packages/**'`ï¼ˆè¡Œ 55ï¼‰ä½¿åç«¯å’Œå‰ç«¯éƒ½ç›‘å¬ `packages`ï¼Œéå¸¸åˆç†ã€‚  
   â€¢ ä»æœ‰ä¸€å¤„å¾®å°é£é™©ï¼šåˆ é™¤æ–‡ä»¶å¯¼è‡´ diff ä¸è§¦å‘çš„é—®é¢˜æœªå˜ï¼Œå¯åœ¨æäº¤é‡Œ mock ä¸€æ¬¡ç©ºæ”¹åŠ¨æˆ–æ‰‹åŠ¨è§¦å‘ã€‚

3. **test Job**ï¼ˆè¡Œ 106-141ï¼‰  
   â€¢ æ–¹æ¡ˆä¿æŒä¸å˜ã€‚Python/Node ä¾èµ–å®‰è£…ä»æœªç¼“å­˜ï¼ˆBackend ä¾§ï¼‰â€”â€”å¯è€ƒè™‘ `actions/setup-python` çš„ `cache: 'pip'` æˆ–åˆ©ç”¨ `uv pip --upgrade --python-version` çš„ç¼“å­˜ç›®å½•ã€‚  
   â€¢ å‰ç«¯ä¾§ç°åœ¨å·²æœ‰ pnpm cacheï¼ŒğŸ‘

4. **build Job**ï¼ˆè¡Œ 144-325ï¼‰  
   a) **concurrency Key**  
      ```yaml
      concurrency:
        group: ${{ github.workflow }}-${{ matrix.service }}-${{ github.ref }}
        cancel-in-progress: true
      ```  
      å¾ˆå¥½ï¼Œä½†å¦‚æœæ‰‹åŠ¨è§¦å‘å¸¦ä¸åŒ `tag_suffix`ï¼Œgroup åä»ç›¸åŒ â†’ ä¼šå–æ¶ˆå‰ä¸€æ¬¡ã€‚å¯æŠŠ `github.run_id` æˆ– `github.event.inputs.tag_suffix` æ‹¼è¿›å»ä»¥é˜²å†²çªã€‚  

   b) **ä¸Šä¸‹æ–‡ï¼ˆè¡Œ 185/193ï¼‰**  
      ä¾æ—§æ˜¯ `context=.`ï¼Œå…¨ä»“åº“å‘é€ BuildKitã€‚æ¨èï¼š  
      ```bash
      backend)  echo "context=apps/backend"  >> $GITHUB_OUTPUT ;;
      frontend) echo "context=apps/frontend" >> $GITHUB_OUTPUT ;;
      ```  
      å¯æ˜¾è‘—å‡å°‘ä¸Šä¼ ä½“ç§¯ & ç¼“å­˜å±‚æ±¡æŸ“ã€‚  

   c) **Buildx cache scope**  
      â€¢ ä½ å·²ç”¨ `scope={service}` åŒºåˆ†ï¼ŒğŸ‘  
      â€¢ è‹¥å¯ç”¨ `context` å¾®è°ƒåï¼Œå†é…åˆ `target=` åˆ†é˜¶æ®µæ„å»ºï¼Œç¼“å­˜å‘½ä¸­ç‡æ›´ä½³ã€‚  

   d) **Trivyã€Cosignã€SBOM**  
      â€¢ ä¾èµ–ä½ç½®ã€å‚æ•°å‡ OKã€‚  
      â€¢ `Trivy exit-code: 0` + upload-sarif `if: always()`ï¼Œä¿ç•™æé†’ä½†ä¸ä¸­æ–­æµæ°´çº¿ï¼Œé€‚åˆæ—©æœŸã€‚  

   e) **Provenance Action**ï¼ˆè¡Œ 342-347ï¼‰  
      **Linter æŠ¥é”™**ï¼š  
      ```
      Err | Unable to resolve action `github/attest-build-provenance@v1`
      ```  
      æ­£ç¡®ä»“åº“ååº”ä¸º `actions/attest-build-provenance@v1`ï¼ˆå®˜æ–¹ï¼‰æˆ–  
      `github-ecosystem/attest-build-provenance@v1`ï¼ˆGitHub Ecosystemï¼‰ã€‚è¯·æ”¹ä¸ºï¼š  
      ```yaml
      uses: actions/attest-build-provenance@v1
      ```  
      å¹¶ç¡®è®¤ `subject-path` æŒ‡å‘æœ¬åœ° tar/attestationï¼›å¦‚æœæƒ³å¯¹è¿œç¨‹ OCI ç”Ÿæˆï¼Œéœ€ `subject-ref` / `subject-digest` ç»„åˆâš ï¸ã€‚

5. **cleanup Job**ï¼ˆè¡Œ 328-372ï¼‰  
   â€¢ ä¹ŸåŠ å…¥äº† `concurrency`ï¼Œå¯é¿å…å¹¶å‘åˆ é™¤ã€‚  
   â€¢ ä¿ç•™ â€œä»…åˆ  untaggedã€ä¿ç•™ 20 ç‰ˆæœ¬â€ â†’ å®‰å…¨ç¨³å¦¥ã€‚  
   â€¢ è‹¥æƒ³è¿›ä¸€æ­¥å‹ç¼©é…é¢ï¼Œå¯è®¾ `min-versions-to-keep` ä¸º 5-10ï¼Œå¹¶åŒæ—¶åˆ é™¤è¿‡æœŸ tagï¼ˆç•™å¾…å°†æ¥ï¼‰ã€‚

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
C. å…¶ä»–å¯æå‡ç»†èŠ‚
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. **å˜é‡å¤ç”¨**  
   `platforms=linux/amd64,linux/arm64` å‡ºç°ä¸¤æ¬¡ï¼ˆmeta labels & build stepï¼‰ï¼Œå¯æŠ½åˆ° `env:` é‡Œã€‚  
2. **steps é¡ºåºä¼˜åŒ–**  
   å¯¹äºåç«¯ï¼Œå¯ä»¥å…ˆè£…ä¾èµ– & è¿è¡Œæµ‹è¯•å† checkoutï¼ˆç¼“å­˜ï¼‰æ²¡æœ‰æ„ä¹‰ï¼Œä¿æŒç°çŠ¶å³å¯ã€‚  
3. **ç¼“å­˜å¤±æ•ˆç­–ç•¥**  
   å¯¹ buildx GHA cacheï¼Œå»ºè®®åŠ  `cache-from: type=gha,scope=${{ matrix.service }},ref=main` è®©åˆ†æ”¯æ„å»ºå¯å€Ÿ main ç¼“å­˜ã€‚  
4. **README / Release note**  
   å¦‚æœæƒ³è®© Provenance & SBOM æ–‡ä»¶å‡ºç°åœ¨ Release Assetï¼Œå¯åœ¨ Tag è§¦å‘æ—¶ä¸Šä¼  GitHub Releaseã€‚  

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
D. æ€»ç»“
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ **æ–°å¢å†…å®¹**ï¼ˆå¹¶å‘æ§åˆ¶ã€å¤šæ¶æ„å•æ­¥æ„å»ºã€SLSA è¯æ˜ï¼‰è®©æµæ°´çº¿æ›´ç°ä»£ã€å®‰å…¨ã€‚  
â€¢ ä»éœ€ **ä¿®æ­£ `attest-build-provenance` Action è·¯å¾„** å¹¶è€ƒè™‘ **ç˜¦èº« Docker æ„å»ºä¸Šä¸‹æ–‡**ã€‚  
â€¢ å…¶ä»–æ”¹è¿›ï¼ˆç¼“å­˜ã€åˆ†æ”¯è¿‡æ»¤ã€å¹¶å‘ group åï¼‰å‡å±å¾®è°ƒï¼Œå¯æŒ‰ä¼˜å…ˆçº§æ‹©æœºå¤„ç†ã€‚

æ•´ä½“æ¥çœ‹ï¼Œå·¥ä½œæµå·²éå¸¸æ¥è¿‘ç†æƒ³çŠ¶æ€ï¼›å¤„ç†å®Œä¸Šé¢ä¸¤ä¸ªä¸»è¦ TODO åå³å¯å®‰å…¨è½åœ°ç”Ÿäº§ã€‚

---

