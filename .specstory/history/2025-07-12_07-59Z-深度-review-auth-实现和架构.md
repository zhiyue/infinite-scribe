<!-- Generated by SpecStory -->

# æ·±åº¦ review auth å®ç°å’Œæ¶æ„ (2025-07-12 07:59Z)

_**User**_

æ·±åº¦ review ä¸€ä¸‹  auth çš„å®ç°å’Œ @/refactor-auth-service-architecture 

---

_**Assistant**_



---

Read file: docs/development/tasks/refactor-auth-service-architecture/README.md

---

Read file: docs/development/tasks/refactor-auth-service-architecture/implementation-plan.md

---

Read file: docs/development/tasks/refactor-auth-service-architecture/progress.md

---

Read file: docs/development/tasks/refactor-auth-service-architecture/todo-list.md

---



---

ä»¥ä¸‹å†…å®¹å°†åˆ†ä¸¤å¤§éƒ¨åˆ†ï¼š  
1. å¯¹ã€Œå·²å†™ä»£ç ã€çš„æ·±åº¦ä»£ç å®¡é˜…ï¼ˆTokenManagerã€Storage / Navigation / HttpClientã€AuthApiClientã€AuthServiceã€Factory ç­‰ï¼‰ã€‚  
2. å¯¹ `docs/development/tasks/refactor-auth-service-architecture` ä¸‹æ–‡æ¡£ï¼ˆREADME / implementation-plan / progress / todo-listï¼‰ä¸å®é™…ä»£ç è½åœ°æƒ…å†µçš„å·®å¼‚ã€é£é™©ä¸ä¸‹ä¸€æ­¥å»ºè®®ã€‚  

---  
## 1. ä»£ç å®ç°æ·±åº¦å®¡é˜…

### 1.1 é¢†åŸŸæ¨¡å‹ä¸ä¾èµ–æ³¨å…¥

**ä¼˜ç‚¹**  
â€¢ æ‰€æœ‰æ ¸å¿ƒä¾èµ–ï¼ˆIStorageService / INavigationService / IHttpClient / ITokenManager / IAuthApiClientï¼‰éƒ½é€šè¿‡æ¥å£æ³¨å…¥ï¼ŒçœŸæ­£åšåˆ°å¯æ›¿æ¢ã€å¯å•æµ‹ã€‚  
â€¢ Factory ä¸ Builder ä¸¤æ¡åˆ›å»ºè·¯å¾„å…¼é¡¾ã€Œä¸€è¡Œé›†æˆã€å’Œã€Œç»†ç²’åº¦å®šåˆ¶ã€ï¼ŒDX å‹å¥½ã€‚  
â€¢ ç¯å¢ƒå·¥å‚ (createDev / createProd / createTest / createEnvironmentAuthService) è®©é…ç½®å·®å¼‚æ˜¾å¼åŒ–ï¼Œé¿å… if-else æ•£è½åœ¨ä¸šåŠ¡ä»£ç ã€‚

**å¯æ”¹è¿›**  
1. Factory ä¸­ `createAuthStorageService` å¯¹ httpOnly ä¸é httpOnly ä¸¤ç§åœºæ™¯çš†è¿”å› localStorageï¼›è‹¥æœªæ¥éœ€è¦ `sessionStorage` æˆ– `memory` ï¼Œè¯·æŠŠé€‰æ‹©é€»è¾‘æŠ½åˆ° config å­—æ®µï¼ˆå¦‚ `storageType`ï¼‰ã€‚  
2. `createAuthHttpClient` ä¼šæŠŠ `withCredentials` ç›´æ¥ä¼ ç»™ Axios/Fetch é…ç½®ï¼Œä½†å½“å‰ IHttpClient å®šä¹‰å¹¶æœªåŒ…å«æ­¤å­—æ®µï¼›å»ºè®®åœ¨æ¥å£å±‚æ˜¾å¼æ”¯æŒï¼Œä»¥ä¾¿å¼ºç±»å‹æ£€æŸ¥ã€‚  
3. Builder ä¸­ä¿å­˜çš„ `config` ä¼šä¸ `DEFAULT_CONFIG` æ·±åº¦åˆå¹¶ï¼Œå†ä¸å¤šæ¬¡ `withConfig` è¦†ç›–ã€‚å½“å‰ merge é€»è¾‘åœ¨ createAuthService ä¸­ä¸€æ¬¡æ€§å®Œæˆï¼Œè‹¥ builder æƒ³å³æ—¶æ ¡éªŒå­—æ®µï¼Œå¯åœ¨ `withConfig` å†…éƒ¨åš shallow merge å¹¶è¿”å›å‰¯æœ¬ã€‚  

### 1.2 TokenManager

**ä¼˜ç‚¹**  
â€¢ ä½¿ç”¨ Map/Storage Service éš”ç¦»å­˜å‚¨åç«¯ï¼Œå•æµ‹è¦†ç›– JWT æ ¼å¼é”™è¯¯ã€refresh ç«æ€ã€Quota Exceeded ç­‰æç«¯åœºæ™¯ã€‚  
â€¢ `isTokenExpiringSoon` / `getTokenSummary` æŠ½è±¡åº¦é«˜ï¼Œç»™ä¸Šå±‚ UI/Hook åšæç¤ºå¾ˆå‹å¥½ã€‚  
â€¢ åˆ·æ–°é€»è¾‘åŠ äº† `isRefreshing` é”ï¼Œä¸” scheduleRefresh åå†æ¬¡ setTokens ä¸ä¼šè¿›å…¥é€’å½’ã€‚  

**å…³æ³¨ç‚¹**  
1. `parseJwtPayload` ä½¿ç”¨ `atob` è§£ç ã€‚æµè§ˆå™¨å’Œ Nodeï¼ˆVitestï¼‰éƒ½æ”¯æŒï¼Œä½†è‹¥åç»­è¦åœ¨ React-Native æˆ– Service-Worker ç¯å¢ƒå¤ç”¨ï¼Œéœ€è¦ polyfillã€‚  
2. scheduleRefresh é‡Œ `console.debug` é»˜è®¤è¾“å‡ºï¼Œå®é™…ç”Ÿäº§åº”ç”± config çš„ `enableDebugLogging` æ§åˆ¶ï¼Œå»ºè®®åœ¨ TokenManager å†…éƒ¨æŒæœ‰è¯¥ flag è€Œé AuthService å±‚çº§ã€‚  
3. é”€æ¯é€»è¾‘ï¼š`destroy()` ä»… cancelRefreshï¼Œè‹¥åç»­åŠ äº‹ä»¶ç›‘å¬ï¼ˆvisibilitychange ç­‰ï¼‰ä¹Ÿè¦åœ¨è¿™é‡Œè§£ç»‘ã€‚  

### 1.3 HttpClient é€‚é…å±‚

**AxiosHttpClient**  
â€¢ å…¨é¢æš´éœ²æ‹¦æˆªå™¨èƒ½åŠ›ï¼Œå†…éƒ¨ç”¨æ•°ç»„è®°å½• id ä¾¿äºæ‰¹é‡ clearã€‚  
â€¢ é”™è¯¯å¤„ç†æŠŠ AxiosError é€ä¼ åŒæ—¶æ‰“å°æ—¥å¿—ï¼Œä¿æŒå‘åå…¼å®¹ã€‚  

**FetchHttpClient**  
â€¢ å¯¹ timeout è‡ªè¡Œç”¨ AbortController æ¨¡æ‹Ÿï¼Œæ»¡è¶³å¤§éƒ¨åˆ†éœ€æ±‚ã€‚  
â€¢ æ²¡æœ‰å®ç°è¯·æ±‚/å“åº”æ‹¦æˆªå™¨ï¼ˆå·²æ‰“å° warnï¼‰ï¼Œå¦‚æœæœªæ¥éœ€è¦å¯åœ¨å¤–å±‚åŒ…è£…è€Œéè¿™é‡Œç¡¬å†™ã€‚  

**MockHttpClient**  
â€¢ Map<method+url,response> ç»“æ„ç›´è§‚ï¼›æ”¯æŒ delay / error æµ‹è¯•æ–¹ä¾¿ã€‚  
â€¢ ç¼ºå°‘ä¸çœŸå®å®¢æˆ·ç«¯å®Œå…¨ä¸€è‡´çš„ config é€ä¼ ï¼ˆå¦‚ headersã€withCredentials ç­‰ï¼‰ï¼Œä½†åœ¨æµ‹è¯•åœºæ™¯è¶³å¤Ÿã€‚  

**å…³æ³¨ç‚¹**  
1. Axios ä¸ Fetch ç‰ˆéƒ½ç¼ºå°‘å¯¹ `withCredentials` çš„æ˜¾å¼æ”¯æŒï¼ˆFetch éœ€è¦ `{credentials:'include'}`ï¼‰ã€‚å¦‚æœæ¥å£åæœŸç»Ÿä¸€è¦æ”¯æŒ Cookieï¼Œéœ€è¡¥å…¨ã€‚  
2. `createAutoHttpClient` å¦‚æœ axios.create æŠ›é”™å³é™çº§åˆ° Fetchï¼Œä½†æ²¡æœ‰è®°å½•é™çº§åŸå› ï¼›å»ºè®® console.warn ä¸€ä¸‹ï¼Œæ–¹ä¾¿è°ƒè¯•ã€‚  

### 1.4 Storage / Navigation

**Storage**  
â€¢ LocalStorageService å¯¹ QuotaExceededError çš„å›æ”¶ç­–ç•¥å¾ˆç»†ï¼šæ‰«æéå…³é”® keyï¼Œå†é‡è¯•å†™å…¥ã€‚  
â€¢ MemoryStorageService å®Œç¾è§£å†³ SSR / æµ‹è¯•åœºæ™¯ã€‚  

**é—®é¢˜**  
- LocalStorageService çš„ `getNonCriticalKeys` è§„åˆ™åŸºäºå­—ç¬¦ä¸²åŒ…å«åˆ¤æ–­ï¼Œè‹¥ä¸šåŠ¡ä¾§åˆšå¥½æŠŠé‡è¦æ•°æ®å‘½åä¸º `cache_` å¯èƒ½è¢«è¯¯åˆ ã€‚å¯è€ƒè™‘åœ¨ config ä¸­æä¾›ç™½åå•/é»‘åå•ã€‚  

**Navigation**  
â€¢ Browser / History / Mock ä¸‰ç§å®ç°æ»¡è¶³ SSRã€SPA å’Œæµ‹è¯•ã€‚  
â€¢ HistoryNavigationService å¯¹ window.history ä¸å­˜åœ¨è‡ªåŠ¨é™çº§åˆ° BrowserNavigationServiceã€‚  

**é£é™©**  
- BrowserNavigationService/HistoryNavigationService å‡åœ¨å‡½æ•°ä¸­ç›´æ¥ `console.*`ï¼Œç”Ÿäº§ä¸‹å¯æ ¹æ® `enableDebugLogging` å†³å®šè¾“å‡ºçº§åˆ«ã€‚  

### 1.5 AuthApiClient

**äº®ç‚¹**  
â€¢ æ‰€æœ‰æ¥å£éƒ½ç»Ÿä¸€ `handleApiError`ï¼ŒæŠŠ detail / status_code / retry_after ç»“æ„åŒ–è¿”å›ï¼Œæµ‹è¯•è¦†ç›–éå¸¸å…¨é¢ã€‚  
â€¢ åˆ·æ–°ä»¤ç‰Œåœ¨ httpOnly æ¨¡å¼ä¸‹ä¸ä¼šå‘ bodyï¼Œé€»è¾‘æ¸…æ™°ã€‚  

**å°ç¼ºé™·**  
1. `setupHttpClient` æ€»æ˜¯è°ƒç”¨ `this.httpClient.setDefaultHeader('Content-Type','application/json')`ã€‚è‹¥ä¼ å…¥çš„è‡ªå®šä¹‰ httpClient å·²ç»å¸¦é»˜è®¤ header å¯èƒ½è¢«è¦†ç›–ã€‚å¯æ”¹ä¸ºä»…åœ¨ä¸å­˜åœ¨æ—¶è®¾ç½®ã€‚  
2. `logout()` åœ¨ catch ä¸­ rethrow çš„æ˜¯å¤„ç†è¿‡çš„ ApiErrorï¼Œè€Œä¸Šå±‚ AuthService çš„ logout æ•è·è¯¥é”™è¯¯åä»… warnï¼›è¿™ä¼šå¯¼è‡´è°ƒç”¨è€…æ— æ³•æ„ŸçŸ¥æœåŠ¡å™¨çœŸæ­£çš„ logout é”™è¯¯ï¼ˆè¢«é™é»˜ï¼‰ã€‚æ ¹æ®ä¸šåŠ¡éœ€æ±‚å†³å®šæ˜¯å¦å›æŠ›ã€‚  

### 1.6 AuthService æ ¸å¿ƒ

**æˆåŠŸç‚¹**  
â€¢ `initialize â†’ setupHttpInterceptors â†’ scheduleTokenRefresh` æµç¨‹ç®€æ´ï¼Œä¸”é˜²æ­¢é‡å¤åˆå§‹åŒ–ã€‚  
â€¢ å“åº”æ‹¦æˆªå™¨é‡Œé‰´åˆ« auth endpointsã€å¤„ç† _retry æ ‡è®°ã€é˜²å¹¶å‘ refresh å‡è€ƒè™‘åˆ°ã€‚  
â€¢ `handleRefreshFailure` è‡ªåŠ¨æ¸… token + é‡å®šå‘ loginï¼Œé€»è¾‘é›†ä¸­ã€‚  
â€¢ `getServiceStatus` è®©å¤–éƒ¨å¯è§‚æµ‹å¥åº·åº¦ï¼Œæœ‰åˆ©äº Debugã€‚  

**éœ€è¦æ³¨æ„**  
1. `performTokenRefresh` å†…éƒ¨ debug log ä¾èµ– `this.config.enableDebugLogging`ï¼Œè€Œ TokenManager çš„ debug æ‰“å°ä¸å—æ­¤æ§åˆ¶ï¼ˆè§å‰è¿°ï¼‰ã€‚  
2. é‡è¯•åŸè¯·æ±‚æ—¶åªåšäº† `GET` é‡è¯• (`this.httpClient.get(originalRequest.url, originalRequest)`)ï¼Œå¦‚æœåŸæ–¹æ³•æ˜¯ POST/PUT å°†å¤±è´¥ï¼›å¯æ”¹ä¸º `this.httpClient[originalRequest.method]`.  
3. `isAuthEndpoint` é€šè¿‡å­—ç¬¦ä¸² includes åˆ¤æ–­ï¼Œè‹¥ä¸šåŠ¡ä¸­æœ‰ `/auth/login/v2` ä¹Ÿä¼šå‘½ä¸­ã€‚å»ºè®®ä»¥æ­£åˆ™æˆ–å®Œæ•´è·¯å¾„åŒ¹é…ã€‚  
4. `AuthService.logout()` åœ¨ catch ä¸­æŠŠé”™è¯¯åæ‰åª warnï¼Œä¸”ä» wrap æˆ success responseï¼›å¦‚æœå‰ç«¯é¡µé¢è¦æ ¹æ®æœåŠ¡å™¨è¿”å›çš„ 400/500 åšæç¤ºä¼šå¤±çœŸã€‚  

### 1.7 æµ‹è¯•è¦†ç›–

- Vitest ç”¨ä¾‹æ•°é‡åºå¤§ï¼Œå‡ ä¹æ¯æ¡åˆ†æ”¯éƒ½èµ°åˆ°ï¼ŒğŸ‘  
- Interface compliance éƒ¨åˆ†é€šè¿‡å·¥å‚åŠ¨æ€ç”Ÿæˆå®ä¾‹å†æ‰§è¡Œç”¨ä¾‹ï¼Œç¡®ä¿ä¸åŒå®ç°æ»¡è¶³ç›¸åŒè¡Œä¸ºï¼Œå¾ˆåŠ åˆ†ï¼  
- å°‘é‡å¯è¡¥å……ï¼š  
  * AuthInterceptor æ­£å‘åœºæ™¯ï¼ˆAccess-Token æ›´æ–°ååŸ POST/PUT é‡è¯•ï¼‰ã€‚  
  * FetchHttpClient å¯¹ `withCredentials` / `credentials` çš„å¤„ç†ï¼ˆå¾…è¡¥å®ç°ï¼‰ã€‚  

---  
## 2. æ–‡æ¡£ä¸ä»£ç è½åœ°å·®å¼‚ & ä¸‹ä¸€æ­¥å»ºè®®

| æ–‡æ¡£æœŸæœ› | å®é™…ä»£ç  | å·®å¼‚ | å»ºè®® |
| --- | --- | --- | --- |
| Storage æœåŠ¡å¯é€‰ Local / Session / Memory | å·²å®ç° | âœ… | â€”â€” |
| HttpClient æ”¯æŒ axios / fetch / mock | å·²å®ç° | âœ… | fetch `withCredentials` å¾…è¡¥ |
| Navigation æ”¯æŒ Browser / History / Mock | å·²å®ç° | âœ… | â€”â€” |
| TokenManager è‡ªåŠ¨åˆ·æ–° & è§£æ | å·²å®ç° | âœ… | `enableDebugLogging` è´¯ç©¿æ‰€æœ‰ç»„ä»¶ |
| AuthInterceptor è®¾è®¡ | ç”± AuthService ç›´æ¥æ³¨å…¥ | âœ… | æœªæ¥å¯å•ç‹¬æŠ½ç¦»ä»¥ä¾¿å¤ç”¨ |
| Factory æä¾› ConfigProvider | ç›®å‰ createAuthService é‡Œåˆå¹¶ DEFAULT_CONFIG+ENV_CONFIG+custom | âš ï¸ ConfigProvider ç±»æœªå•ç‹¬å®ç° | å¦‚éœ€å¤–éƒ¨åŠ¨æ€æ³¨å…¥é…ç½®ï¼ˆè¿è¡Œæ—¶åˆ‡æ¢ç§Ÿæˆ·ç­‰ï¼‰å¯è€ƒè™‘ç‹¬ç«‹ ConfigProvider |
| TODO åˆ—è¡¨ä¸­ã€Œæ›´æ–° hooks/useAuth.tsã€ | ä»£ç åº“æœªå±•ç¤º useAuth Hook | ğŸŸ¡ | ç¡®è®¤å‰ç«¯æ˜¯å¦ä½¿ç”¨æ—§ç‰ˆ AuthService Hookï¼Œè‹¥æ˜¯éœ€åŒ…ä¸€å±‚é€‚é… |
| å•å…ƒæµ‹è¯•è¦†ç›–ç‡ â‰¥ 90% | ç°æœ‰æµ‹è¯•æ•°é‡ä¸°å¯Œï¼Œä½†æœªè§ coverage æŠ¥å‘Š | ğŸŸ¡ | CI æ”¶é›† coverageï¼ŒéªŒè¯é˜ˆå€¼ |
| æ€§èƒ½åŸºå‡†ï¼šç™»å½•<500 ms | æœªæµ‹ | ğŸŸ¡ | E2E + Lighthouse / Web-Vitals ç›‘æµ‹ |
| QuotaExceeded æ¸…ç†ç­–ç•¥ | å·²å®ç° | âœ… | éå…³é”® key è§„åˆ™æˆ–è®¸éœ€è¦äº§å“ä¾§è¯„å®¡ |

### é£é™© & Roadmap

1. **è¯·æ±‚é‡è¯•åªæ”¯æŒ GET** â€“ ä¿®å¤åéœ€è¡¥æµ‹è¯•ã€‚  
2. **è·¨ tab/token å¤±æ•ˆåŒæ­¥** â€“ ç›®å‰ TokenManager ä¸ç›‘å¬ `storage` äº‹ä»¶ï¼›è‹¥å¤šæ ‡ç­¾ç™»å½•éœ€è¦ç™»å‡ºåŒæ­¥ï¼Œå¯åç»­å¢å¼ºã€‚  
3. **Edge Runtime / React-Native å…¼å®¹** â€“ atob / btoaã€window.history ç­‰åœ¨ Edge å‡½æ•°æˆ– RN ä¸­ä¸å¯ç”¨ï¼›å¦‚æœªæ¥ç›®æ ‡å¹³å°æ‰©å……éœ€åšé€‚é…ã€‚  
4. **ç±»å‹æ¼‚ç§»** â€“ IHttpClient åœ¨ä¸åŒå®ç°ä¸­ config shape ä¸ä¸€è‡´ï¼ˆAxiosRequestConfig vs RequestInitï¼‰ï¼›å¯ä»¥å°† IHttpClient è‡ªå®šä¹‰ `RequestConfig` å¹¶ç”±å„å®ç°åšè½¬æ¢ã€‚  

### ä¸‹ä¸€æ­¥ä¼˜å…ˆçº§ï¼ˆå»ºè®®ï¼‰

1. **å®Œå–„ AuthInterceptor é‡è¯•é€»è¾‘** â€“ æ”¯æŒæ‰€æœ‰ HTTP æ–¹æ³•ï¼›æŠŠé‡è¯•å°è£…åˆ°å•ç‹¬ç±»ï¼ŒAuthService åªæ³¨å†Œã€‚  
2. **æŠ½ç¦» ConfigProvider** â€“ å…è®¸è¿è¡Œæ—¶ï¼ˆè€Œéç¼–è¯‘æ—¶ï¼‰æ³¨å…¥/åˆ‡æ¢é…ç½®ï¼Œä¾¿äºå¤šç§Ÿæˆ· SaaSã€‚  
3. **è¦†ç›–ç‡ & CI**  
   - åœ¨ vitest é…ç½® `"coverage":{"provider":"c8","lines":90}` å¹¶åœ¨ pipeline é˜¶æ®µ fail on dropã€‚  
4. **FetchHttpClient `credentials`** â€“ ä¸ axios è¡Œä¸ºå¯¹é½ã€‚  
5. **Storage éå…³é”® key è¿‡æ»¤è§„åˆ™** â€“ æä¾›å¯é…ç½®æ­£åˆ™æˆ–å›è°ƒã€‚  
6. **å¤šæ ‡ç­¾åŒæ­¥ & BroadcastChannel** â€“ æ¸…ç† token æ—¶å¹¿æ’­äº‹ä»¶ï¼Œå‰ç«¯ç›‘å¬æ‰§è¡Œç™»å‡ºã€‚  
7. **æ–‡æ¡£åŒæ­¥** â€“ progress.md æåˆ°â€œæµ‹è¯•å’Œä¼˜åŒ–å¾…å¼€å§‹â€ï¼Œä½†å®é™…ä¸Šå·²æœ‰å¤§é‡æµ‹è¯•ï¼›æ›´æ–°è¿›åº¦ & todo-listã€‚  

---  
### æ€»ç»“

æ•´ä½“çœ‹ï¼Œå›¢é˜Ÿå·²**å®Œæ•´è½åœ°**æ–‡æ¡£ä¸­çš„æ ¸å¿ƒè®¾è®¡ï¼šæ¥å£åˆ†å±‚ã€ä¾èµ–æ³¨å…¥ã€å·¥å‚æ¨¡å¼ã€ä¸°å¯Œçš„ mock & testã€‚ç°å­˜å·®å¼‚ä¸»è¦æ˜¯**ç»†èŠ‚å®Œå–„**å’Œ**æ–‡æ¡£åŒæ­¥**ï¼Œè€Œéé‡å¤§æ¶æ„ç¼ºå¤±ã€‚  
æŒ‰ç…§ä¸Šé¢çš„ã€Œä¸‹ä¸€æ­¥ä¼˜å…ˆçº§ã€é€æ¡å®Œå–„åï¼Œå³å¯è¿›å…¥æ€§èƒ½æµ‹è¯•å’Œæœ€ç»ˆéªŒæ”¶é˜¶æ®µã€‚

---

