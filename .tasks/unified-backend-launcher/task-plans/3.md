# 任务 3 实施计划

生成时间：2025-09-01T23:15:00Z
任务描述：启动器配置模型 - 定义LauncherConfigModel并集成现有配置系统
关联需求：FR-006, NFR-004
预计工时：2.5 小时

## 执行概要

### 目标
定义 `LauncherConfigModel` 配置模型，支持统一后端启动器的配置管理，包含 `default_mode`、`components`、`health_interval`、`api`、`agents` 等核心配置项，并完全复用现有的 TOML 加载器与 pydantic-settings 的多层合并与环境变量覆盖机制。

### 范围
- **包含**：
  - 创建启动器配置模型类 (LauncherConfigModel, LauncherApiConfig, LauncherAgentsConfig)
  - 集成到现有的配置系统 (Settings 类)
  - 支持 TOML 配置文件定义
  - 环境变量覆盖支持
  - 配置验证逻辑
  - 单元测试覆盖

- **不包含**：
  - 启动器业务逻辑实现
  - CLI 命令解析
  - 实际的服务启动功能

### 前置条件
- 任务1 (目录与骨架) 已完成
- 任务2 (配置示例) 已完成
- 熟悉现有配置系统架构

## 技术准备

### 需要的API/库
| 库/模块 | 方法/类 | 用途 | 文档链接 |
|---------|--------|------|---------|
| pydantic | BaseModel, Field, field_validator | 数据模型定义和验证 | https://docs.pydantic.dev/latest/ |
| pydantic_settings | BaseSettings | 配置管理 | https://docs.pydantic.dev/latest/concepts/pydantic_settings/ |
| typing | List, Optional, Literal | 类型注解 | https://docs.python.org/3/library/typing.html |
| enum | Enum | 枚举类型 | https://docs.python.org/3/library/enum.html |

### 代码位置
- **需要创建的文件**：
  - `apps/backend/src/launcher/types.py` - 启动器类型定义
  
- **需要修改的文件**：
  - `apps/backend/src/core/config.py` - 集成LauncherConfigModel到Settings类
  - `apps/backend/config.toml` - 添加[launcher]配置段
  - `apps/backend/tests/unit/core/test_launcher_config.py` - 配置模型测试

## TDD实施步骤

### 步骤1：创建启动器枚举类型
**测试先行（RED）**：
```python
# 测试文件：tests/unit/launcher/test_types.py
from src.launcher.types import LaunchMode, ComponentType

def test_launch_mode_enum():
    """测试启动模式枚举"""
    assert LaunchMode.SINGLE == "single"
    assert LaunchMode.MULTI == "multi"
    assert LaunchMode.AUTO == "auto"

def test_component_type_enum():
    """测试组件类型枚举"""
    assert ComponentType.API == "api"
    assert ComponentType.AGENTS == "agents"

def test_enum_values_are_strings():
    """测试枚举值为字符串类型"""
    assert isinstance(LaunchMode.SINGLE.value, str)
    assert isinstance(ComponentType.API.value, str)
```

**最小实现（GREEN）**：
```python
# 实现文件：src/launcher/types.py
from enum import Enum

class LaunchMode(Enum):
    """启动模式枚举"""
    SINGLE = "single"  # 单进程模式
    MULTI = "multi"    # 多进程模式
    AUTO = "auto"      # 自动推荐模式

class ComponentType(Enum):
    """组件类型枚举"""
    API = "api"        # API Gateway
    AGENTS = "agents"  # AI Agents
```

**重构优化（REFACTOR）**：
- 添加枚举docstring说明
- 确保类型注解完整

### 步骤2：创建配置子模型
**测试先行（RED）**：
```python
# 测试文件：tests/unit/launcher/test_config_models.py
from src.launcher.config import LauncherApiConfig, LauncherAgentsConfig

def test_launcher_api_config_defaults():
    """测试API配置默认值"""
    config = LauncherApiConfig()
    assert config.host == "0.0.0.0"
    assert config.port == 8000
    assert config.reload == False

def test_launcher_api_config_custom_values():
    """测试API配置自定义值"""
    config = LauncherApiConfig(host="127.0.0.1", port=9000, reload=True)
    assert config.host == "127.0.0.1"
    assert config.port == 9000
    assert config.reload == True

def test_launcher_agents_config_defaults():
    """测试Agents配置默认值"""
    config = LauncherAgentsConfig()
    assert config.names is None

def test_launcher_agents_config_with_names():
    """测试Agents配置指定名称"""
    names = ["worldsmith", "plotmaster"]
    config = LauncherAgentsConfig(names=names)
    assert config.names == names
    assert len(config.names) == 2

def test_launcher_agents_config_validation():
    """测试Agents配置验证"""
    # 测试空列表被拒绝
    with pytest.raises(ValueError):
        LauncherAgentsConfig(names=[])
    
    # 测试无效名称被拒绝
    with pytest.raises(ValueError):
        LauncherAgentsConfig(names=["invalid-name-with-special@chars"])
```

**最小实现（GREEN）**：
```python
# 实现文件：src/launcher/config.py
from typing import List, Optional
from pydantic import BaseModel, Field, field_validator
import re

class LauncherApiConfig(BaseModel):
    """启动器API配置"""
    host: str = Field(default="0.0.0.0", description="API服务器绑定地址")
    port: int = Field(default=8000, ge=1024, le=65535, description="API服务器端口")
    reload: bool = Field(default=False, description="开发模式热重载")

class LauncherAgentsConfig(BaseModel):
    """启动器Agents配置"""
    names: Optional[List[str]] = Field(default=None, description="启动的Agent名称列表")
    
    @field_validator('names')
    @classmethod
    def validate_agent_names(cls, v: Optional[List[str]]) -> Optional[List[str]]:
        if v is not None:
            if len(v) == 0:
                raise ValueError("Agent names list cannot be empty")
            
            pattern = re.compile(r'^[a-zA-Z0-9_-]+$')
            for name in v:
                if not pattern.match(name):
                    raise ValueError(f"Invalid agent name: {name}. Must contain only letters, numbers, underscores, and hyphens")
                if len(name) > 50:
                    raise ValueError(f"Agent name too long: {name}. Maximum 50 characters")
        return v
```

**重构优化（REFACTOR）**：
- 提取agent name验证到单独的函数
- 添加更详细的字段描述
- 确保端口范围合理

### 步骤3：创建主配置模型
**测试先行（RED）**：
```python
# 测试文件：tests/unit/launcher/test_launcher_config_model.py
from src.launcher.config import LauncherConfigModel
from src.launcher.types import LaunchMode, ComponentType

def test_launcher_config_model_defaults():
    """测试启动器配置默认值"""
    config = LauncherConfigModel()
    assert config.default_mode == LaunchMode.SINGLE
    assert config.components == [ComponentType.API, ComponentType.AGENTS]
    assert config.health_interval == 1.0
    assert isinstance(config.api, LauncherApiConfig)
    assert isinstance(config.agents, LauncherAgentsConfig)

def test_launcher_config_model_custom_values():
    """测试启动器配置自定义值"""
    config = LauncherConfigModel(
        default_mode=LaunchMode.MULTI,
        components=[ComponentType.API],
        health_interval=0.5
    )
    assert config.default_mode == LaunchMode.MULTI
    assert config.components == [ComponentType.API]
    assert config.health_interval == 0.5

def test_launcher_config_health_interval_validation():
    """测试健康检查间隔验证"""
    # 测试最小值
    with pytest.raises(ValueError):
        LauncherConfigModel(health_interval=0.0)
    
    # 测试最大值
    with pytest.raises(ValueError):
        LauncherConfigModel(health_interval=61.0)
    
    # 测试有效值
    config = LauncherConfigModel(health_interval=5.0)
    assert config.health_interval == 5.0

def test_launcher_config_components_validation():
    """测试组件列表验证"""
    # 测试空组件列表
    with pytest.raises(ValueError):
        LauncherConfigModel(components=[])
    
    # 测试重复组件
    with pytest.raises(ValueError):
        LauncherConfigModel(components=[ComponentType.API, ComponentType.API])

def test_launcher_config_nested_models():
    """测试嵌套配置模型"""
    config = LauncherConfigModel()
    
    # 测试API配置访问
    assert config.api.host == "0.0.0.0"
    assert config.api.port == 8000
    
    # 测试Agents配置访问
    assert config.agents.names is None
```

**最小实现（GREEN）**：
```python
# 继续实现文件：src/launcher/config.py
from .types import LaunchMode, ComponentType

class LauncherConfigModel(BaseModel):
    """启动器主配置模型"""
    default_mode: LaunchMode = Field(default=LaunchMode.SINGLE, description="默认启动模式")
    components: List[ComponentType] = Field(
        default_factory=lambda: [ComponentType.API, ComponentType.AGENTS],
        description="启动的组件列表"
    )
    health_interval: float = Field(
        default=1.0, 
        ge=0.1, 
        le=60.0, 
        description="健康检查间隔（秒）"
    )
    api: LauncherApiConfig = Field(default_factory=LauncherApiConfig, description="API配置")
    agents: LauncherAgentsConfig = Field(default_factory=LauncherAgentsConfig, description="Agents配置")
    
    @field_validator('components')
    @classmethod
    def validate_components(cls, v: List[ComponentType]) -> List[ComponentType]:
        if len(v) == 0:
            raise ValueError("Components list cannot be empty")
        
        # 检查重复组件
        if len(set(v)) != len(v):
            raise ValueError("Duplicate components are not allowed")
        
        return v
```

**重构优化（REFACTOR）**：
- 添加更详细的验证错误消息
- 考虑添加自定义验证器来检查组件间依赖关系

### 步骤4：集成到现有配置系统
**测试先行（RED）**：
```python
# 测试文件：tests/unit/core/test_config_integration.py
from src.core.config import Settings

def test_settings_includes_launcher_config():
    """测试Settings包含启动器配置"""
    settings = Settings()
    assert hasattr(settings, 'launcher')
    assert settings.launcher is not None

def test_launcher_config_from_toml():
    """测试从TOML配置加载启动器配置"""
    # 创建临时配置文件
    toml_content = """
[launcher]
default_mode = "multi"
components = ["api", "agents"]
health_interval = 2.0

[launcher.api]
host = "127.0.0.1"
port = 9000
reload = true

[launcher.agents]
names = ["worldsmith", "plotmaster"]
"""
    
    import tempfile
    import os
    from pathlib import Path
    from src.core.toml_loader import load_toml_config
    
    with tempfile.NamedTemporaryFile(mode='w', suffix='.toml', delete=False) as f:
        f.write(toml_content)
        temp_path = f.name
    
    try:
        config = load_toml_config(temp_path)
        assert 'launcher' in config
        assert config['launcher']['default_mode'] == 'multi'
        assert config['launcher']['api']['host'] == '127.0.0.1'
    finally:
        os.unlink(temp_path)

def test_launcher_config_environment_override():
    """测试环境变量覆盖启动器配置"""
    import os
    
    # 设置环境变量
    os.environ['LAUNCHER__DEFAULT_MODE'] = 'multi'
    os.environ['LAUNCHER__HEALTH_INTERVAL'] = '2.5'
    os.environ['LAUNCHER__API__PORT'] = '9001'
    
    try:
        settings = Settings()
        assert settings.launcher.default_mode.value == 'multi'
        assert settings.launcher.health_interval == 2.5
        assert settings.launcher.api.port == 9001
    finally:
        # 清理环境变量
        os.environ.pop('LAUNCHER__DEFAULT_MODE', None)
        os.environ.pop('LAUNCHER__HEALTH_INTERVAL', None)
        os.environ.pop('LAUNCHER__API__PORT', None)
```

**最小实现（GREEN）**：
```python
# 修改文件：src/core/config.py
from src.launcher.config import LauncherConfigModel

class Settings(BaseSettings):
    """应用主配置
    
    配置优先级（从高到低）：
    1. 环境变量
    2. .env 文件
    3. config.toml 文件（支持环境变量插值）
    4. 默认值
    
    环境变量命名规则：
    - 顶层配置：直接使用变量名（如 NODE_ENV, API_PORT）
    - 嵌套配置：使用双下划线分隔（如 AUTH__JWT_SECRET_KEY, DATABASE__POSTGRES_HOST, LAUNCHER__DEFAULT_MODE）
    
    配置文件位置：
    - TOML 配置：apps/backend/config.toml
    - 环境变量：apps/backend/.env
    """

    # Service identification
    service_name: str = Field(default="infinite-scribe-backend")
    service_type: str = Field(default="api-gateway")
    node_env: str = Field(default="development")

    # ... 其他现有配置 ...

    # 嵌套配置
    auth: AuthSettings = Field(default_factory=AuthSettings)
    database: DatabaseSettings = Field(default_factory=DatabaseSettings)
    launcher: LauncherConfigModel = Field(default_factory=LauncherConfigModel)

    # ... 其他现有内容保持不变 ...
```

**重构优化（REFACTOR）**：
- 更新配置文档说明，包含启动器配置的环境变量规则
- 确保配置加载顺序正确

### 步骤5：更新配置文件示例
**测试先行（RED）**：
```python
# 测试文件：tests/unit/core/test_config_toml_example.py
def test_config_toml_example_has_launcher_section():
    """测试config.toml示例包含launcher配置段"""
    from pathlib import Path
    
    config_file = Path("apps/backend/config.toml")
    if config_file.exists():
        content = config_file.read_text()
        assert "[launcher]" in content
        assert "default_mode" in content
        assert "[launcher.api]" in content
        assert "[launcher.agents]" in content

def test_config_toml_example_loads_correctly():
    """测试config.toml示例可以正确加载"""
    from src.core.toml_loader import load_toml_config
    from pathlib import Path
    
    config_file = Path("apps/backend/config.toml")
    if config_file.exists():
        config = load_toml_config(config_file)
        if 'launcher' in config:
            assert 'default_mode' in config['launcher']
            assert 'components' in config['launcher']
```

**最小实现（GREEN）**：
```toml
# 修改文件：apps/backend/config.toml
# ... 现有配置保持不变 ...

[launcher]
default_mode = "${LAUNCHER__DEFAULT_MODE:-single}"
components = ["api", "agents"]
health_interval = "${LAUNCHER__HEALTH_INTERVAL:-1.0}"

[launcher.api]
host = "${LAUNCHER__API__HOST:-0.0.0.0}"
port = "${LAUNCHER__API__PORT:-8000}"
reload = "${LAUNCHER__API__RELOAD:-false}"

[launcher.agents]
names = ["${LAUNCHER__AGENTS__NAMES:-}"]
```

**重构优化（REFACTOR）**：
- 为数组类型环境变量添加更好的支持
- 添加配置注释说明各字段用途

## 边界情况处理

### 错误场景
1. **无效的启动模式值**
   - 触发条件：配置文件或环境变量包含不支持的启动模式
   - 处理方式：抛出验证错误，提供有效选项列表
   - 测试用例：`test_invalid_launch_mode_validation()`

2. **健康检查间隔超出范围**
   - 触发条件：health_interval小于0.1或大于60.0
   - 处理方式：抛出验证错误，说明有效范围
   - 测试用例：`test_health_interval_boundary_validation()`

3. **API端口冲突**
   - 触发条件：配置的端口已被系统占用或在保留范围内
   - 处理方式：验证端口范围（1024-65535）
   - 测试用例：`test_api_port_range_validation()`

4. **Agent名称格式错误**
   - 触发条件：Agent名称包含非法字符或为空
   - 处理方式：正则表达式验证，提供格式要求
   - 测试用例：`test_agent_name_format_validation()`

### 性能考虑
- 配置模型实例化时间应小于10ms
- 环境变量插值处理时间应小于5ms
- 内存占用应控制在合理范围内

## 验收标准

### 功能验收
- [ ] LauncherConfigModel正确定义了所有必需字段
- [ ] 配置模型集成到Settings类中
- [ ] 支持TOML配置文件定义
- [ ] 支持环境变量覆盖
- [ ] 配置验证逻辑正确工作
- [ ] 嵌套配置模型正确实现

### 技术验收
- [ ] 所有测试通过
- [ ] 代码覆盖率 > 90%
- [ ] 无 linting 错误
- [ ] 类型注解完整且正确
- [ ] 配置加载性能满足要求

### 集成验收
- [ ] 与现有配置系统无缝集成
- [ ] 不破坏现有配置功能
- [ ] 环境变量命名遵循现有规则
- [ ] TOML配置格式与现有模式一致

## 风险与缓解

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| 配置模型验证逻辑过于严格 | 中 | 中 | 添加详细的验证错误消息，提供修正建议 |
| 环境变量命名冲突 | 低 | 高 | 使用LAUNCHER__前缀，遵循现有命名约定 |
| 性能影响 | 低 | 中 | 配置缓存，避免重复加载 |
| TOML配置格式不兼容 | 低 | 中 | 严格遵循现有TOML格式模式 |

## 实施检查清单

### 开始前
- [ ] 确认任务1、2已完成
- [ ] 理解现有配置系统架构
- [ ] 准备测试环境

### 实施中
- [ ] 遵循TDD流程：测试 → 实现 → 重构
- [ ] 每个步骤后运行完整测试套件
- [ ] 确保类型注解完整
- [ ] 及时提交代码变更

### 完成后
- [ ] 运行完整测试套件确保无回归
- [ ] 使用code-review-expert进行代码审查
- [ ] 验证配置加载功能正常工作
- [ ] 更新相关文档

## 时间估算

| 阶段 | 预计时间 |
|------|----------|
| 技术准备与设计 | 30分钟 |
| 步骤1：枚举类型 | 30分钟 |
| 步骤2：配置子模型 | 45分钟 |
| 步骤3：主配置模型 | 45分钟 |
| 步骤4：配置系统集成 | 30分钟 |
| 步骤5：配置文件更新 | 15分钟 |
| 测试完善与边界情况 | 30分钟 |
| 代码审查与优化 | 15分钟 |
| **总计** | 2.5小时 |

## 审批状态

- [ ] 计划已审阅
- [ ] 技术方案已确认
- [ ] 准备开始实施

---
*此文档由 spec-task:impl-task-plan 生成，作为任务3实施的详细指导*