# 任务 4 实施计划（修订版，对齐现状）

生成时间：2025-09-02T05:30:00Z
任务描述：CLI（最小集）- is-launcher 命令行接口（与现有实现对齐与完善）
关联需求：FR-001, FR-002, NFR-003
预计工时：1.5 小时

## 执行概要

### 目标
实现统一后端启动器的 CLI 接口（与当前函数式 `main()` 实现保持一致），提供 `up`、`down`、`status`、`logs` 四个核心命令，支持模式选择（含 `auto`）、组件过滤（CSV/JSON）、Agent 过滤（CSV/JSON）与基础操作参数；默认值从 `Settings().launcher` 读取。

### 范围
- 包含：
  - `is-launcher up`（`--mode {single,multi,auto}`、`--components` CSV/JSON、`--agents` CSV/JSON、`--reload` 接受但暂不覆盖配置）
  - `is-launcher down`（`--grace <seconds>` 优雅停止）
  - `is-launcher status`（`--watch` 持续监控开关）
  - `is-launcher logs`（`component` ∈ `{api,agents,all}`）
  - argparse 解析与参数校验（含 `choices` 与错误码）
  - 默认值来源统一为 `Settings().launcher.*`（CLI 层默认 `None` 再解析）
  - 错误输出写入 `stderr`，退出码策略明确
  - 性能约束与测试指导（NFR-003：解析路径轻量，冷启动帮助 <100ms，CI 可跳过性能用例）

- 不包含：
  - 交互式增强特性（rich 输出、prompt 等）
  - 配置模板系统（FR-006，后续任务）
  - 智能模式推荐（FR-007，后续任务）
  - 实际的服务启动逻辑（Task 5：适配器层 Orchestrator/Adapters）

### 前置条件
- Task 1（目录与骨架）已完成
- Task 3（启动器配置模型）已完成
- `apps/backend/src/launcher/cli.py` 已存在，采用函数式 `main()` 实现
- `LauncherConfigModel` 可用；`types.py` 中的枚举定义可用（`LaunchMode` 含 `AUTO`，`ComponentType` 含 `API/AGENTS`）

## 技术准备

### 需要的 API/库（对齐代码）
| 库/模块 | 方法/类 | 用途 | 文档链接 |
|---------|--------|------|---------|
| argparse | ArgumentParser, add_subparsers | CLI 核心解析 | https://docs.python.org/3/library/argparse.html |
| sys | exit, stderr | 退出码与错误输出 | https://docs.python.org/3/library/sys.html |
| json | loads | 列表参数（JSON/CSV）解析 | https://docs.python.org/3/library/json.html |
| pydantic | ValidationError | 参数验证错误处理 | https://docs.pydantic.dev/latest/ |
| src.core.config | Settings | 默认值来源（`launcher` 配置） | 内部模块 |
| launcher.types | LaunchMode, ComponentType | 类型枚举（包含 `auto`/`all` 对齐） | 内部模块 |
| launcher.config | LauncherAgentsConfig | 复用 agents 校验 | 内部模块 |

### 代码位置
当前代码已具备基础实现与入口：
- `apps/backend/src/launcher/cli.py`（已存在，函数式 `main()`）
- `apps/backend/pyproject.toml` 中已注册脚本入口：`is-launcher = "src.launcher.cli:main"`
- `apps/backend/src/launcher/__init__.py` 已导出版本与类型

本任务以“对齐与完善”为主，不新增文件；如需小幅调整仅更新上述现有文件。

## TDD 实施步骤（更新为函数式与子进程校验）

### 步骤 1：入口与帮助
测试先行（RED）：
```python
# 测试文件：apps/backend/tests/unit/launcher/test_cli_basic.py
import subprocess, sys

def test_cli_help_command():
    # 通过模块入口检查 --help 可用且退出码为 0
    result = subprocess.run([sys.executable, "-m", "src.launcher.cli", "--help"], capture_output=True, text=True)
    assert result.returncode == 0
    assert "launcher" in (result.stdout.lower() + result.stderr.lower())
```

实现现状（GREEN）：已满足。

### 步骤 2：`up` 参数（mode/components/agents/reload）
测试先行（RED）：
```python
# 测试文件：apps/backend/tests/unit/launcher/test_cli_up.py
import subprocess, sys, json, re

def _run_cli(*args: str):
    return subprocess.run([sys.executable, "-m", "src.launcher.cli", *args], capture_output=True, text=True)

def test_up_mode_supports_single_multi_auto():
    for mode in ("single", "multi", "auto"):
        r = _run_cli("up", "--mode", mode, "--components", "api", "--agents", "[]")
        assert r.returncode == 0, r.stderr
        assert f"mode={mode}" in r.stdout

def test_up_components_accepts_csv_and_json():
    r1 = _run_cli("up", "--components", "api,agents", "--agents", "[]")
    assert r1.returncode == 0
    assert "components=[api,agents]" in r1.stdout.replace(" ", "")

    r2 = _run_cli("up", "--components", json.dumps(["api", "agents"]), "--agents", "[]")
    assert r2.returncode == 0
    assert "components=[api,agents]" in r2.stdout.replace(" ", "")

def test_up_agents_accepts_csv_and_json():
    r1 = _run_cli("up", "--components", "api", "--agents", "writer,editor")
    assert r1.returncode == 0
    assert re.search(r"agents=(writer,editor|editor,writer)", r1.stdout)

    r2 = _run_cli("up", "--components", "api", "--agents", json.dumps(["writer", "editor"]))
    assert r2.returncode == 0
    assert re.search(r"agents=(writer,editor|editor,writer)", r2.stdout)

def test_up_reload_flag_is_accepted():
    # 目前实现接受 --reload，不报错；实际覆写行为留待适配器层
    r = _run_cli("up", "--components", "api", "--agents", "[]", "--reload")
    assert r.returncode == 0
```

实现对齐说明（GREEN）：
- `--mode` 支持 `single|multi|auto`（默认从配置读取）
- `--components`/`--agents` 支持 CSV 或 JSON 数组；默认 `None`，在处理阶段回落到 `Settings().launcher.*`
- 错误（无效 component/agent 名称、JSON 解析失败）产生明确消息并以退出码 `2` 结束
- `--reload` 已接受但当前输出仍显示 `base.api.reload`（覆盖行为留待后续适配器集成）

### 步骤 3：`down` 参数解析
测试先行（RED）：
```python
# 测试文件：apps/backend/tests/unit/launcher/test_cli_down.py
import subprocess, sys

def test_down_grace_parameter():
    r = subprocess.run([sys.executable, "-m", "src.launcher.cli", "down", "--grace", "15"], capture_output=True, text=True)
    assert r.returncode == 0

def test_down_default_grace():
    r = subprocess.run([sys.executable, "-m", "src.launcher.cli", "down"], capture_output=True, text=True)
    assert r.returncode == 0
```

实现现状（GREEN）：已满足，默认 `--grace=10`。

### 步骤 4：`status` 与 `logs`
测试先行（RED）：
```python
# 测试文件：apps/backend/tests/unit/launcher/test_cli_misc.py
import subprocess, sys

def _run(*args: str):
    return subprocess.run([sys.executable, "-m", "src.launcher.cli", *args], capture_output=True, text=True)

def test_status_watch_flag():
    assert _run("status").returncode == 0
    assert _run("status", "--watch").returncode == 0

def test_logs_component_choices():
    for comp in ("api", "agents", "all"):
        assert _run("logs", comp).returncode == 0
```

实现现状（GREEN）：已满足，`logs` 允许 `api|agents|all`。

### 步骤 5：错误处理、无命令与退出码
测试先行（RED）：
```python
# 测试文件：apps/backend/tests/unit/launcher/test_cli_errors.py
import subprocess, sys, json

def _run(*args: str):
    return subprocess.run([sys.executable, "-m", "src.launcher.cli", *args], capture_output=True, text=True)

def test_invalid_mode_exits_with_code_2():
    r = _run("up", "--mode", "invalid", "--components", "api", "--agents", "[]")
    assert r.returncode == 2

def test_invalid_components_value_exits_with_code_2():
    r = _run("up", "--components", json.dumps(["invalid"]), "--agents", "[]")
    assert r.returncode == 2

def test_invalid_logs_choice_exits_with_code_2():
    r = _run("logs", "invalid")
    assert r.returncode == 2

def test_no_command_prints_help_and_exit_0():
    r = _run()
    assert r.returncode == 0
    assert "usage" in r.stdout.lower() or "usage" in r.stderr.lower()
```

实现现状（GREEN）：已实现按子命令分支派发；错误输出写入 `stderr`；非法参数使用 `choices` 或校验后 `sys.exit(2)`。

### 步骤 6：控制台脚本与 E2E 校验
测试先行（RED）：
```python
# 测试文件：apps/backend/tests/unit/launcher/test_cli_entrypoint.py
import tomllib, os, subprocess, sys

def test_pyproject_entry_point_registered():
    with open("pyproject.toml", "rb") as f:
        config = tomllib.load(f)
    assert config["project"]["scripts"]["is-launcher"] == "src.launcher.cli:main"

def test_is_launcher_help_integration_optional():
    if os.environ.get("TESTING_CLI_INTEGRATION"):
        r = subprocess.run(["is-launcher", "--help"], capture_output=True, text=True)
        assert r.returncode == 0
```

实现现状（GREEN）：入口已在 `apps/backend/pyproject.toml` 正确注册为 `src.launcher.cli:main`。

## 退出码与日志策略（新增）

- 成功：退出码 `0`
- 用法错误（参数无效/choices 不匹配/JSON 解析失败）：退出码 `2`（遵循 argparse 惯例）
- 运行时异常（与解析无关）：退出码 `1`（打印友好错误到 `stderr`）
- 错误输出一律写入 `stderr`；信息/计划预览写入 `stdout`

## 边界情况处理

### 错误场景
1. 无效参数组合
   - 触发条件：`--components` 包含未知组件名（或 JSON 列表有未知项）
   - 处理方式：自定义校验后提示并 `sys.exit(2)`（`stderr` 打印错误信息）
   - 测试用例：`test_invalid_components_value_exits_with_code_2`

2. 空参数列表
   - 触发条件：用户不提供任何命令
   - 处理方式：显示帮助信息并退出（`0`）
   - 测试用例：`test_no_command_prints_help_and_exit_0`

3. 解析异常
   - 触发条件：JSON 解析失败、类型不匹配
   - 处理方式：捕获异常，显示友好错误信息，退出码 `2`
   - 测试用例：`test_invalid_components_value_exits_with_code_2`

### 性能考虑（NFR-003 对齐实践）
- 解析路径轻量：不要在 CLI 模块顶层或解析阶段导入/初始化重型依赖（DB、网络客户端等）
- 默认值解析走 `Settings().launcher`，避免昂贵 I/O（当前 TOML 解析较轻量）
- 性能检测建议：
  - 本地可用 `time.perf_counter()` 统计 `python -m src.launcher.cli --help` 冷启动耗时，目标 <100ms（开发机参考值）
  - 在 CI 中将性能用例标记为 `perf` 并默认跳过，避免抖动导致偶发失败

## 验收标准

### 功能验收
- [ ] `is-launcher up --mode single|multi|auto --components api,agents --agents writer,editor --reload` 正常执行并输出计划
- [ ] `is-launcher up --components ["api","agents"] --agents ["writer","editor"]` 正常执行
- [ ] `is-launcher down --grace 15` 正常执行
- [ ] `is-launcher status --watch` 正常执行
- [ ] `is-launcher logs api|agents|all` 正常执行
- [ ] 无效参数产生清晰错误并退出码为 `2`
- [ ] 无命令时显示帮助且退出码为 `0`

### 技术验收
- [ ] 所有相关测试通过（单元 + 轻量 E2E）
- [ ] 关键分支覆盖（参数校验/错误路径）；覆盖率以仓库默认为准（不强制 >90%）
- [ ] 无 linting 错误（ruff/mypy/pyright）
- [ ] 冷启动帮助耗时在开发环境 <100ms（CI 可跳过）

### 集成验收
- [ ] `pyproject.toml` 正确注册 `[project.scripts].is-launcher = "src.launcher.cli:main"`
- [ ] CLI 可通过 `python -m src.launcher.cli` 与 `is-launcher` 调用
- [ ] 参数结构与 `Settings().launcher` 兼容，便于后续适配器层集成

## 风险与缓解（更新）

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| argparse 复杂参数解析性能 | 低 | 中 | 避免重型导入；仅在必要时做轻量校验 |
| 参数组合验证复杂度 | 中 | 低 | 使用 `choices` + 轻量自定义校验，错误码 `2` |
| CLI API 变更影响兼容性 | 低 | 高 | 严格版本化，文档与测试同步更新 |
| 控制台脚本注册失败 | 低 | 高 | 单测校验入口；必要时 `pip install -e .` 验证 |

## 实施检查清单（对齐版）

### 开始前
- [ ] 确认 Task 1、Task 3 前置任务完成
- [ ] 确认 `LaunchMode`/`ComponentType`/`LauncherConfigModel` 可用
- [ ] 明确入口 `src.launcher.cli:main` 与测试路径风格（`apps/backend/tests/...`）

### 实施中
- [ ] 按步骤补齐/调整测试（以子进程调用为主）
- [ ] 对齐参数选项与默认值来源（配置优先）
- [ ] 错误输出走 `stderr`，退出码遵循约定
- [ ] 性能用例标记 `perf`，CI 跳过

### 完成后
- [ ] 运行完整测试套件（含 `python -m src.launcher.cli`）
- [ ] 验证 `is-launcher` 命令可用（可选）
- [ ] 复核参数组合与错误路径
- [ ] 在文档中补充常见用法示例

## 时间估算（对齐版）

| 阶段 | 预计时间 |
|------|----------|
| 技术准备与对齐 | 15 分钟 |
| 步骤1：入口与帮助 | 10 分钟 |
| 步骤2：up 参数用例 | 25 分钟 |
| 步骤3：down 参数用例 | 10 分钟 |
| 步骤4：status/logs 用例 | 15 分钟 |
| 步骤5：错误与退出码用例 | 15 分钟 |
| 步骤6：入口脚本与可执行验证 | 10 分钟 |
| 文档与性能说明完善 | 10 分钟 |
| **总计** | **1.5 小时** |

## 审批状态

- [ ] 计划已审阅
- [ ] 技术方案已确认  
- [ ] 准备开始实施

---
*此文档为修订版：对齐当前仓库实现（函数式 main）、参数选项与测试风格，并补充退出码与性能策略，用作 Task 4 实施与回归基线*

