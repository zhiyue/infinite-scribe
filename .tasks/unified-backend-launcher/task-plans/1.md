# 任务 1 实施计划

生成时间：2025-09-01T23:00:00Z
任务描述：创建 launcher 模块的目录结构与骨架文件
关联需求：FR-001（统一管理）；关联决策：ADR-005（CLI 架构）
预计工时：1.5 小时

## 执行概要

### 目标
创建统一后端启动器的基础目录结构和核心模块骨架文件，建立项目基础架构

### 范围
- **包含**：
  - 创建 launcher 模块目录结构
  - 创建所有核心模块的骨架文件
  - 在 pyproject.toml 注册 CLI 入口点
  - 创建最小单元测试文件（结构与模块存在性）
  
- **不包含**：
  - 具体功能实现
  - 配置文件内容

### 前置条件
- 后端项目结构已存在（apps/backend/）
- pyproject.toml 文件已存在且可修改

## 技术准备

### 需要的API/库
| 库/模块 | 方法/类 | 用途 | 说明 |
|---------|--------|------|------|
| pathlib | Path | 创建目录结构 | Python 标准库 |
| tomllib | load | 读取 pyproject.toml（只读） | Python 标准库（3.11+）|
| 文本编辑 | — | 写入 pyproject.toml（添加 [project.scripts]） | 采用文本补丁/手动编辑，避免引入额外依赖 |

### 代码位置
- **需要创建的文件**：
  - `apps/backend/src/launcher/__init__.py` - 模块初始化
  - `apps/backend/src/launcher/cli.py` - CLI入口点
  - `apps/backend/src/launcher/orchestrator.py` - 服务编排器
  - `apps/backend/src/launcher/adapters/__init__.py` - 适配器模块初始化
  - `apps/backend/src/launcher/adapters/api.py` - API适配器
  - `apps/backend/src/launcher/adapters/agents.py` - Agents适配器
  - `apps/backend/src/launcher/health.py` - 健康检查模块
  - `apps/backend/src/launcher/types.py` - 类型定义
  - `apps/backend/src/launcher/errors.py` - 错误定义
  
- **需要修改的文件**：
  - `apps/backend/pyproject.toml` - 添加console_scripts入口点

## TDD实施步骤

### 步骤1：创建目录结构
**测试先行（RED）**：
```python
# 测试文件：apps/backend/tests/unit/launcher/test_structure.py
from pathlib import Path

def test_launcher_directory_exists():
    """测试launcher目录结构是否存在"""
    launcher_path = Path("src/launcher")
    assert launcher_path.exists()
    assert launcher_path.is_dir()

    # 检查子目录
    adapters_path = launcher_path / "adapters"
    assert adapters_path.exists()
    assert adapters_path.is_dir()
```

**最小实现（GREEN）**：
```bash
# 创建目录结构
mkdir -p apps/backend/src/launcher/adapters
```

**重构优化（REFACTOR）**：
- 使用Python脚本批量创建以保持一致性
- 添加目录创建日志

### 步骤2：创建核心模块文件
**测试先行（RED）**：
```python
# 测试文件：apps/backend/tests/unit/launcher/test_modules.py
from pathlib import Path

def test_core_modules_exist():
    """测试核心模块文件是否存在"""
    launcher_path = Path("src/launcher")

    required_files = [
        "__init__.py",
        "cli.py",
        "orchestrator.py",
        "health.py",
        "types.py",
        "errors.py",
    ]

    for file_name in required_files:
        file_path = launcher_path / file_name
        assert file_path.exists(), f"Missing file: {file_name}"
        assert file_path.is_file()
```

**最小实现（GREEN）**：
```python
# 创建骨架文件
# __init__.py
"""Unified Backend Launcher Module"""
__version__ = "0.1.0"

# cli.py
"""CLI entry point for the launcher"""
import argparse

def main():
    """Main entry point for is-launcher command"""
    parser = argparse.ArgumentParser(prog="is-launcher", description="Unified Backend Launcher")
    sub = parser.add_subparsers(dest="command")
    sub.add_parser("up")
    sub.add_parser("down")
    sub.add_parser("status")
    parser.parse_args()

# orchestrator.py
"""Service orchestration logic"""
class Orchestrator:
    """Service orchestrator for managing backend components"""
    pass

# health.py
"""Health monitoring and checking"""
class HealthMonitor:
    """Monitor health of launched services"""
    pass

# types.py
"""Type definitions for launcher module"""
from typing import TypedDict

# errors.py
"""Custom exceptions for launcher module"""
class LauncherError(Exception):
    """Base exception for launcher errors"""
    pass
```

**重构优化（REFACTOR）**：
- 添加类型提示
- 添加docstrings
- 统一代码风格

### 步骤3：创建适配器模块
**测试先行（RED）**：
```python
def test_adapter_modules_exist():
    """测试适配器模块文件是否存在"""
    adapters_path = Path("apps/backend/src/launcher/adapters")
    
    required_files = ["__init__.py", "api.py", "agents.py"]
    
    for file_name in required_files:
        file_path = adapters_path / file_name
        assert file_path.exists()
```

**最小实现（GREEN）**：
```python
# adapters/__init__.py
"""Service adapters for launcher"""

# adapters/api.py
"""API service adapter"""
class ApiAdapter:
    """Adapter for managing API Gateway service"""
    pass

# adapters/agents.py  
"""Agents service adapter"""
class AgentsAdapter:
    """Adapter for managing AI agents"""
    pass
```

### 步骤4：注册CLI入口点
**测试先行（RED）**：
```python
def test_cli_entry_point_registered():
    """测试CLI入口点是否在pyproject.toml中注册"""
    import tomllib

    with open("apps/backend/pyproject.toml", "rb") as f:
        config = tomllib.load(f)

    assert "project" in config
    assert "scripts" in config["project"]
    assert config["project"]["scripts"].get("is-launcher") == "src.launcher.cli:main"
```

**最小实现（GREEN）**：
```toml
# 在 pyproject.toml 中添加
[project.scripts]
is-launcher = "src.launcher.cli:main"
```

## 边界情况处理

### 错误场景
1. **目录已存在**
   - 触发条件：launcher目录已存在
   - 处理方式：检查现有文件，仅创建缺失的文件
   - 测试用例：test_idempotent_creation

2. **权限不足**
   - 触发条件：无法在目标位置创建文件
   - 处理方式：提供清晰的错误信息和解决方案
   - 测试用例：test_permission_error_handling

### 性能考虑
- 文件创建操作很快，性能不是主要考虑因素
- 使用批处理减少I/O操作次数

## 验收标准

### 功能验收
- [x] launcher目录结构完整创建
- [x] 所有骨架文件包含基本结构
- [x] pyproject.toml包含正确的入口点配置
- [x] 所有文件包含适当的docstrings

### 技术验收
- [x] 所有测试通过
- [x] 代码遵循项目的Python风格指南
- [x] 无linting错误
- [x] 文件权限设置正确

### 集成验收
- [x] 可以通过 `is-launcher --help` 访问CLI
- [x] 模块可以被正确导入
- [x] 为后续任务提供必要的基础结构

## 风险与缓解

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| 与现有代码冲突 | 低 | 中 | 先检查现有结构，避免覆盖 |
| 导入路径问题 | 中 | 低 | 使用相对导入，测试导入路径 |
| pyproject.toml格式错误 | 低 | 高 | 备份原文件，使用toml库验证 |

## 实施检查清单

### 开始前
- [x] 确认apps/backend/src目录存在
- [x] 备份pyproject.toml
- [x] 检查是否有现存的launcher目录

### 实施中
- [x] 创建目录结构
- [x] 创建所有骨架文件
- [x] 更新pyproject.toml
- [x] 运行测试验证

### 完成后
- [x] 运行 `python -m src.launcher.cli --help` 验证
- [x] 检查所有文件权限
- [x] 提交代码到版本控制
- [x] 更新任务状态

## 时间估算

| 阶段 | 预计时间 |
|------|----------|
| 技术准备 | 10分钟 |
| 创建目录结构 | 15分钟 |
| 创建骨架文件 | 30分钟 |
| 注册CLI入口点 | 15分钟 |
| 测试验证 | 15分钟 |
| 代码优化 | 5分钟 |
| **总计** | 1.5小时 |

## 实施命令序列

```bash
# 1. 创建目录结构
mkdir -p apps/backend/src/launcher/adapters

# 2. 创建骨架文件
touch apps/backend/src/launcher/__init__.py
touch apps/backend/src/launcher/cli.py
touch apps/backend/src/launcher/orchestrator.py
touch apps/backend/src/launcher/health.py
touch apps/backend/src/launcher/types.py
touch apps/backend/src/launcher/errors.py
touch apps/backend/src/launcher/adapters/__init__.py
touch apps/backend/src/launcher/adapters/api.py
touch apps/backend/src/launcher/adapters/agents.py

# 3. 验证结构
find apps/backend/src/launcher -maxdepth 2 -type f -print

# 4. 更新pyproject.toml
# 手动或通过脚本添加console_scripts

# 5. 测试入口点（在 backend 目录内执行）
cd apps/backend
uv run python -m src.launcher.cli --help
```

## 审批状态

- [x] 计划已审阅
- [x] 技术方案已确认
- [x] 准备开始实施

---
*此文档由 spec-task:impl-task-plan 生成，作为任务1实施的详细指导*
