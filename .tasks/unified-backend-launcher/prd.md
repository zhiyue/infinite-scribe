# 产品需求文档（PRD）- 统一后端启动器

## 项目描述（用户输入）

我现在打算统一后端运行的命令，比如 api-gateway, kafka 消费者，多个agent等，默认全部运行，增加可选参数只运行特定的功能，这样方便开发和测试

## 1. 背景与机会

### 问题陈述

当前 InfiniteScribe 后端服务启动过程存在以下问题：

1. **启动流程复杂**：开发人员需要分别启动多个服务（API Gateway、多个AI Agent、Kafka消费者等），流程繁琐且容易遗漏
2. **开发环境不一致**：不同开发人员可能启动不同的服务组合，导致环境差异和调试困难
3. **测试场景切换困难**：针对不同功能进行测试时，需要手动停止和启动特定服务，效率低下
4. **认知负担重**：新开发人员需要学习多个启动脚本和命令，增加上手难度
5. **服务依赖关系不透明**：缺乏统一的服务编排，开发人员不清楚服务间的启动顺序和依赖关系

### 市场机会

统一的后端启动器将为团队带来：

- **开发效率提升**：一键启动所有服务，减少环境配置时间
- **团队协作改善**：标准化的开发环境，减少"在我机器上能跑"的问题
- **测试效率优化**：快速切换测试场景，提高测试覆盖率和质量
- **新人培训简化**：降低新开发人员的学习成本和环境搭建难度
- **架构灵活性**：支持单进程和多进程两种运行模式，开发者可根据场景选择最优方案

## 2. 目标与非目标

### 业务目标（Business Goals）

- **提升开发体验**：将后端服务启动时间从3-5分钟减少到30秒内
- **标准化开发环境**：确保所有开发人员使用一致的服务配置和启动流程
- **提高测试效率**：支持快速切换不同的服务组合以适应不同测试场景
- **降低维护成本**：统一服务管理，减少脚本维护和文档更新工作量

### 非目标（Non-Goals）

- 不涉及服务的部署和生产环境配置
- 不改变现有服务的内部架构和接口
- 不包括前端服务的启动管理
- 不涉及服务监控和日志聚合功能

## 3. 用户画像与关键场景

### 目标用户

- **主要用户**：InfiniteScribe 后端开发人员（Python/FastAPI开发者）
- **次要用户**：全栈开发人员、QA测试人员、DevOps工程师

### 关键使用场景

1. **日常开发场景**：开发人员每天开始工作时需要快速启动完整的本地开发环境
2. **功能测试场景**：开发人员需要只启动特定服务组合来测试某个功能模块
3. **调试场景**：开发人员需要排除某些服务来隔离问题和进行调试
4. **演示场景**：需要快速启动完整环境进行功能演示或代码审查

## 4. 功能范围

### 本期范围（In Scope）

- **统一启动命令**：提供单一命令启动所有后端服务
- **灵活运行模式**：支持单进程模式（开发推荐）和多进程模式（生产兼容）
- **选择性启动**：支持通过参数只启动指定的服务或服务组合
- **服务状态管理**：显示各服务的启动状态和健康状况
- **优雅停止**：支持统一停止所有服务或指定服务
- **配置管理**：统一管理各服务的启动参数和环境变量
- **开发模式支持**：支持开发模式的热重载和调试功能

### 不在范围（Out of Scope）

- 生产环境的服务编排和部署
- 服务间通信和网关路由配置
- 数据库迁移和初始化管理
- 日志聚合和监控告警功能
- 容器化和Docker Compose集成

## 5. 用户故事

### STORY-001: 灵活的统一启动

**作为**后端开发人员，**我想要**通过一个命令选择单进程或多进程模式启动所有必要的后端服务，**以便**根据开发场景选择最优的运行方式。

**高层验收标准：**

- 支持 `--mode=single` 在单进程中运行所有服务（开发推荐）
- 支持 `--mode=multi` 分别启动各个服务进程（生产兼容，默认）
- 单进程模式下所有服务共享FastAPI实例，统一端口访问
- 多进程模式保持服务隔离，独立端口和进程
- 启动过程显示清晰的进度、模式和状态信息
- 启动失败时有明确的错误提示和建议

**优先级：** P1

### STORY-002: 选择性服务启动

**作为**开发人员，**我想要**只启动特定的服务组合，**以便**针对特定功能进行开发和测试而不占用不必要的系统资源。

**高层验收标准：**

- 支持通过命令行参数指定要启动的服务类型（如只启动API Gateway和特定Agent）
- 支持预定义的服务组合（如"最小开发环境"、"完整测试环境"）
- 未启动的服务不会影响已启动服务的正常运行
- 提供服务依赖检查，确保依赖服务优先启动

**优先级：** P1

### STORY-003: 实时状态监控

**当**我启动后端服务时，**我想要**实时看到各个服务的启动状态和健康情况，**从而**及时发现并解决启动过程中的问题。

**高层验收标准：**

- 实时显示各服务的启动状态（启动中、已启动、启动失败）
- 显示各服务的健康检查结果和响应时间
- 启动失败的服务有详细的错误信息和日志位置提示
- 支持查看单个服务的详细状态和日志

**优先级：** P2

### STORY-004: 优雅停止管理

**作为**开发人员，**我想要**能够优雅地停止所有或特定的后端服务，**以便**安全地结束开发会话或释放系统资源。

**高层验收标准：**

- 支持一键停止所有通过启动器启动的服务
- 支持选择性停止特定服务而不影响其他服务
- 停止过程显示进度并等待服务优雅关闭
- 强制停止选项用于处理无响应的服务

**优先级：** P2

### STORY-005: 开发模式支持

**作为**开发人员，**我想要**在开发模式下启动服务时自动启用热重载和调试功能，**以便**提高开发效率并简化调试过程。

**高层验收标准：**

- 自动检测开发环境并启用相应的开发模式配置
- 支持代码变更时的自动重启和热重载
- 提供详细的调试日志输出
- 支持调试端口暴露和IDE集成

**优先级：** P3

### STORY-006: 配置模板管理

**当**我需要为不同的开发场景配置服务启动参数时，**我想要**使用预定义的配置模板，**从而**快速切换不同的开发和测试环境配置。

**高层验收标准：**

- 提供常用场景的配置模板（如最小开发、完整测试、调试模式等）
- 支持自定义配置模板的创建和保存
- 配置模板包括服务组合、环境变量和启动参数
- 支持配置模板的导入导出和团队共享

**优先级：** P3

### STORY-007: 进程模式优化

**当**我在不同的开发场景下工作时，**我想要**系统自动推荐最适合的运行模式，**从而**获得最佳的开发体验和资源利用率。

**高层验收标准：**

- 本地开发时默认推荐单进程模式（资源高效、调试便利）
- 集成测试时推荐多进程模式（隔离性好、真实环境）
- 提供模式切换的性能和影响提示
- 支持保存用户的模式偏好设置
- 单进程模式下提供组件级别的健康检查和日志分离

**优先级：** P2

## 6. 里程碑与发布计划

### 里程碑 1：核心启动功能（MVP）

- **目标日期**：2周后
- **包含功能**：STORY-001, STORY-002
- **成功标准**：
  - 可通过单一命令启动所有后端服务
  - 支持选择性服务启动
  - 启动成功率达到95%以上
  - 启动时间控制在30秒内

### 里程碑 2：状态管理和运行模式优化

- **目标日期**：4周后
- **包含功能**：STORY-003, STORY-004, STORY-007
- **成功标准**：
  - 实时状态显示功能完整可用
  - 优雅停止功能零数据丢失
  - 单进程模式稳定可用，资源开销降低30%
  - 用户满意度达到4.5/5以上

### 里程碑 3：高级功能和配置管理

- **目标日期**：6周后
- **包含功能**：STORY-005, STORY-006
- **成功标准**：
  - 开发模式热重载功能稳定可用
  - 配置模板系统完整实现
  - 支持单进程和多进程模式的无缝切换
  - 新开发人员上手时间减少50%

## 7. 风险与权衡

### 关键风险

1. **风险**：现有服务的启动依赖关系复杂，可能导致统一启动失败
   - **影响**：影响核心功能实现和用户体验
   - **缓解措施**：详细分析现有服务依赖，建立依赖关系图，分阶段实现

2. **风险**：不同操作系统和环境的兼容性问题
   - **影响**：限制工具的使用范围
   - **缓解措施**：使用跨平台技术，建立多环境测试流程

3. **风险**：性能开销可能影响开发体验
   - **影响**：降低开发效率，违背初始目标
   - **缓解措施**：优化启动流程，使用异步启动，设置合理的资源限制

4. **风险**：单进程模式中一个组件崩溃可能影响整个系统
   - **影响**：服务可用性降低，调试难度增加
   - **缓解措施**：实施异常隔离和组件级别的健康检查，提供快速重启机制

### 关键权衡

- **复杂性 vs 易用性**：选择简单易用的接口设计，即使可能限制高级功能的灵活性
- **功能完整性 vs 开发速度**：优先实现核心功能，高级功能分阶段迭代
- **向后兼容 vs 架构优化**：保持与现有脚本的兼容性，避免破坏现有工作流
- **单进程模式 vs 多进程模式**：开发环境默认使用单进程（简单高效），生产环境使用多进程（稳定可靠）

## 8. 成功指标

### 关键绩效指标（KPIs）

- **启动效率提升**：完整环境启动时间从5分钟减少到30秒内
- **开发体验改善**：新开发人员环境搭建时间从2小时减少到15分钟
- **错误率降低**：环境相关的开发问题减少60%
- **采用率**：团队成员使用统一启动器的比例达到90%以上

### 监控计划

- 通过开发团队反馈收集使用体验数据
- 记录启动成功率和平均启动时间
- 定期进行用户体验调研和改进建议收集
- 监控环境相关问题的报告数量变化

## 9. 附录

### 相关文档

- [当前后端架构文档](apps/backend/CLAUDE.md)
- [现有启动脚本分析](apps/backend/scripts/)
- [Agent服务架构](apps/backend/src/agents/)
- [开发环境设置指南](scripts/dev/)

### 术语表

- **API Gateway**：FastAPI应用程序，提供认证和路由功能
- **AI Agent**：专门的AI服务，负责不同的小说写作任务
- **Kafka Consumer**：消费Kafka消息队列的后端服务
- **Service Launcher**：统一的服务启动器组件
- **Hot Reload**：代码变更时自动重启的开发功能
- **单进程模式**：所有后端服务在同一个 Python 进程中运行的模式
- **多进程模式**：每个后端服务在独立进程中运行的模式
- **组件级别健康检查**：在单进程模式下针对各个功能组件的独立健康检查