# SSE 实现任务清单

> **MVP 说明**：当前项目处于 MVP 阶段，P0 包含让 SSE 端到端工作的最小功能集。P1 包含完善和优化，P2 包含生产级别的要求。

## P0 - MVP 核心功能（端到端工作）

> **P0 必须功能**：心跳保活、基础认证、简单事件分发、前端自动缓存更新

### 1. 基础事件模型 [4h]
- [ ] **创建简化的 SSE 事件模型**
  - [ ] 创建 `/packages/shared-types/src/sse_events.py`
  - [ ] 定义 SSEMessage 基类（包含 event, data, id, scope 字段）
  - [ ] 使用 kebab-case.verb-past 命名规范
  - [ ] 定义核心事件类型（TaskProgressEvent, TaskStatusChangeEvent, ErrorEvent）
  - [ ] 实现 to_sse_format() 方法
  - [ ] 更新 TypeScript 类型定义（含 scope 路由）

- [ ] **创建基础 Kafka → SSE 映射**
  - [ ] 创建简单的映射文档
  - [ ] 定义 2-3 个核心事件的映射规则
  - [ ] 包含 scope 和过滤 key

### 2. 后端最小实现 [6h]
- [ ] **创建基础目录结构**
  - [ ] `/apps/backend/src/api/v1/events/`
  - [ ] `/apps/backend/src/services/sse/`

- [ ] **实现简单的 SSEManager** 
  - [ ] 基础连接管理（dict 存储连接）
  - [ ] JWT 认证检查
  - [ ] 发送事件到指定用户
  - [ ] 心跳机制（每 15s 发送 `:\n\n`）

- [ ] **实现 SSE 端点**
  - [ ] `/api/v1/events/stream` GET 端点
  - [ ] FastAPI StreamingResponse
  - [ ] 基础错误处理

- [ ] **创建简单的事件触发器**
  - [ ] 任务进度更新时触发 SSE 事件
  - [ ] 直接调用 SSEManager（不需要复杂的 EventBus）

### 3. 前端最小实现 [5h]
- [ ] **实现基础 SSE 客户端**
  - [ ] 创建 `/apps/frontend/src/services/sse/client.ts`
  - [ ] EventSource 包装（带 JWT token）
  - [ ] 基础的自动重连（固定延迟）

- [ ] **React 集成**
  - [ ] 创建 useSSE Hook
  - [ ] 处理任务进度事件
  - [ ] 更新 UI 显示实时进度
  - [ ] 与 TanStack Query 基础集成（invalidate queries）

- [ ] **替换一个轮询示例**
  - [ ] 找到一个具体的轮询场景
  - [ ] 用 SSE 替换验证效果

### 4. 基础测试 [2h]
- [ ] **手动测试流程文档**
  - [ ] 如何触发事件
  - [ ] 如何验证前端接收
  - [ ] 常见问题排查

- [ ] **一个端到端测试**
  - [ ] 后端发送事件
  - [ ] 前端接收并更新 UI

## P1 - 功能完善与优化

> **P1 增强功能**：背压控制、事件补偿、多标签订阅、连接管理、完整监控

### 1. 完整的事件系统 [8h]
- [ ] **扩展事件类型**
  - [ ] 添加所有业务事件类型
  - [ ] 实现事件版本控制（version 字段）
  - [ ] 实现事件作用域（scope 字段）

- [ ] **实现 EventBus 抽象**
  - [ ] 定义 Protocol/ABC 接口
  - [ ] 实现 Kafka 适配器
  - [ ] 实现 Redis 适配器
  - [ ] Event Adapter 层（格式转换、权限过滤）

- [ ] **完整 Kafka → SSE 映射**
  - [ ] 扩展映射文档到所有事件类型
  - [ ] 实现自动事件转换（保持命名规范）
  - [ ] 批量处理和性能优化
  - [ ] 错误事件的特殊处理

### 2. 高级连接管理 [8h]
- [ ] **增强 SSEManager**
  - [ ] 使用 asyncio.Queue 管理事件队列
  - [ ] 实现背压处理（队列满时丢弃/合并）
  - [ ] 添加连接统计和监控指标
  - [ ] 多标签订阅支持（动态 filter set）
  - [ ] 连接数限制（--max-clients）

- [ ] **事件补偿机制（Last-Event-ID）** [2h]
  - [ ] 实现 Last-Event-ID 支持
  - [ ] 短时间窗口的事件缓存（5分钟）
  - [ ] 简单的事件重放
  - [ ] 与 Kafka offset 集成

### 3. 前端增强 [5h]
- [ ] **完善 SSE 客户端**
  - [ ] 指数退避重连策略
  - [ ] 连接状态管理（30s 无数据自动重连）
  - [ ] 错误处理和用户提示
  - [ ] SSEProvider Context
  - [ ] 完整的 TanStack Query 集成（entity_type → invalidate）

- [ ] **全面替换轮询**
  - [ ] 识别所有轮询代码
  - [ ] 逐步替换为 SSE
  - [ ] 保留降级开关

### 4. 测试覆盖 [6h]
- [ ] **单元测试**
  - [ ] SSEManager 测试
  - [ ] 事件转换测试
  - [ ] 前端 Hook 测试

- [ ] **集成测试**
  - [ ] 完整的事件流测试
  - [ ] 断线重连测试
  - [ ] 多用户隔离测试

### 5. 完整目录结构 [2h]
- [ ] **创建完整的项目目录结构**
  - [ ] `/apps/backend/src/api/v1/events/` - 事件相关的 API 端点
  - [ ] `/apps/backend/src/services/sse/` - SSE 服务实现
  - [ ] `/apps/backend/src/adapters/` - Event Adapter 层
  - [ ] `/apps/backend/src/interfaces/` - EventBus 接口定义
  - [ ] `/apps/frontend/src/services/sse/` - 前端 SSE 服务
  - [ ] `/apps/frontend/src/hooks/sse/` - SSE 相关 Hooks
  - [ ] `/apps/frontend/src/contexts/sse/` - SSE Context

### 6. 日志与文档 [4h]
- [ ] **结构化日志完善**
  - [ ] 详细的连接日志
  - [ ] 事件发送日志
  - [ ] 错误日志
  - [ ] 调试信息

- [ ] **开发文档**
  - [ ] API 使用指南
  - [ ] 事件类型说明
  - [ ] 故障排除指南

## P2 - 生产就绪（后期实施）

> **P2 生产特性**：高性能优化、高级监控、安全加固、灰度发布支持

### 1. 性能优化 [10h]
- [ ] **压力测试**
  - [ ] 1k/5k/10k 并发连接测试
  - [ ] 内存和 CPU 使用分析
  - [ ] 网络带宽优化
  - [ ] 连接池调优

- [ ] **高级优化**
  - [ ] 使用 uvloop 提升性能
  - [ ] 事件批处理
  - [ ] 连接分片（如需要）
  - [ ] 背压机制完整实现
  - [ ] 心跳保活机制

### 2. 高级功能 [8h]
- [ ] **完整的事件补偿**
  - [ ] 基于 Kafka offset 的精确重放
  - [ ] 长时间窗口的事件存储
  - [ ] 复杂的权限和过滤逻辑

- [ ] **监控和告警**（后期考虑）
  - [ ] 自定义指标收集
  - [ ] 性能分析工具
  - [ ] 自动告警规则
  - [ ] 健康检查端点

### 3. 安全和运维 [6h]
- [ ] **安全加固**
  - [ ] 速率限制
  - [ ] DDoS 防护
  - [ ] 安全审计
  - [ ] 输入验证加强

- [ ] **运维支持**
  - [ ] 蓝绿部署
  - [ ] 优雅关闭
  - [ ] 配置热更新
  - [ ] 故障自动恢复

## 任务统计

### MVP 阶段（当前）
- **P0 任务**：4 大项，预计 18 小时（包含必要特性的 MVP）
  - 基础事件模型：4h（含基础 Kafka → SSE 映射）
  - 后端最小实现：6h（含心跳机制）
  - 前端最小实现：6h（含 TanStack Query 集成）
  - 基础测试：2h

### 功能完善
- **P1 任务**：6 大项，预计 33 小时
  - 完整事件系统：8h
  - 高级连接管理：8h（含事件补偿机制）
  - 前端增强：5h
  - 测试覆盖：6h
  - 完整目录结构：2h
  - 日志与文档：4h

### 生产优化
- **P2 任务**：3 大项，预计 24 小时
  - 性能优化：10h
  - 高级功能：8h
  - 安全和运维：6h

### 总计
- **真正的 MVP**：18 小时
- **完整功能**：51 小时（P0+P1）
- **生产就绪**：75 小时（P0+P1+P2）

## 进行中

（当前没有进行中的任务）

## 已完成

- [x] 任务背景调研
- [x] 技术方案设计
- [x] 架构图绘制
- [x] 任务计划制定
- [x] 架构评审和改进