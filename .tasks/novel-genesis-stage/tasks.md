# 实施计划 - 小说创世阶段

## 基础设施和数据库设置

- [ ] 1. 建立数据库模式和核心表结构
  - 创建PostgreSQL数据库模式（conversation_sessions, conversation_rounds, command_inbox, domain_events, event_outbox）
  - 配置Neo4j图数据库节点类型和关系约束（Novel, Character, WorldRule等8个核心节点）
  - 设置Milvus向量数据库集合（novel_embeddings_v1，768维向量索引）
  - 配置Redis缓存结构（会话缓存，30天TTL）
  - 执行初始数据库迁移和索引创建
  - _需求：所有功能需求都依赖数据存储基础设施_

- [ ] 2. 配置事件驱动架构基础组件
  - 搭建Kafka事件总线（topics: genesis.session.events, agent.tasks.*, agent.results.*）
  - 实现Outbox模式的Message Relay服务（轮询event_outbox表并发布到Kafka）
  - 配置事件序列化/反序列化组件（JSON Envelope格式）
  - 实现基础事件追踪和correlation_id传递机制
  - 编写事件总线连接和故障恢复逻辑测试
  - _需求：FR-002, FR-003, FR-004, FR-005需要异步事件处理_

## 对话引擎和会话管理

- [ ] 3. 实现通用对话会话管理系统
  - 开发ConversationService类（基于ADR-001通用会话架构）
  - 实现Redis写透缓存策略（写入PostgreSQL后回填Redis）
  - 构建会话状态机（6个阶段的状态流转：Stage0-5）
  - 实现对话轮次管理（conversation_rounds表，支持最近10轮完整记录）
  - 开发乐观并发控制（version字段）和会话锁定机制
  - _需求：FR-001, FR-002_

- [ ] 4. 构建CQRS命令处理系统
  - 实现CommandInbox幂等性机制（idempotency_key唯一约束）
  - 开发命令处理器（支持CreateSession, PostMessage, PostCommand等操作）
  - 构建领域事件记录系统（domain_events表，sequence_id自增保序）
  - 实现事务性写入（命令+事件+Outbox原子操作）
  - 编写命令冲突检测和409响应处理逻辑
  - _需求：FR-001, FR-007_

- [ ] 5. 开发SSE实时推送系统
  - 实现RedisSSEService（基于Redis发布订阅）
  - 构建EventBridge服务（Kafka消费者→Redis SSE事件发布）
  - 开发SSE连接管理（用户认证，连接池，心跳检测）
  - 实现Last-Event-ID序列管理和历史事件补发
  - 构建连接故障恢复和Redis熔断机制
  - _需求：NFR-001首token响应<3秒_

## 中央协调器和事件路由

- [ ] 6. 实现中央协调器（Orchestrator）
  - 开发事件消费器（监听genesis.session.events topic）
  - 实现业务规则引擎（根据阶段和用户操作决定调用哪个Agent）
  - 构建任务分发器（发布到对应Agent的task topics）
  - 开发结果事件聚合器（处理Agent返回的结果事件）
  - 实现阶段推进逻辑（Stage0→Stage1→...→Stage5）
  - _需求：FR-001, FR-002, FR-003, FR-004, FR-005_

- [ ] 7. 建立Agent任务分发和结果处理机制
  - 实现统一的TaskEvent和ResultEvent结构（JSON格式）
  - 开发Agent负载均衡器（基于Kafka消费组）
  - 构建任务超时检测和重新调度机制（默认5分钟超时）
  - 实现死信队列（DLT）处理连续失败的任务
  - 开发任务执行追踪和状态报告系统
  - _需求：FR-006批量生成，NFR-001性能要求_

## AI代理专门化实现

- [ ] 8. 实现Outliner Agent（大纲和高概念生成）
  - 开发创意种子生成器（5种创作起点：类型、点子、人物、世界、主题）
  - 实现高概念评分算法（独特性、吸引力、记忆度三维评估）
  - 构建方案融合工具（合并2-4个高概念为综合方案）
  - 开发情节框架生成器（10-20个节点卡，支持三幕/五幕/英雄之旅）
  - 实现Agent→LLM→质量评分→事件发布完整流程
  - _需求：FR-001创意种子生成, FR-005情节框架_

- [ ] 9. 构建World Builder Agent（世界观构建）
  - 实现5维度世界观分解器（地理、历史、文化、规则、社会）
  - 开发魔法/科技体系生成器（力量等级、使用限制、代价机制）
  - 构建规则格式化输出（核心规则+具体示例+边界条件三层结构）
  - 实现维度间依赖关系管理和跨维度一致性检查
  - 开发世界观锁定验证（规则完整性和逻辑自洽性检查）
  - _需求：FR-003世界观对话式构建_

- [ ] 10. 开发Character Expert Agent（人物设计）
  - 实现8维度人物设定生成器（外貌、性格、背景、动机、目标、障碍、转折、心结）
  - 开发角色类型分类器（主角、配角、反派的不同生成策略）
  - 构建人物关系网络自动生成器（基于Neo4j图数据库）
  - 实现语言特征和对白样本生成器（口癖、语气、措辞习惯）
  - 开发人物一致性验证器（MBTI类型、行为动机一致性检查）
  - _需求：FR-004人物对话式设计_

- [ ] 11. 实现Detail Generator Agent（批量细节生成）
  - 开发批量内容生成器（地名、人名、物品、技能、组织5个类别）
  - 实现去重检测系统（基于Qwen3-Embedding向量相似度，阈值<0.7-0.8）
  - 构建风格控制器（东方玄幻、西方奇幻、科幻等风格模板）
  - 开发命名规律一致性检查器（音节结构、文化背景符合度）
  - 实现批量生成性能优化（单批10-50个，生成时间<5秒）
  - _需求：FR-006 AI批量细节生成_

## 质量评分和一致性校验系统

- [ ] 12. 构建多维度质量评分系统
  - 实现LLM自评分器（使用GPT-4评估相关性、创意性、完整性，权重30%）
  - 开发规则校验器（长度、格式、必填字段验证，权重20%）
  - 构建语义相似度检测器（基于Qwen3-Embedding，权重25%）
  - 实现一致性检查器（Neo4j五维校验，权重25%）
  - 开发阶段特定权重调整机制（不同阶段动态调整评分权重）
  - _需求：NFR-005 AI采纳率≥70%_

- [ ] 13. 实现Neo4j一致性校验引擎
  - 开发5类核心校验规则（角色关系闭包、世界规则冲突、时间线一致性、人物属性连续性、地理空间合理性）
  - 实现ConsistencyValidator类（批量执行校验查询，0-10分评分）
  - 构建自动修复策略（关系闭包补全、时间线调整、属性插值）
  - 开发违规分级处理（Warning/Error/致命，对应不同处理策略）
  - 实现校验结果聚合和一致性报告生成器
  - _需求：FR-003世界观一致性，FR-004人物关系网络_

- [ ] 14. 建立质量评分处理流程和重试机制
  - 实现评分阈值处理策略（≥8.0直接通过，6.0-7.9带建议，4.0-5.9需修正，<4.0重新生成）
  - 开发重试控制器（最多3次重试，指数退避策略）
  - 构建Prompt调整器（根据失败原因动态调整生成策略）
  - 实现DLT队列处理（连续失败任务人工介入机制）
  - 开发采纳率监控器（实时追踪70%目标达成情况）
  - _需求：NFR-005质量要求_

## 向量搜索和知识管理

- [ ] 15. 集成Qwen3-Embedding向量化服务
  - 配置Ollama API集成（http://192.168.1.191:11434/api/embed）
  - 实现VectorService封装层（批量embedding生成，768维向量处理）
  - 开发异步向量化队列（处理大量内容的向量化任务）
  - 构建向量缓存策略（热点embedding本地缓存，减少API调用）
  - 实现向量化失败重试和降级机制（API不可用时的处理策略）
  - _需求：基于ADR-002向量嵌入模型选择_

- [ ] 16. 构建Milvus向量数据库管理系统
  - 实现集合版本化管理（novel_embeddings_v{n}命名策略）
  - 开发HNSW索引配置（M=32, efConstruction=200, COSINE相似度）
  - 构建分区管理器（按novel_id分区，TTL=90天自动清理）
  - 实现冷热数据分层（热数据IVF_FLAT，冷数据HNSW压缩）
  - 开发模型迁移策略（双写→灰度→别名切换的平滑迁移）
  - _需求：FR-008知识库管理，NFR-001向量检索<400ms_

- [ ] 17. 实现知识库搜索和组织功能
  - 开发混合检索系统（关键词+向量+图谱三种检索方式）
  - 构建分类组织器（世界观、人物、地点、物品、组织、事件六大分类）
  - 实现搜索建议和拼写纠正功能（基于相似度和编辑距离）
  - 开发自动索引更新器（内容变更时同步更新向量索引）
  - 构建多格式导出器（Markdown、JSON、PDF、EPUB四种格式）
  - _需求：FR-008创世内容知识库_

## 版本控制和分支管理

- [ ] 18. 实现内容版本控制系统
  - 开发快照存储器（MinIO对象存储，SHA256内容寻址）
  - 构建增量存储器（PostgreSQL content_deltas表，DMP/JSON Patch格式）
  - 实现DAG版本图管理（支持主线、探索分支、检查点快照）
  - 开发三路合并算法（自动合并+冲突检测+用户确认）
  - 构建CAS更新机制（乐观并发控制，防止分支冲突）
  - _需求：基于ADR-004内容版本控制实现_

- [ ] 19. 构建分支管理和历史追溯功能
  - 实现分支创建器（branch_YYYYMMDD_HHMMSS命名规则）
  - 开发版本对比工具（2-3个版本并排显示，差异高亮）
  - 构建历史查询器（时间范围、阶段、关键词、状态多维筛选）
  - 实现回滚功能（支持阶段级回滚，保留完整历史）
  - 开发分支合并工具（智能合并建议，冲突解决界面）
  - _需求：FR-009对话历史与版本管理_

## 前端界面和用户交互

- [ ] 20. 开发创世对话界面
  - 构建React组件（对话气泡、输入框、操作按钮三键设计）
  - 实现SSE事件接收器（实时显示AI生成内容）
  - 开发响应式布局（支持桌面和移动端，FCP<1.5秒）
  - 构建操作反馈系统（接受、修改、重新生成三种操作的UI反馈）
  - 实现离线状态处理（网络中断时的用户提示和数据缓存）
  - _需求：FR-007内容审核与编辑界面_

- [ ] 21. 实现内容编辑和审核功能
  - 开发富文本编辑器（支持Markdown格式，实时预览）
  - 构建影响分析器（修改关键设定时显示受影响内容数量）
  - 实现批量更新工具（一键更新所有受影响内容，显示进度条）
  - 开发版本管理界面（历史版本列表，对比查看，一键回滚）
  - 构建自动保存机制（间隔≤30秒，防止数据丢失）
  - _需求：FR-007内容审核与编辑界面_

- [ ] 22. 构建知识库管理界面
  - 实现知识库浏览器（树形结构展示，分类导航）
  - 开发搜索界面（统一搜索框，多种检索方式切换）
  - 构建内容详情页（完整信息展示，相关内容推荐）
  - 实现批量操作工具（批量编辑、删除、导出功能）
  - 开发可视化图谱（人物关系网络，世界观结构图）
  - _需求：FR-008创世内容知识库，FR-010创作方法论学习_

## 系统集成和测试

- [ ] 23. 实现端到端集成测试
  - 开发完整创世流程测试（Stage0→Stage5全流程自动化测试）
  - 构建性能压力测试（100并发会话，响应时间P95<3秒验证）
  - 实现数据一致性测试（跨数据库事务一致性验证）
  - 开发故障恢复测试（服务重启、网络中断、数据库故障场景）
  - 构建质量评分准确性测试（AI生成内容质量评分算法验证）
  - _需求：所有需求都需要端到端验证_

- [ ] 24. 建立监控和可观测性系统
  - 实现关键指标监控（响应时间、成功率、采纳率、错误率）
  - 开发业务监控大盘（创世完成率、平均时长、对话轮次统计）
  - 构建告警系统（P0/P1/P2分级告警，自动升级机制）
  - 实现链路追踪（trace_id全链路传递，correlation_id事件关联）
  - 开发日志分析系统（结构化日志，错误模式识别）
  - _需求：NFR-007可观测性100%覆盖_

## 部署和运维

- [ ] 25. 配置生产环境部署
  - 构建Docker镜像（API Gateway、各Agent服务、EventBridge、Orchestrator）
  - 配置Kubernetes部署清单（HPA自动扩缩容，资源限制）
  - 实现服务发现和负载均衡（多实例部署，健康检查）
  - 开发部署脚本（一键部署，蓝绿发布，回滚机制）
  - 构建环境配置管理（开发、测试、生产环境差异化配置）
  - _需求：NFR-002月度可用性≥99.5%_

- [ ] 26. 建立安全和合规机制
  - 实现JWT认证系统（24小时有效期，刷新机制）
  - 开发API限流器（滑动窗口限流，P95延迟保障）
  - 构建内容安全过滤器（违法内容拦截，暴力色情标记）
  - 实现数据加密存储（字段级加密，KMS密钥管理）
  - 开发审计日志系统（关键操作记录，90天保留期）
  - _需求：NFR-004安全性，NFR-008合规性_