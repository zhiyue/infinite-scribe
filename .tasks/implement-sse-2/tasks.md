# 实施计划

## 后端基础设施

- [ ] 1. 创建SSE基础数据模型和数据库表
  - 在 `apps/backend/src/models/` 中创建 SSE 相关模型 (`SSEConnection`, `PersistentEvent`)
  - 创建数据库迁移文件添加 `sse_connections` 和 `persistent_events` 表
  - 实现模型的基本 CRUD 操作和查询方法
  - 编写模型验证和序列化的单元测试
  - _需求：1.5, 2.1, 7.1_

- [ ] 1.1 实现SSE事件基础模式和序列化
  - 在 `apps/backend/src/schemas/sse.py` 中扩展现有SSE模式
  - 实现 `TaskProgressEvent`, `ContentNotificationEvent`, `SystemNotificationEvent` 等事件类型
  - 创建事件序列化/反序列化工具函数
  - 编写事件模式验证的单元测试
  - _需求：3.1, 4.1, 7.1_

- [ ] 1.2 实现Redis发布订阅服务扩展
  - 在 `apps/backend/src/common/services/redis_service.py` 中添加 SSE 专用方法
  - 实现频道订阅、取消订阅、消息发布功能
  - 添加连接状态缓存和事件历史缓存方法
  - 编写 Redis Pub/Sub 功能的集成测试
  - _需求：2.1, 2.7, 8.6_

## SSE连接管理核心

- [ ] 2. 实现SSE连接管理器
  - 在 `apps/backend/src/services/` 中创建 `SSEConnectionManager` 类
  - 实现连接添加、移除、事件分发、广播等核心方法
  - 集成JWT认证验证和用户会话管理
  - 实现连接心跳检测和自动清理机制
  - 编写连接管理器的单元测试和集成测试
  - _需求：1.1-1.7, 2.1-2.7_

- [ ] 2.1 实现事件持久化存储服务
  - 在 `apps/backend/src/services/` 中创建 `SSEEventStore` 类
  - 实现重要事件存储、历史查询、过期清理功能
  - 添加事件重放和离线恢复机制
  - 实现批量事件处理提高存储性能
  - 编写事件持久化的单元测试和可靠性测试
  - _需求：7.1-7.7_

- [ ] 2.2 实现SSE路由和中间件
  - 在 `apps/backend/src/api/` 中创建 SSE 路由处理器
  - 实现JWT认证中间件和用户权限验证
  - 添加频率限制和连接数限制中间件
  - 集成CORS和安全头配置
  - 编写路由和中间件的单元测试
  - _需求：1.3, 1.4, 8.5_

## SSE API端点实现

- [ ] 3. 创建主要SSE API端点
  - 实现 `GET /api/v1/events/stream` 建立SSE连接端点
  - 实现 `GET /api/v1/events/stream/{user_id}` 用户专属事件流端点
  - 实现 `GET /api/v1/events/history` 历史事件查询端点
  - 实现 `GET /api/v1/events/health` SSE健康检查端点
  - 编写API端点的集成测试
  - _需求：1.1, 1.2, 7.2_

- [ ] 3.1 实现SSE专用认证token服务
  - 在 `apps/backend/src/api/auth/` 中创建 `POST /api/v1/auth/sse-token` 端点
  - 实现短期SSE专用token生成(60秒TTL)
  - 添加token刷新和验证逻辑
  - 实现token黑名单和撤销机制
  - 编写SSE认证的安全测试
  - _需求：1.3, 1.4, 安全考虑_

## 业务服务集成

- [ ] 4. 集成任务进度SSE推送
  - 扩展现有 `TaskService` 添加SSE事件推送功能
  - 实现任务开始、进度更新、完成、失败事件推送
  - 添加进度频率限制(最多每秒1次)和长时间运行心跳
  - 确保只推送用户授权的任务进度
  - 编写任务进度推送的端到端测试
  - _需求：3.1-3.7_

- [ ] 4.1 集成内容变更通知系统
  - 扩展现有内容服务添加SSE通知功能
  - 实现小说创建、章节更新、工作流状态变化事件推送
  - 添加用户权限过滤确保信息安全
  - 实现批量内容更新的事件合并机制
  - 编写内容通知的集成测试
  - _需求：4.1-4.7_

- [ ] 4.2 实现系统级事件通知
  - 创建系统通知服务处理维护、错误、更新通知
  - 实现系统级事件的优先级分发和广播
  - 添加紧急错误事件的即时推送机制
  - 实现通知级别过滤和用户偏好设置
  - 编写系统通知的单元测试和故障恢复测试
  - _需求：4.3, 4.7_

## 前端SSE客户端实现

- [ ] 5. 实现前端SSE连接钩子
  - 在 `apps/frontend/src/hooks/` 中创建 `useSSEConnection` 钩子
  - 使用EventSource Polyfill支持JWT认证头
  - 实现指数退避重连策略(最多5次重试)
  - 添加连接状态管理和错误处理
  - 编写SSE连接钩子的单元测试
  - _需求：5.1-5.7_

- [ ] 5.1 实现任务进度订阅钩子
  - 在 `apps/frontend/src/hooks/` 中创建 `useTaskProgress` 钩子
  - 集成现有任务状态管理，替代轮询机制
  - 实现进度数据的防抖处理避免频繁更新
  - 添加任务完成和错误状态的用户通知
  - 编写任务进度钩子的集成测试
  - _需求：3.1-3.7, 6.1_

- [ ] 5.2 实现内容和系统通知钩子
  - 创建 `useContentNotifications` 和 `useSystemNotifications` 钩子
  - 实现通知消息的本地状态管理和持久化
  - 添加未读消息计数和标记已读功能
  - 实现通知优先级显示和用户交互
  - 编写通知钩子的单元测试和E2E测试
  - _需求：4.1-4.7_

## UI组件和用户体验

- [ ] 6. 实现SSE连接状态组件
  - 在 `apps/frontend/src/components/` 中创建 `SSEConnectionStatus` 组件
  - 显示连接状态指示器(连接中、已连接、重连中、已断开)
  - 实现重连计数显示和手动重连按钮
  - 添加网络状态检测和用户友好的错误提示
  - 编写连接状态组件的视觉测试
  - _需求：5.5, 5.6_

- [ ] 6.1 集成SSE到现有页面组件
  - 更新任务管理页面使用SSE实时进度显示
  - 更新内容编辑页面集成实时保存通知
  - 更新系统设置页面显示实时系统通知
  - 确保页面切换时SSE连接保持活跃
  - 编写页面集成的E2E测试
  - _需求：5.4, 6.4_

## 轮询替换和兼容性

- [ ] 7. 实现轮询到SSE的平滑切换
  - 创建实时通信策略切换服务
  - 实现SSE可用性检测和自动降级到轮询
  - 添加运行时配置支持A/B测试
  - 确保数据更新逻辑和UI组件行为保持一致
  - 编写轮询/SSE切换的兼容性测试
  - _需求：6.1-6.7_

- [ ] 7.1 优化移动设备SSE支持
  - 实现移动设备网络切换的连接管理优化
  - 添加应用后台模式的连接暂停和恢复
  - 优化移动网络下的事件推送频率
  - 实现移动设备的电池优化策略
  - 编写移动端的专项测试
  - _需求：6.7_

## 监控和性能优化

- [ ] 8. 实现SSE监控和指标收集
  - 添加SSE连接数、事件推送延迟、错误率等关键指标
  - 集成现有Prometheus监控系统
  - 实现性能瓶颈自动检测和告警
  - 添加资源使用情况监控(内存、CPU)
  - 编写监控系统的单元测试和告警测试
  - _需求：8.1-8.7_

- [ ] 8.1 实现性能优化和负载测试
  - 优化SSE连接管理的内存使用和GC压力
  - 实现事件推送的批量处理和背压控制
  - 添加动态负载调整和连接限流机制
  - 进行1万并发连接的性能压力测试
  - 验证P95延迟<200ms的性能目标
  - _需求：8.4, 8.6, 性能目标_

## 集成测试和部署准备

- [ ] 9. 实现端到端测试套件
  - 创建完整的SSE功能端到端测试场景
  - 测试任务进度订阅→创建AI任务→接收实时进度→完成通知流程
  - 测试连接恢复→断网模拟→自动重连→事件历史同步流程
  - 测试多用户并发→事件广播→用户数据隔离验证
  - 验证所有EARS需求的验收标准
  - _需求：所有需求都需要端到端验证_

- [ ] 9.1 部署配置和环境准备
  - 更新Docker Compose配置支持SSE服务
  - 配置生产环境的Redis Pub/Sub和PostgreSQL优化
  - 实现健康检查和服务发现集成
  - 添加SSE服务的日志配置和错误追踪
  - 完成开发、测试、生产环境的配置部署
  - _需求：所有需求都需要部署支持_