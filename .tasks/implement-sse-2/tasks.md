# 实施计划

## 阶段1: MVP基础设施 (4-5周)

### Redis SSE服务基础设施

- [x] 1. 扩展Redis服务支持SSE Pub/Sub和Streams
  - 在`apps/backend/src/common/services/redis_service.py`基础上创建`RedisSSEService`
  - 实现`publish_event()`方法：先XADD到Stream获取ID，再发布指针到Pub/Sub
  - 实现`subscribe_user_events()`：订阅Pub/Sub获取指针，从Stream读取完整数据
  - 实现`get_recent_events()`：从Redis Streams查询历史事件
  - 编写Redis SSE服务的单元测试和集成测试
  - _需求：2.1-2.4, 2.7_

- [x] 1.1 实现SSE连接管理器
  - 创建`apps/backend/src/services/sse_connection_manager.py`
  - 实现基于`fastapi-sse.EventSourceResponse`的连接管理
  - 实现队列聚合设计：心跳+实时事件+历史事件的异步队列
  - 实现用户并发连接限制（每用户最多2个连接，Redis计数）
  - 实现连接清理机制和僵尸连接GC
  - 编写连接管理器的单元测试
  - _需求：1.1-1.7, 2.1-2.7_

### SSE API端点实现

- [ ] 2. 实现SSE流式端点
  - 创建`apps/backend/src/api/v1/events.py`路由模块
  - 实现`GET /api/v1/events/stream?sse_token=...`端点
  - 集成SSE连接管理器，支持Last-Event-ID重连
  - 实现SSE Token查询参数认证（避免EventSource头限制）
  - 添加连接建立、心跳、事件推送的完整流程
  - 编写SSE端点的集成测试
  - _需求：1.1-1.7_

- [ ] 2.1 实现SSE认证Token服务
  - 在`apps/backend/src/api/v1/auth.py`中添加`POST /api/v1/auth/sse-token`端点
  - 实现短期SSE专用Token生成（60秒TTL，从JWT派生）
  - 添加Token验证和用户ID解析逻辑
  - 实现Token过期后的重新获取机制
  - 编写SSE认证的单元测试和安全测试
  - _需求：1.3-1.4, 安全考虑_

- [ ] 2.2 实现健康检查和基础监控端点
  - 创建`GET /api/v1/events/health`健康检查端点
  - 实现连接统计和Redis状态检查
  - 添加基础性能指标收集（连接数、延迟）
  - 实现服务状态报告功能
  - 编写健康检查的单元测试
  - _需求：8.1-8.2_

### 任务进度SSE集成

- [ ] 3. 扩展TaskService集成SSE推送
  - 在现有`TaskService`中添加SSE事件推送功能
  - 实现`task.progress-started`、`task.progress-updated`、`task.progress-completed`事件
  - 添加任务进度更新频率限制（最多每秒1次）
  - 确保只推送用户授权的任务进度事件
  - 集成Redis SSE服务发布任务进度事件
  - 编写任务进度SSE推送的单元测试
  - _需求：3.1-3.7_

- [ ] 3.1 实现任务失败和错误处理
  - 在TaskService中实现`task.progress-failed`事件推送
  - 添加任务执行超时和异常处理的SSE通知
  - 实现任务重试建议和用户操作指导
  - 处理长时间运行任务的定期心跳更新
  - 编写任务错误处理的集成测试
  - _需求：3.4, 3.6_

### 前端SSE客户端基础

- [ ] 4. 实现基础SSE连接Hook
  - 在`apps/frontend/src/hooks/`中创建`useSSEConnection`
  - 使用原生EventSource API建立SSE连接
  - 实现基础重连策略（指数退避，最多5次重试）
  - 添加连接状态管理和错误处理
  - 集成SSE Token获取和认证流程
  - 编写SSE连接Hook的单元测试
  - _需求：5.1-5.7_

- [ ] 4.1 实现任务进度订阅Hook
  - 创建`useTaskProgress`专用Hook
  - 订阅任务进度更新事件，本地状态管理
  - 实现进度数据的节流处理避免频繁渲染
  - 添加任务完成和失败的用户通知
  - 与现有任务状态管理集成
  - 编写任务进度Hook的集成测试
  - _需求：3.1-3.7, 5.1-5.7_

### 阶段1集成测试和验证

- [ ] 5. 阶段1端到端测试
  - 创建任务进度SSE完整流程测试
  - 测试：创建AI任务→SSE连接→实时进度更新→完成通知
  - 验证500并发连接稳定性
  - 测试连接建立时间<1s，事件延迟P95<300ms
  - 验证断线重连和Last-Event-ID事件历史恢复
  - _需求：阶段1退出标准_

## 阶段2: 功能完善 (4-5周)

### 完整事件类型支持

- [ ] 6. 扩展SSE事件类型支持
  - 基于现有`apps/backend/src/schemas/sse.py`实现所有事件类型
  - 实现`content.novel-created`、`content.chapter-updated`事件
  - 实现`system.notification`、`system.error`系统级事件
  - 实现`workflow.status-changed`工作流状态事件
  - 添加事件数据验证和权限过滤
  - 编写完整事件类型的单元测试
  - _需求：4.1-4.7_

- [ ] 6.1 实现内容变更通知系统
  - 扩展内容服务添加SSE事件推送
  - 实现小说和章节变更的实时通知
  - 添加批量内容更新的事件合并机制
  - 实现用户权限检查和敏感信息过滤
  - 集成工作流状态变化推送
  - 编写内容通知的集成测试
  - _需求：4.1-4.7_

- [ ] 6.2 实现系统级事件通知
  - 创建系统通知服务处理维护和更新通知
  - 实现系统级事件的优先级分发和广播
  - 添加紧急错误事件的即时推送机制
  - 实现通知级别过滤和用户偏好设置
  - 编写系统通知的单元测试和故障恢复测试
  - _需求：4.3, 4.7_

### Redis Streams事件历史

- [ ] 7. 实现完整事件历史机制
  - 扩展Redis SSE服务支持24小时事件历史存储
  - 实现Redis Streams的XTRIM定时清理策略（使用SCAN避免KEYS阻塞）
  - 添加断线重连后的事件历史查询和回放
  - 实现`GET /api/v1/events/history?since_id=...`历史查询端点
  - 优化事件存储性能和内存使用
  - 编写事件历史的可靠性测试
  - _需求：7.1-7.4_

- [ ] 7.1 实现连接会话隔离
  - 改进SSE连接管理器支持用户会话隔离
  - 实现多连接间的事件路由和用户数据隔离
  - 添加连接状态的Redis缓存和跨实例同步
  - 优化连接池管理和资源使用
  - 编写多用户并发隔离测试
  - _需求：2.5-2.7, 多用户隔离_

### 前端功能完善

- [ ] 8. 实现完整前端SSE集成
  - 扩展`useSSEConnection`支持所有事件类型
  - 创建`useContentNotifications`和`useSystemNotifications`Hook
  - 实现通知消息的本地状态管理和持久化
  - 添加未读消息计数和标记已读功能
  - 集成TanStack Query的精准失效策略
  - 编写通知Hook的单元测试和E2E测试
  - _需求：4.1-4.7, 5.1-5.7_

- [ ] 8.1 实现SSE连接状态组件
  - 创建`apps/frontend/src/components/SSEConnectionStatus`
  - 显示连接状态指示器（连接中、已连接、重连中、已断开）
  - 实现重连计数显示和手动重连按钮
  - 添加网络状态检测和用户友好的错误提示
  - 集成到主要页面布局中
  - 编写连接状态组件的视觉回归测试
  - _需求：5.5-5.6_

### 阶段2集成测试

- [ ] 9. 阶段2端到端测试
  - 测试所有事件类型的完整推送链路
  - 验证1,500并发连接稳定性和事件隔离
  - 测试断线重连后事件历史恢复成功率>99%
  - 验证P95延迟<250ms的性能目标
  - 测试多用户并发场景下的数据隔离
  - _需求：阶段2退出标准_

## 阶段3: 性能优化和监控 (3-4周)

### SQLAlchemy模型和审计

- [ ] 10. 实现SSE事件审计表
  - 创建`apps/backend/src/models/sse.py`模型文件
  - 定义`SSEEventAudit`模型用于重要事件持久化
  - 生成Alembic迁移：`alembic revision --autogenerate -m "add sse audit table"`
  - 实现重要事件的数据库存储逻辑
  - 添加事件查询和分析功能
  - 编写审计模型的单元测试
  - _需求：7.5-7.7_

- [ ] 10.1 实现事件持久化策略
  - 实现重要事件筛选和批量写入PostgreSQL
  - 添加事件重放和离线恢复机制
  - 实现事件存储的清理策略（7天保留期）
  - 优化批量写入性能和事务管理
  - 编写事件持久化的可靠性测试
  - _需求：7.1-7.7_

### 完整监控体系

- [ ] 11. 实现完整SSE监控指标
  - 添加连接统计、事件推送延迟、错误率指标
  - 集成Prometheus监控系统
  - 实现性能瓶颈自动检测和告警
  - 添加资源使用监控（内存、CPU、Redis连接）
  - 创建SSE监控仪表板
  - 编写监控系统的单元测试和告警测试
  - _需求：8.1-8.7_

- [ ] 11.1 实现动态负载调整
  - 实现SSE连接数动态限制和负载均衡准备
  - 添加事件推送频率的自适应调整
  - 实现背压控制和队列管理优化
  - 添加异常连接检测和IP限制策略
  - 编写负载调整的压力测试
  - _需求：8.4-8.6_

### 轮询机制替换

- [ ] 12. 实现平滑的轮询到SSE切换
  - 创建实时通信策略切换服务
  - 实现SSE可用性检测和自动降级机制
  - 添加运行时配置支持A/B测试
  - 确保现有数据更新逻辑和UI组件行为一致性
  - 优化移动设备的SSE连接管理
  - 编写轮询/SSE切换的兼容性测试
  - _需求：6.1-6.7_

- [ ] 12.1 移动设备优化
  - 实现移动设备网络切换的连接管理
  - 添加应用后台模式的连接暂停/恢复
  - 优化移动网络下的推送频率和电池消耗
  - 实现网络质量检测和自适应策略
  - 编写移动端专项测试
  - _需求：6.7_

### 性能优化和压力测试

- [ ] 13. 实现性能优化
  - 优化SSE连接管理的内存使用和GC压力
  - 实现事件推送的批量处理和合并机制
  - 优化Redis配置和连接池参数
  - 添加连接复用和负载均衡支持
  - 实现事件清理和容量管理自动化
  - 编写内存和性能基准测试
  - _需求：性能目标, 8.4, 8.6_

- [ ] 13.1 负载测试和容量验证
  - 进行2,000并发连接的渐进式负载测试
  - 验证P95延迟<200ms，P99<500ms的性能目标
  - 测试高并发下的事件吞吐量（10,000/sec）
  - 验证系统在高负载下的稳定性和恢复能力
  - 生成性能分析报告和优化建议
  - _需求：阶段3退出标准，性能目标_

### 阶段3验收测试

- [ ] 14. 完整系统验收测试
  - 执行2,000并发连接的稳定性测试
  - 验证所有性能指标达到设计目标
  - 测试完整监控体系和告警机制
  - 验证轮询到SSE的平滑切换
  - 执行故障恢复和灾难场景测试
  - 生成最终验收报告
  - _需求：所有需求的最终验收_

## 部署和上线准备

- [ ] 15. 生产环境配置
  - 更新Docker Compose配置支持SSE服务
  - 配置生产环境的Redis集群和PostgreSQL优化
  - 实现健康检查和服务发现集成
  - 添加SSE服务的日志配置和错误追踪
  - 完成开发、测试、生产环境的完整部署
  - _需求：生产就绪_
