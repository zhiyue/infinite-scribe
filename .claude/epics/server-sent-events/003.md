---
name: Event Persistence & Recovery
status: open
created: 2025-08-28T12:52:35Z
updated: 2025-08-28T12:52:35Z
github: [Will be updated when synced to GitHub]
depends_on: [001]
parallel: true
conflicts_with: []
---

# Task: Event Persistence & Recovery

## Description

Implement critical event persistence to PostgreSQL and connection recovery mechanisms for SSE streams. Enable event replay for reconnecting users and ensure critical events (AI completions, errors, milestones) are never lost during connection disruptions.

## Acceptance Criteria

- [ ] Critical events persist to PostgreSQL with configurable retention policies
- [ ] Event replay capability for users reconnecting after disconnection
- [ ] Historical event querying for debugging and user recovery
- [ ] Duplicate event deduplication during replay
- [ ] Event cleanup policies to prevent database bloat
- [ ] Connection recovery detects missed events during disconnection
- [ ] Event store integrates with existing database patterns and migrations
- [ ] Performance optimized for high-frequency event storage

## Technical Details

### Implementation Approach
- **PostgreSQL Event Store**: Leverage existing database with new SSE events table
- **Repository Pattern**: Follow existing database abstraction patterns
- **Event Replay Logic**: Track last received event per user session
- **Retention Policies**: Configurable cleanup based on event type and age

### Code Locations/Files Affected
- `apps/backend/src/sse/event_store.py` - PostgreSQL event persistence layer
- `apps/backend/src/sse/models.py` - SQLAlchemy models for event storage
- `apps/backend/migrations/` - New migration for SSE events table
- `apps/backend/src/sse/replay.py` - Event replay and recovery logic
- Update `apps/backend/src/sse/event_manager.py` to integrate persistence

### Key Considerations
- **Database Performance**: Efficient indexing on user_id, timestamp, event_type
- **Storage Optimization**: Compress or truncate large event payloads
- **Connection Recovery**: Seamless replay without duplicating events to user
- **Cleanup Jobs**: Background tasks for event retention management

## Dependencies

- [ ] Task 001 - Backend SSE Infrastructure (event system must exist)
- [ ] Existing PostgreSQL database and SQLAlchemy setup
- [ ] Database migration system for new tables
- [ ] Background task system for cleanup jobs

## Effort Estimate

- **Size**: M (Medium - database integration)
- **Hours**: 12-14 hours
- **Parallel**: true (can develop alongside other SSE components)

## Definition of Done

- [ ] Event persistence table created with proper indexes
- [ ] Critical events automatically stored during publishing
- [ ] Event replay works for reconnecting users
- [ ] Performance tested with high event volume
- [ ] Database migration successfully deployable
- [ ] Event cleanup policies implemented and tested
- [ ] Integration tests cover persistence and replay scenarios
- [ ] Monitoring added for event store performance