# Epic 4: 规模化生成与稳定性验证 (Scale & Stability Validation)

**目标:** 在MVP流程的基础上，实现系统的自动化、无人值守的连续章节生成能力，并完成首个10万字（约30-35章）的生成目标，以验证系统的稳定性和长文本一致性。

## Story 4.1: 实现自动化连续生成调度器

*   **As a** 系统,
*   **I want** 一个基于Prefect的调度器，它能在上一章成功完成后，自动触发下一章的生成流程,
*   **so that** 我可以实现无人值守的、连续的小说创作。
*   **Acceptance Criteria:**
    1.  创建一个新的Prefect Flow，作为主调度器。
    2.  该Flow可以被手动启动，并设定一个目标章节数（例如，生成30章）。
    3.  Flow会循环调用在Epic 3中创建的“单章节生成工作流”。
    4.  每当一个章节工作流成功完成（状态为“已发布”），主调度器会自动为下一章启动新的工作流。
    5.  如果任何一个章节工作流失败，主调度器会暂停，并记录下失败的章节和原因。
    6.  UI上需要有一个地方可以启动这个“连续生成”任务，并能看到整体的进度（例如，“正在生成第 5 / 30 章”）。

## Story 4.2: 实现动态工作流分支（修订与修正）

*   **As a** 系统,
*   **I want** 章节生成工作流能够根据评审结果动态地选择不同的执行路径,
*   **so that** 系统可以自动处理质量不佳或内容不一致的草稿，形成一个真正的纠错闭环。
*   **Acceptance Criteria:**
    1.  在Prefect的单章节工作流中，增加条件判断逻辑（Conditional Tasks）。
    2.  当“评论家Agent”的评分低于预设阈值（如7.0分）时，工作流必须自动触发一个“修订任务”，并将草稿和评论发送给一个“改写者Agent”。
    3.  当“事实核查员Agent”报告了内容不一致时，工作流必须自动触发一个“一致性修正任务”，并将草稿和不一致报告发送给“改写者Agent”。
    4.  “改写者Agent”完成修改后，会将修改后的草稿重新送回评审流程。
    5.  UI的监控视图需要能清晰地展示出当前章节正在经历“修订”或“修正”的状态。

## Story 4.3: 增强知识库的上下文检索能力

*   **As a** AI智能体,
*   **I want** 在开始工作前，能够从知识库中检索到与当前任务最相关的上下文信息,
*   **so that** 我可以做出更符合长期设定的决策，并保持故事的一致性。
*   **Acceptance Criteria:**
    1.  创建一个共享的“知识库服务”或在 `shared-types` 包中提供一个工具库。
    2.  该服务提供一个 `retrieve_context` 函数，输入为当前任务的描述（如“为第25章生成大纲”）。
    3.  该函数会执行以下操作：
        a. 从PostgreSQL中获取最新的世界观和角色卡。
        b. 从Milvus中对任务描述进行向量相似度搜索，找出最相关的3-5个历史章节的摘要。
    4.  所有核心执行Agent（大纲规划师、导演、角色专家、作家）在执行任务前，都必须调用此函数来获取上下文。
    5.  检索到的上下文将被注入到它们发送给大模型的Prompt中。

## Story 4.4: 实现基础的成本与性能监控

*   **As a** 监督者,
*   **I want** 在UI上看到一个基础的监控仪表盘，展示规模化生成过程中的关键指标,
*   **so that** 我可以评估系统的成本效益和运行稳定性。
*   **Acceptance Criteria:**
    1.  LiteLLM代理服务需要配置为将每次API调用的成本和耗时数据记录到PostgreSQL中。
    2.  API网关提供一个新的端点 `GET /metrics`。
    3.  该端点能聚合计算并返回以下指标：已生成的总字数、平均每万字API成本、平均章节生成时间、章节修订率。
    4.  前端应用中创建一个新的“监控”页面，以图表或数字的形式展示这些指标。
