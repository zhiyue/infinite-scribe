# Epic 5: 全功能长篇小说生成 (Full-Scale Novel Generation)

**目标:** 集成并启用所有高级功能（如图数据库的深度应用、高级智能体、动态工作流增强、人机反馈闭环），完成一部至少100万字的、高质量、高一致性的长篇小说生成，达到商业化交付标准。

## Story 5.1: Neo4j图数据库的深度应用与查询优化

*   **As a** 系统,
*   **I want** 充分利用Neo4j图数据库进行复杂的逻辑推理和关系查询,
*   **so that** 我可以为“事实核查员”和“剧情策划师”提供更深层次的一致性保证和剧情洞察。
*   **Acceptance Criteria:**
    1.  为Neo4j中的核心关系类型和节点属性创建复合索引以优化查询性能。
    2.  “事实核查员Agent”的逻辑被重构，以执行更复杂的Cypher查询来验证多跳关系和时间序列逻辑（例如，“A角色在事件X发生时，不可能在Y地点，因为他当时正与Z角色在Q地点互动”）。
    3.  “剧情策划师Agent”在进行战略评估时，会查询Neo4j以分析当前的角色关系网密度、关键情节节点的连接度等图特有的指标。
    4.  UI上提供一个更高级的知识图谱浏览器，允许用户在**隔离的数据库环境**中执行自定义的Cypher查询或通过预设模板探索图数据。

## Story 5.2: 开发并集成高级“叙事型”智能体

*   **As a** 剧情策划师,
*   **I want** 引入更专业的“叙事型”智能体来提升故事的复杂性和趣味性,
*   **so that** 生成的小说不再是平铺直叙，而是充满悬念和吸引力。
*   **Acceptance Criteria:**
    1.  开发并部署一个新的“**伏笔设计Agent (ForeshadowingAgent)**”。它会根据“剧情策划师”的长期指令，在当前章节中巧妙地植入一些看似无意、实则关键的细节或对话，并将其作为元数据记录在Neo4j中（例如，一个 `:PLANTED_FORESHADOW` 关系连接到章节节点）。
    2.  开发并部署一个新的“**情节反转Agent (PlotTwistAgent)**”。在关键的剧情节点，它会被激活，用于设计出人意料但又合乎逻辑的情节反转，并确保反转与Neo4j中已有的伏笔或角色动机相符。
    3.  Prefect工作流被更新，以包含调用这些高级智能体的可选阶段，这些阶段的触发可能由“剧情策划师”的指令或特定的故事里程碑决定。

## Story 5.3: 实现完整的人机反馈与精修闭环

*   **As a** 监督者,
*   **I want** 一个专门的UI界面来对已生成的章节进行精细化修改和批注，并将我的修改作为高质量数据反馈给系统,
*   **so that** 我可以对AI的创作进行最终的“润色”，并帮助系统学习我的偏好。
*   **Acceptance Criteria:**
    1.  在前端UI的章节阅读器中，增加一个“编辑模式”。
    2.  在编辑模式下，用户可以像在Word文档中一样，直接修改文本、添加批注。
    3.  当用户保存修改后，系统会创建一个新的 `chapter_versions` 记录，并将 `change_reason` 标记为“人工修改”，同时将原始版本和用户修改版一同存储。
    4.  API网关提供一个端点，用于接收这些“精修数据”。
    5.  （后MVP）这些高质量的对比数据将被用于未来对自研模型或微调模型的训练的准备工作。
    6.  工作流中增加一个“人工审核”状态，允许在发布前等待人类的最终批准。如果人工审核驳回，可以附带修改意见，触发“改写者Agent”进行定向修改。

## Story 5.4: 实现全面的可观测性与告警 (Langfuse集成)

*   **As a** 开发团队,
*   **I want** 将所有Agent的详细思考链、工具使用和API调用过程都集成到Langfuse中,
*   **so that** 我可以深入地调试任何一个Agent的行为，并对系统进行端到端的性能和质量追踪。
*   **Acceptance Criteria:**
    1.  在 `docker-compose.yml` 中添加并配置Langfuse服务。
    2.  所有Agent的核心逻辑都被Langfuse的SDK包裹，以追踪其执行过程（包括Prompt、LLM响应、Token使用情况）。
    3.  LiteLLM被配置为将其所有的请求/响应日志转发到Langfuse。
    4.  可以从Langfuse的UI中，清晰地看到从一个事件触发到最终章节生成的完整调用链和每个步骤的详细信息。
    5.  基于Langfuse收集的关键指标（如API调用失败率、内容生成一致性错误率、平均Token消耗）设置告警规则，并通过邮件或Slack通知开发团队。