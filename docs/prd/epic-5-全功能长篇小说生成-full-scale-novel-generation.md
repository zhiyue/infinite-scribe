# Epic 5: 全功能长篇小说生成 (Full-Scale Novel Generation)

**目标:** 集成并启用所有高级功能（如图数据库、高级智能体、动态工作流、人机反馈闭环），完成一部至少100万字的、高质量、高一致性的长篇小说生成，达到商业化交付标准。

## Story 5.1: 集成图数据库 (Neo4j) 用于关系管理

*   **As a** 系统,
*   **I want** 使用Neo4j图数据库来存储和管理所有实体（角色、地点、组织、物品）之间的复杂关系,
*   **so that** 我可以进行深度的关系查询，并为“事实核查员”提供更强大的逻辑一致性保证。
*   **Acceptance Criteria:**
    1.  在 `docker-compose.yml` 中添加并配置Neo4j服务。
    2.  创建一个“知识图谱服务”，负责将结构化数据（如新角色、角色间的互动事件）同步写入Neo4j。
    3.  例如，当“角色专家”设计了一个“K与银狐在酒吧对峙”的场景后，一个 `(K)-[:CONFRONTED_AT]->(Bar)<-[:CONFRONTED_AT]-(银狐)` 的关系会被添加到图中。
    4.  “事实核查员Agent”的逻辑被增强：在检查事实前，它会执行Cypher查询来验证关系逻辑（例如，查询“K是否已经认识银狐？”）。
    5.  UI上提供一个简单的界面，可以可视化展示核心角色的关系图。

## Story 5.2: 开发并集成高级“叙事型”智能体

*   **As a** 剧情策划师,
*   **I want** 引入更专业的“叙事型”智能体来提升故事的复杂性和趣味性,
*   **so that** 生成的小说不再是平铺直叙，而是充满悬念和吸引力。
*   **Acceptance Criteria:**
    1.  开发并部署一个新的“**伏笔设计Agent (ForeshadowingAgent)**”。它会根据“剧情策划师”的长期指令，在当前章节中巧妙地植入一些看似无意、实则关键的细节或对话。
    2.  开发并部署一个新的“**情节反转Agent (PlotTwistAgent)**”。在关键的剧情节点，它会被激活，用于设计出人意料但又合乎逻辑的情节反转。
    3.  Prefect工作流被更新，以包含调用这些高级智能体的可选阶段。

## Story 5.3: 实现完整的人机反馈与精修闭环

*   **As a** 监督者,
*   **I want** 一个专门的UI界面来对已生成的章节进行精细化修改和批注，并将我的修改作为高质量数据反馈给系统,
*   **so that** 我可以对AI的创作进行最终的“润色”，并帮助系统学习我的偏好。
*   **Acceptance Criteria:**
    1.  在前端UI的章节阅读器中，增加一个“编辑模式”。
    2.  在编辑模式下，用户可以像在Word文档中一样，直接修改文本、添加批注。
    3.  当用户保存修改后，系统会将“原始版本”和“用户修改版”一同存储。
    4.  API网关提供一个端点，用于接收这些“精修数据”。
    5.  （后MVP）这些高质量的对比数据将被用于未来对自研模型或微调模型的训练。
    6.  工作流中增加一个“人工审核”状态，允许在发布前等待人类的最终批准。

## Story 5.4: 实现全面的可观测性与告警

*   **As a** 开发团队,
*   **I want** 将所有Agent的详细思考链、工具使用和API调用过程都集成到Langfuse中,
*   **so that** 我可以深入地调试任何一个Agent的行为，并对系统进行端到端的性能和质量追踪。
*   **Acceptance Criteria:**
    1.  在 `docker-compose.yml` 中添加并配置Langfuse服务。
    2.  所有Agent的核心逻辑都被Langfuse的SDK包裹，以追踪其执行过程。
    3.  LiteLLM被配置为将其所有的请求/响应日志转发到Langfuse。
    4.  可以从Langfuse的UI中，清晰地看到从一个事件触发到最终章节生成的完整调用链。
    5.  基于关键指标（如API调用失败率、内容生成一致性错误率）设置告警规则。