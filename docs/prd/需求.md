# 需求

## 功能性需求 (Functional Requirements)

*   **FR1: (创世流程)** 系统必须提供一个由“世界铸造师Agent”主导的、与人类监督者进行对话式交互的创世流程，用于在项目开始前确定小说的核心设定（主题、世界观、核心角色、初始剧情）。
*   **FR2: (工作流编排)** 系统必须使用Prefect实现一个可根据任务结果进行分支的动态工作流，至少能处理标准路径、修订路径和一致性修正路径。
*   **FR3: (事件驱动)** 所有智能体服务之间必须通过事件总线（Kafka）进行异步通信，以实现服务解耦。
*   **FR4: (剧情策划)** “剧情策划师Agent”必须能够周期性或按需分析故事全局，并发布高层次的剧情指令（如引入新反派、开启新支线）。
*   **FR5: (大纲规划)** “大纲规划师Agent”必须能够接收高层剧情指令，并将其转化为具体的章节情节大纲。
*   **FR6: (场景设计)** “导演Agent”必须能够将章节大纲分解为带有节奏和视角设定的场景序列。
*   **FR7: (角色管理)** “角色专家Agent”必须能够按需创建新的角色卡，并规划已有角色在具体场景中的对话与互动。
*   **FR8: (世界观构建)** “世界观构建师Agent”必须能够根据创作需要，扩展或更新世界观设定，并将其持久化。
*   **FR9: (章节写作)** “作家Agent”必须能够综合导演和角色专家的指令，调用大模型API生成最终的章节草稿。
*   **FR10: (质量评审)** “评论家Agent”必须能够对章节草稿的文学质量、节奏和趣味性进行评估，并输出结构化的评分和评语。
*   **FR11: (一致性校验)** “事实核查员Agent”必须能够将章节草稿的内容与知识库中已确立的世界观、角色设定进行比对，并报告不一致之处。
*   **FR12: (Web UI)** 系统必须提供一个Web UI，其核心功能包括：
    *   一个“项目仪表盘/书籍列表”作为应用入口，展示所有已创建的书籍及其状态，并提供“创建新书籍”的入口。若无书籍，则引导用户创建。
    *   从项目仪表盘进入“项目详情页”，该页面包含针对特定书籍的左侧导航（如章节列表、知识库、监控、设置等），并提供触发章节生成、实时监控工作流状态、查看已生成章节内容的功能。
    *   在项目详情页的显著位置（如右上角）提供返回“项目仪表盘”或切换其他书籍的机制。
    *   支持用户启动“创世流程”以设定新书籍。
*   **FR13: (数据持久化)** 系统必须将所有生成的核心产物（章节、大纲、角色卡、世界观条目）和元数据持久化存储在PostgreSQL数据库和Minio对象存储中。
*   **FR14: (记忆与检索)** 系统必须能够将内容的关键信息（如章节摘要、角色简介）生成向量嵌入并存储在Milvus中。智能体在为特定书籍工作时，其上下文检索应**优先或限定**在该书籍关联的知识库范围内，以确保检索到的信息高度相关。
*   **FR15: (控制API)** 系统必须提供一个基于FastAPI的、安全的RESTful“控制API”，作为前端UI与后端工作流系统的交互入口。
*   **FR16: (API指令功能)** 控制API必须提供以下指令性端点(Endpoints)：
    *   一个用于启动“创世流程”的端点。
    *   一个用于启动指定小说“章节生成流程”的端点。
*   **FR17: (API查询功能)** 控制API必须提供以下查询性端点：
    *   一个用于根据任务ID查询工作流当前状态的端点。
    *   一个用于获取已生成章节列表及内容的端点。
    *   一个用于获取所有书籍项目列表及其概况的端点。

## 非功能性需求 (Non-Functional Requirements)

*   **NFR1:** 所有智能体之间的内部通信**必须**通过事件总线（Kafka）进行，以确保服务的松耦合和可扩展性。
*   **NFR2:** 所有对大语言模型的API调用**必须**通过LiteLLM代理服务，以实现统一的成本控制、日志记录和模型切换。
*   **NFR3:** 后端服务**必须**使用Python语言，并基于FastAPI和Pydantic进行开发，以保证类型安全和高性能。
*   **NFR4:** 前端监控界面**必须**使用React、TypeScript、Vite和Shadcn UI等指定的技术栈构建。
*   **NFR5:** 系统**必须**能够追踪并报告每万字的平均API调用成本，以确保其维持在预算范围内。
*   **NFR6:** 所有核心服务（智能体、API等）**必须**被容器化（例如使用Docker），以实现环境一致性和部署便捷性。
*   **NFR7:** 系统**必须**为所有关键操作（如事件发布、任务完成、API调用失败）提供结构化的日志，以便于调试和监控。
*   **NFR8:** 控制API必须提供自动生成的、符合OpenAPI 3.0规范的交互式API文档（例如通过Swagger UI或Redoc）。
*   **NFR9:** 所有对控制API的访问必须经过身份验证和授权，确保只有合法的用户才能触发和查询任务。
