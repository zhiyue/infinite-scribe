# 需求


## **核心架构原则**
*   **FR-A1 (统一领域事件):** 系统**必须**建立一个统一的、只增不减的领域事件日志（`domain_events`表），作为整个系统所有业务事实的唯一来源。所有状态变更都必须由一个已记录的领域事件触发。
*   **FR-A2 (命令与幂等性):** 对于所有需要触发异步、耗时操作的用户意图，系统**必须**使用“命令收件箱”（`command_inbox`表）模式。通过数据库唯一性约束来保证命令的幂等性，从根本上防止重复提交。
*   **FR-A3 (通用异步任务):** 系统**必须**提供一个通用的异步任务表（`async_tasks`），用于追踪所有后台技术任务（如调用LLM）的执行状态、进度和结果。
*   **FR-A4 (可靠事件发布):** 系统中所有需要在完成本地数据库事务后发布Kafka消息的服务，**必须**采用“事务性发件箱”（`event_outbox`表）模式，以保证数据库写入与消息发布的原子性。
*   **FR-A5 (工作流编排):** 系统**必须**使用Prefect作为核心工作流编排引擎，负责监听业务事件并执行复杂的、多步骤的业务流程。
*   **FR-A6 (非阻塞等待):** Prefect工作流**必须**能够通过持久化的回调机制（使用`flow_resume_handles`表和Redis缓存）来处理需要等待外部事件（如用户反馈）的场景，实现非阻塞式等待。

## 功能性需求 (Functional Requirements)

*   **FR1:** 系统必须提供一个**支持双入口模式的、AI驱动的创世工作室**。该流程必须支持以下两种启动路径：
    *   **路径A (零输入启动):** 用户无需提供任何初始想法，系统可完全由AI生成一套完整的小说核心概念（主题、立意、类型、背景）草案。
    *   **路径B (有输入启动):** 用户可以输入一个或多个初步创意（如主题、一句话简介），系统将基于此输入进行扩展、增强和完善，生成核心概念草案。
    无论通过何种路径确立了核心概念，后续的**世界观、角色和初始大纲的生成与迭代式反馈流程都必须保持一致**。流程结束后，系统需在PostgreSQL中创建记录，并为该小说在Neo4j中创建一个独立的、物理隔离的图数据库。
    ***(实现说明: 此流程将由FR-A5和FR-A6中定义的Prefect工作流进行编排，并能处理等待用户输入的暂停。)***
*   **FR2:** 系统必须使用Prefect实现一个可根据任务结果进行分支的动态工作流，至少能处理标准路径、修订路径和一致性修正路径。
    ***(实现说明: 此需求是FR-A5架构原则的具体应用。)***
*   **FR3:** 所有智能体服务之间必须通过事件总线（Kafka）进行异步通信，以实现服务解耦。
    ***(实现说明: 此需求由FR-A4的“事务性发件箱”架构原则来保证其可靠实现。)***
*   **FR4:** “剧情策划师Agent”必须能够周期性或按需分析故事全局，并发布高层次的剧情指令（如引入新反派、开启新支线）。
*   **FR5:** “大纲规划师Agent”必须能够接收高层剧情指令，并将其转化为具体的章节情节大纲。
*   **FR6:** “导演Agent”必须能够将章节大纲分解为带有节奏和视角设定的场景序列。
*   **FR7:** “角色专家Agent”必须能够按需创建新的角色卡，并规划已有角色在具体场景中的对话与互动。
*   **FR8:** “世界观构建师Agent”必须能够根据创作需要，扩展或更新世界观设定，并将其持久化。
*   **FR9:** “作家Agent”必须能够综合导演和角色专家的指令，调用大模型API生成最终的章节草稿。
*   **FR10:** “评论家Agent”必须能够对章节草稿的文学质量、节奏和趣味性进行评估，并输出结构化的评分和评语。
*   **FR11:** “事实核查员Agent”必须能够将章节草稿的内容与**该小说专属的知识库（PG属性和Neo4j图谱）**中已确立的世界观、角色设定进行比对，并报告不一致之处。
*   **FR12:** 系统必须提供一个Web UI，其核心功能包括：
    *   一个“项目仪表盘/书籍列表”作为应用入口，展示所有已创建的书籍及其状态，并提供“创建新书籍”的入口。若无书籍，则引导用户创建。
    *   从项目仪表盘进入“项目详情页”，该页面包含针对特定书籍的左侧导航（如章节列表、知识库、监控、设置等），并提供触发章节生成、实时监控工作流状态、查看已生成章节内容的功能。
    *   在项目详情页的显著位置（如右上角）提供返回“项目仪表盘”或切换其他书籍的机制。
    *   支持用户启动“创世流程”以设定新书籍。
*   **FR13:** 系统必须将所有生成的核心产物（章节、大纲、角色卡、世界观条目）和元数据持久化存储在PostgreSQL数据库和Minio对象存储中。
    ***(实现说明: 此需求由FR-A1的事件溯源模式和具体Agent的实现来保证，确保所有产物都有对应的领域事件记录。)***
*   **FR14:** 系统必须能够将内容的关键信息（如章节摘要、角色简介）生成向量嵌入并存储在Milvus中。智能体在为特定书籍工作时，其上下文检索**必须限定**在该书籍关联的知识库范围内（包括PG表、Neo4j图数据库和Milvus集合），以确保检索到的信息高度相关且无数据串扰。
*   **FR15:** 系统必须提供一个基于FastAPI的、安全的RESTful“控制API”，作为前端UI与后端工作流系统的交互入口。
    ***(实现说明: 根据FR-A2，此API将主要基于命令模式进行交互。)***
*   **FR16:** 控制API必须提供以下指令性端点(Endpoints)：
    *   一个用于启动“创世流程”的端点。
    *   一个用于启动指定小说“章节生成流程”的端点。
    ***(修订说明: 这些特定的端点将被一个更通用的、基于命令的端点（如`POST /.../commands`）所取代或封装，以符合FR-A2的架构原则。)***
*   **FR17:** 控制API必须提供以下查询性端点和**一个服务器发送事件（SSE）流式端点**：
    *   一个用于获取已生成章节列表及内容的端点。
    *   一个用于获取所有书籍项目列表及其概况的端点。
    *   **一个用于订阅实时事件的SSE端点 (`/events/stream`)**，服务器通过此端点向客户端实时推送工作流状态和章节状态的更新。
*   **FR18:** 系统必须为核心创作产物（特别是章节）提供版本控制。每次由AI（如`RewriterAgent`）进行的修改都应生成一个新版本，并记录修改原因和操作者，旧版本应可追溯。
*   **FR19:** 系统必须将工作流的运行实例、任务状态以及Agent的关键活动持久化到数据库中，以便进行详细的审计、调试和性能分析。
    ***(实现说明: 此需求将通过Prefect的数据库、`async_tasks`表和`domain_events`表共同实现。)***

## 非功能性需求 (Non-Functional Requirements)

*   **NFR1:** 所有智能体之间的内部通信**必须**通过事件总线（Kafka）进行，以确保服务的松耦合和可扩展性。
*   **NFR2:** 所有对大语言模型的API调用**必须**通过LiteLLM代理服务，以实现统一的成本控制、日志记录和模型切换。
*   **NFR3:** 后端服务**必须**使用Python语言，并基于FastAPI和Pydantic进行开发，以保证类型安全和高性能。
*   **NFR4:** 前端监控界面**必须**使用React、TypeScript、Vite和Shadcn UI等指定的技术栈构建。
*   **NFR5:** 系统**必须**能够追踪并报告每万字的平均API调用成本，并能归因到具体的Agent活动，以确保其维持在预算范围内。
*   **NFR6:** 所有核心服务（智能体、API等）**必须**被容器化（例如使用Docker），以实现环境一致性和部署便捷性。
*   **NFR7:** 系统**必须**为所有关键操作（如事件发布、任务完成、API调用失败）提供结构化的日志，以便于调试和监控。
*   **NFR8:** 控制API必须提供自动生成的、符合OpenAPI 3.0规范的交互式API文档（例如通过Swagger UI或Redoc）。
*   **NFR9:** 所有对控制API的访问必须经过身份验证和授权，确保只有合法的用户才能触发和查询任务。
*   **NFR10:** 每个小说项目的知识图谱数据**必须**在数据库层面进行物理隔离（例如，在Neo4j中使用独立的数据库），以防止数据串扰和性能干扰。
