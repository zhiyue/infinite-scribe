# Story 3.2: Multi-Agent Dialogue System for Novel Genesis

## Status: In Progress

## Story

- As a **小说创作者**
- I want **一个专业化的多智能体系统，通过不同职责的AI Agent协作完成对话式创世流程**
- so that **我可以享受到专家级团队的创作支持，每个Agent在其专业领域提供高质量的内容生成和建议**

## Acceptance Criteria (ACs)

1. **[Given]** 创世阶段启动 **[When]** 需要特定专业内容 **[Then]** 系统必须能够调用相应的专业Agent（世界铸造师、剧情策划师、角色专家等）。
2. **[Then]** 每个Agent必须具有明确的职责定义和专业能力边界。
3. **[Then]** Agent之间必须能够通过事件总线进行异步通信和协作。
4. **[Given]** Agent生成内容 **[When]** 内容需要其他Agent审核 **[Then]** 系统必须支持Agent间的协作评审流程。
5. **[Then]** 所有Agent的交互历史必须可追踪和可审计。
6. **[Then]** Agent必须能够访问和更新共享的知识库，保持创作一致性。

## Tasks / Subtasks

- [ ] Task 1: 核心Agent架构设计 (AC: 1, 2, 3)
  - [ ] Subtask 1.1: 实现BaseAgent基类，定义Agent通用接口和行为
  - [ ] Subtask 1.2: 配置Kafka Agent通信机制，支持异步消息传递
  - [ ] Subtask 1.3: 实现Agent注册和发现服务
  - [ ] Subtask 1.4: 创建Agent状态管理和监控系统

- [ ] Task 2: 战略层Agent实现 (AC: 1, 2, 6)
  - [ ] Subtask 2.1: 实现Worldsmith Agent（世界铸造师）- 创世阶段主导者
    - 职责：与人类协作完成故事初始设定，引导整个创世流程
    - 能力：多轮对话管理、设定整合、方案推荐
  - [ ] Subtask 2.2: 实现PlotMaster Agent（剧情策划师）- 战略层规划
    - 职责：审视故事全局，发布高层次剧情走向指令
    - 能力：故事结构分析、剧情弧光设计、节奏控制

- [ ] Task 3: 战术层Agent实现 (AC: 1, 2, 6)
  - [ ] Subtask 3.1: 实现Outliner Agent（大纲规划师）
    - 职责：根据剧情指令设计具体章节大纲
    - 能力：情节细化、冲突设计、节点规划
  - [ ] Subtask 3.2: 实现Director Agent（导演）
    - 职责：将章节大纲分解为场景序列，设定节奏和视角
    - 能力：场景编排、镜头语言、节奏把控
  - [ ] Subtask 3.3: 集成现有Agent框架到创世流程

- [ ] Task 4: 执行层Agent实现 (AC: 1, 2, 6)
  - [ ] Subtask 4.1: 实现CharacterExpert Agent（角色专家）
    - 职责：创建新角色、规划角色互动、生成对话
    - 能力：8维度角色设计、关系网络构建、对话生成
  - [ ] Subtask 4.2: 实现WorldBuilder Agent（世界观构建师）
    - 职责：扩展世界观设定、确保设定一致性
    - 能力：5维度世界观构建、规则体系设计、设定验证
  - [ ] Subtask 4.3: 实现Writer Agent（作家）
    - 职责：根据指令将场景渲染成最终章节草稿
    - 能力：文本生成、风格控制、细节描写

- [ ] Task 5: 审查层Agent实现 (AC: 4, 5, 6)
  - [ ] Subtask 5.1: 实现Critic Agent（评论家）
    - 职责：评估草稿的文学质量、节奏和趣味性
    - 能力：多维质量评分、反馈生成、改进建议
  - [ ] Subtask 5.2: 实现FactChecker Agent（事实核查员）
    - 职责：检查内容与知识库既定事实的一致性
    - 能力：一致性验证、冲突识别、修正建议
  - [ ] Subtask 5.3: 实现Rewriter Agent（改写者）
    - 职责：根据评审反馈改写和优化内容
    - 能力：内容重构、质量提升、风格统一

- [ ] Task 6: Agent协作工作流 (AC: 3, 4, 5)
  - [ ] Subtask 6.1: 设计Agent任务分发和结果收集机制
  - [ ] Subtask 6.2: 实现Agent间评审和反馈闭环
  - [ ] Subtask 6.3: 创建Agent交互审计和日志系统
  - [ ] Subtask 6.4: 集成Prefect编排器管理Agent工作流

## Dev Technical Guidance

### Previous Story Insights
- Story 3.1已建立创世阶段核心系统的数据基础设施
- BaseAgent框架已存在，需要扩展到创世阶段专用Agent
- Kafka事件总线已配置，支持Agent间异步通信
- 知识库服务（Neo4j + Milvus）已就绪，可供Agent访问

### Data Models

**Agent Configuration Models**:
```python
class AgentConfig(BaseModel):
    agent_id: UUID
    agent_type: AgentType  # WORLDSMITH, PLOTMASTER, OUTLINER, etc.
    capabilities: List[str]
    status: AgentStatus    # AVAILABLE, BUSY, OFFLINE
    max_concurrent_tasks: int
    specialized_domains: List[str]

class AgentTask(BaseModel):
    task_id: UUID
    agent_id: UUID
    task_type: str
    input_data: Dict[str, Any]
    context: Dict[str, Any]
    priority: int
    status: TaskStatus     # PENDING, ASSIGNED, IN_PROGRESS, COMPLETED, FAILED
    created_at: datetime
    assigned_at: Optional[datetime]
    completed_at: Optional[datetime]
```

**Agent Communication Events**:
```python
class AgentTaskRequest(BaseEvent):
    event_type: str = "agent.task.request"
    target_agent: AgentType
    task_data: Dict[str, Any]
    correlation_id: UUID

class AgentTaskCompleted(BaseEvent):
    event_type: str = "agent.task.completed"
    agent_id: UUID
    task_result: Dict[str, Any]
    quality_score: Optional[float]
    correlation_id: UUID
```

### API Specifications

**Agent Management Endpoints**:
```
GET /api/agents                     # 获取所有Agent状态
GET /api/agents/{agent_id}/status   # 获取特定Agent状态
POST /api/agents/{agent_id}/tasks   # 分配任务给Agent
GET /api/agents/{agent_id}/tasks    # 获取Agent任务历史
```

**Agent Communication Endpoints** (Internal):
```
POST /internal/agents/task-request  # Agent间任务请求
POST /internal/agents/task-result   # Agent任务结果提交
GET /internal/agents/context/{session_id}  # 获取上下文信息
```

### Component Specifications

**Agent Base Classes**:
```python
class BaseGenesisAgent(BaseAgent):
    """创世阶段专用Agent基类"""
    def __init__(self, agent_config: AgentConfig):
        super().__init__(agent_config)
        self.knowledge_service = KnowledgeGraphService()
        self.embedding_service = EmbeddingService()
    
    async def process_genesis_task(self, task: AgentTask) -> AgentTaskResult:
        """处理创世阶段任务的抽象方法"""
        pass
    
    async def get_relevant_context(self, session_id: UUID) -> Dict[str, Any]:
        """获取相关上下文信息"""
        pass
```

**Specialized Agent Implementations**:
- `WorldsmithAgent`: 继承BaseGenesisAgent，专门处理创世对话
- `PlotMasterAgent`: 战略层剧情规划专家
- `OutlinerAgent`: 章节大纲设计专家
- `CharacterExpertAgent`: 角色创建和互动专家
- `WorldBuilderAgent`: 世界观构建专家
- `CriticAgent`: 内容质量评估专家
- `FactCheckerAgent`: 一致性检查专家

### File Locations

**Agent实现目录结构**:
```
/apps/backend/src/agents/
├── base/
│   ├── __init__.py
│   ├── base_genesis_agent.py
│   └── agent_config.py
├── worldsmith/
│   ├── __init__.py
│   ├── main.py
│   └── worldsmith_agent.py
├── plotmaster/
├── outliner/
├── character_expert/
├── world_builder/
├── critic/
└── fact_checker/
```

**Agent配置和编排**:
```
/apps/backend/src/genesis/
├── orchestrator.py        # Agent编排器
├── task_dispatcher.py     # 任务分发器
├── context_manager.py     # 上下文管理器
└── quality_evaluator.py   # 质量评估器
```

### Testing Requirements

**单元测试**:
- 每个Agent的专业能力测试
- Agent任务处理逻辑测试
- 知识库访问和更新测试

**集成测试**:
- Agent间协作流程测试
- 端到端创世流程Agent参与测试
- Kafka事件传递和处理测试
- 知识库一致性维护测试

**性能测试**:
- Agent并发处理能力测试
- 任务分发和结果收集性能测试
- 大规模Agent集群负载测试

### Technical Constraints

- Agent通信必须完全通过Kafka事件总线，禁止直接HTTP调用
- 每个Agent必须是无状态的，所有状态存储在数据库中
- Agent必须支持容错和自动重启机制
- Agent的LLM调用必须通过LiteLLM代理进行成本控制
- 所有Agent交互必须可观测，集成Langfuse监控

## Dev Notes

### Testing

**Agent专业能力测试场景**:
- [ ] Worldsmith Agent: 创世对话引导和设定整合能力
- [ ] PlotMaster Agent: 故事结构分析和剧情弧光设计
- [ ] CharacterExpert Agent: 8维度角色设计和关系网络构建
- [ ] WorldBuilder Agent: 5维度世界观构建和一致性维护
- [ ] Critic Agent: 多维质量评分和改进建议生成
- [ ] FactChecker Agent: 一致性验证和冲突识别

**Agent协作测试场景**:
1. 创世流程完整协作：Worldsmith → PlotMaster → Outliner → Director → CharacterExpert → WorldBuilder → Writer → Critic → FactChecker
2. 反馈闭环测试：Critic给出低分 → Rewriter改写 → 重新评估
3. 一致性修正测试：FactChecker发现冲突 → WorldBuilder修正设定 → 重新验证

### Architecture Integration

**与现有系统集成点**:
- 复用现有BaseAgent框架和Kafka通信机制
- 扩展现有KnowledgeGraphService支持Agent专用查询
- 集成Prefect工作流编排Agent任务序列
- 利用现有SSE服务推送Agent状态更新

**性能考虑**:
- Agent池化管理，避免频繁启动销毁
- 智能任务路由，优化Agent负载均衡
- 上下文缓存策略，减少重复数据库查询
- 批量处理机制，提高吞吐量

## Dev Agent Record

### Agent Model Used: Claude Opus 4.1

### Implementation Strategy

**分层实现策略**:
1. **Phase 1**: 实现核心Agent基础设施和BaseGenesisAgent
2. **Phase 2**: 实现战略层Agent（Worldsmith, PlotMaster）
3. **Phase 3**: 实现战术层和执行层Agent
4. **Phase 4**: 实现审查层Agent和协作工作流

**技术决策**:
- 采用事件驱动架构确保Agent间松耦合
- 使用Pydantic严格类型检查Agent通信协议
- 实现Agent健康检查和自动恢复机制
- 集成分布式追踪跟踪跨Agent任务流

### Quality Assurance

**代码质量要求**:
- 每个Agent类不超过400行，遵循单一职责原则
- 所有Agent方法必须有完整的类型注解
- Agent配置必须外部化，支持动态调整
- 错误处理必须优雅，避免级联失败

**监控和可观测性**:
- 集成Langfuse监控所有Agent LLM调用
- 实现Agent性能指标收集和告警
- 提供Agent协作可视化工具
- 建立Agent质量评估体系

### Change Log

| Date | Version | Description | Author |
| :--- | :------ | :---------- | :----- |
| 2025-09-05 | 1.0.0 | Multi-Agent系统设计文档创建 | Dev Agent |

## QA Results

**设计验证状态**:
- ⏳ Agent架构设计评审：待技术团队评审
- ⏳ 协作流程设计验证：待原型验证
- ⏳ 性能模型评估：待压力测试验证

**风险评估**:
- ⚠️  Agent间通信复杂度可能导致调试困难
- ⚠️  多Agent协作可能增加系统响应延迟
- ✅ 事件驱动架构提供良好的扩展性和容错性