# Story 3.1: Novel Genesis Stage Core System

## Status: In Progress

## Story

- As a **InfiniteScribeç”¨æˆ·**
- I want **ä¸€ä¸ªå¯¹è¯å¼çš„å°è¯´åˆ›ä¸–é˜¶æ®µç³»ç»Ÿï¼Œé€šè¿‡6ä¸ªæ¸è¿›å¼é˜¶æ®µå®Œæˆå°è¯´åˆ›ä½œå‰çš„ä¸–ç•Œè§‚æ„å»º**
- so that **æˆ‘å¯ä»¥é€šè¿‡ä¸AIçš„å¯¹è¯åä½œï¼Œç³»ç»ŸåŒ–åœ°åˆ›å»ºå®Œæ•´çš„å°è¯´åŸºç¡€è®¾å®šï¼Œä¸ºåç»­åˆ›ä½œæä¾›åšå®çš„åŸºç¡€**

## Acceptance Criteria (ACs)

1. **[Given]** åˆ›ä¸–é˜¶æ®µç³»ç»Ÿå¯åŠ¨ **[When]** ç”¨æˆ·å¼€å§‹æ–°çš„å°è¯´é¡¹ç›® **[Then]** ç³»ç»Ÿå¿…é¡»æä¾›6ä¸ªæ¸è¿›å¼é˜¶æ®µçš„å¼•å¯¼æµç¨‹ï¼ˆStage 0-5ï¼‰ã€‚
2. **[Then]** æ¯ä¸ªé˜¶æ®µå¿…é¡»æ”¯æŒå¯¹è¯å¼äº¤äº’ï¼ŒAIä¸»å¯¼ç”Ÿæˆå†…å®¹ï¼Œç”¨æˆ·è¿›è¡Œå®¡æ ¸å’Œå¾®è°ƒã€‚
3. **[Then]** ç³»ç»Ÿå¿…é¡»èƒ½å¤Ÿåœ¨å„ä¸ªé˜¶æ®µä¹‹é—´ç»´æŠ¤æ•°æ®ä¸€è‡´æ€§å’Œä¸Šä¸‹æ–‡è¿ç»­æ€§ã€‚
4. **[Given]** å®Œæˆä»»ä¸€é˜¶æ®µ **[When]** ç”Ÿæˆçš„å†…å®¹å­˜å‚¨åˆ°çŸ¥è¯†åº“ **[Then]** åç»­é˜¶æ®µå¿…é¡»èƒ½å¤Ÿè®¿é—®å¹¶åŸºäºä¹‹å‰çš„è®¾å®šè¿›è¡Œåˆ›ä½œã€‚
5. **[Then]** ç³»ç»Ÿå¿…é¡»æä¾›å®æ—¶çŠ¶æ€æ›´æ–°å’Œè¿›åº¦è·Ÿè¸ªåŠŸèƒ½ã€‚
6. **[Then]** ç”¨æˆ·å¿…é¡»èƒ½å¤Ÿå¯¹AIç”Ÿæˆçš„å†…å®¹è¿›è¡Œ"æ¥å—/ä¿®æ”¹/é‡æ–°ç”Ÿæˆ"ä¸‰é”®æ“ä½œã€‚

## Tasks / Subtasks

- [x] Task 1: å»ºç«‹æ•°æ®åº“æ¨¡å¼å’Œæ ¸å¿ƒè¡¨ç»“æ„ (AC: 1, 3, 4)
  - [x] Subtask 1.1: åˆ›å»ºPostgreSQLæ ¸å¿ƒå¯¹è¯è¡¨ï¼ˆconversation_sessions, conversation_roundsï¼‰
  - [x] Subtask 1.2: å®ç°CQRSå‘½ä»¤å’Œäº‹ä»¶è¡¨ï¼ˆcommand_inbox, domain_events, event_outboxï¼‰
  - [x] Subtask 1.3: é…ç½®Neo4jå›¾æ•°æ®åº“èŠ‚ç‚¹ç±»å‹ï¼ˆNovel, Character, WorldRuleç­‰ï¼‰
  - [x] Subtask 1.4: è®¾ç½®Milvuså‘é‡æ•°æ®åº“é›†åˆï¼ˆnovel_embeddings_v1ï¼Œ768ç»´ï¼‰
  - [x] Subtask 1.5: é…ç½®Redisç¼“å­˜ç»“æ„ï¼ˆä¼šè¯ç¼“å­˜ï¼Œ30å¤©TTLï¼‰

- [x] Task 2: Neo4jå›¾æ•°æ®åº“æ¨¡å¼å®ç° (AC: 3, 4) - 85% Complete
  - [x] Subtask 2.1: åˆ›å»ºNovelèŠ‚ç‚¹ç±»å‹å¹¶è®¾ç½®å±æ€§çº¦æŸ
  - [x] Subtask 2.2: åˆ›å»ºCharacterèŠ‚ç‚¹ç±»å‹å¹¶å®šä¹‰8ç»´åº¦å±æ€§ï¼ˆå¤–è²Œã€æ€§æ ¼ã€èƒŒæ™¯ã€åŠ¨æœºã€ç›®æ ‡ã€éšœç¢ã€è½¬æŠ˜ã€å¿ƒç»“ï¼‰
  - [x] Subtask 2.3: åˆ›å»ºWorldRuleèŠ‚ç‚¹ç±»å‹å¹¶å®šä¹‰5ç»´åº¦ä¸–ç•Œè§‚å±æ€§
  - [x] Subtask 2.4: åˆ›å»ºLocationã€Itemã€Organizationã€EventèŠ‚ç‚¹ç±»å‹
  - [ ] Subtask 2.5: å®šä¹‰å®Œæ•´çš„Neo4jå…³ç³»ç±»å‹å’ŒèŠ‚ç‚¹é—´çº¦æŸ

- [ ] Task 3: åˆ›ä¸–é˜¶æ®µçŠ¶æ€æœºå®ç° (AC: 1, 2, 5)
  - [ ] Subtask 3.1: å®ç°6é˜¶æ®µçŠ¶æ€è½¬æ¢é€»è¾‘ï¼ˆCONCEPT_SELECTION â†’ STORY_CONCEPTION â†’ WORLDVIEW â†’ CHARACTERS â†’ PLOT_OUTLINE â†’ FINISHEDï¼‰
  - [ ] Subtask 3.2: åˆ›å»ºGenesisSessionå®ä½“ç®¡ç†é˜¶æ®µçŠ¶æ€å’Œè¿›åº¦
  - [ ] Subtask 3.3: å®ç°é˜¶æ®µé—´æ•°æ®ä¼ é€’å’Œä¸Šä¸‹æ–‡ç»´æŠ¤æœºåˆ¶
  - [ ] Subtask 3.4: æ·»åŠ é˜¶æ®µå®ŒæˆéªŒè¯å’Œè´¨é‡æ£€æŸ¥é€»è¾‘

- [ ] Task 4: å¯¹è¯å¼äº¤äº’ç•Œé¢ (AC: 2, 6)
  - [ ] Subtask 4.1: å®ç°SSE(Server-Sent Events)å®æ—¶æ¨é€æœåŠ¡
  - [ ] Subtask 4.2: åˆ›å»ºReactå‰ç«¯åˆ›ä¸–é˜¶æ®µå‘å¯¼ç»„ä»¶
  - [ ] Subtask 4.3: å®ç°ä¸‰é”®æ“ä½œç•Œé¢ï¼ˆæ¥å—/ä¿®æ”¹/é‡æ–°ç”Ÿæˆï¼‰
  - [ ] Subtask 4.4: æ·»åŠ é˜¶æ®µè¿›åº¦å¯è§†åŒ–ç»„ä»¶

- [ ] Task 5: çŸ¥è¯†åº“é›†æˆ (AC: 4)
  - [ ] Subtask 5.1: å®ç°å‘é‡åµŒå…¥è‡ªåŠ¨ç”Ÿæˆå’Œå­˜å‚¨
  - [ ] Subtask 5.2: åˆ›å»ºçŸ¥è¯†åº“æŸ¥è¯¢å’Œæ£€ç´¢æ¥å£
  - [ ] Subtask 5.3: å®ç°è·¨é˜¶æ®µå†…å®¹å…³è”å’Œå¼•ç”¨
  - [ ] Subtask 5.4: æ·»åŠ çŸ¥è¯†åº“æ•°æ®å¯¼å‡ºåŠŸèƒ½

## Dev Technical Guidance

### Previous Story Insights
- Story 2.1å·²å®Œæˆç»Ÿä¸€é¢†åŸŸäº‹ä»¶ä¸å‘½ä»¤æ¨¡å¼çš„æ•°æ®æ¨¡å‹
- PostgreSQLæ•°æ®åº“å·²é…ç½®ï¼ŒåŒ…å«CQRSç›¸å…³è¡¨ç»“æ„
- Docker ComposeåŸºç¡€æ¶æ„å·²å®Œå¤‡ï¼Œæ”¯æŒå¤šæ•°æ®åº“é›†æˆ
- API GatewayæœåŠ¡è¿è¡Œåœ¨`http://192.168.2.201:8000`

### Data Models

åŸºäºADRå†³ç­–çš„æ ¸å¿ƒæ•°æ®æ¨¡å‹ï¼š

**Genesis Session Model** (åŸºäºADR-001å¯¹è¯çŠ¶æ€ç®¡ç†):
```python
class GenesisSession(BaseModel):
    id: UUID
    user_id: UUID
    status: GenesisStatus  # IN_PROGRESS, COMPLETED, ABANDONED
    stage: GenesisStage    # CONCEPT_SELECTION, STORY_CONCEPTION, etc.
    novel_metadata: Dict[str, Any]
    created_at: datetime
    updated_at: datetime
```

**Conversation Models** (å¤ç”¨ç°æœ‰conversation_sessionsè¡¨):
```python
class ConversationSession(BaseModel):
    scope_type: str = "GENESIS"  # æ ‡è¯†ä¸ºåˆ›ä¸–é˜¶æ®µå¯¹è¯
    scope_id: UUID               # å…³è”åˆ°GenesisSession.id
```

**Knowledge Graph Nodes** (åŸºäºADR-005çŸ¥è¯†å›¾è°±Schema):
- `Novel`: å°è¯´åŸºæœ¬ä¿¡æ¯èŠ‚ç‚¹
- `Character`: è§’è‰²èŠ‚ç‚¹ï¼ˆ8ç»´åº¦å±æ€§ï¼‰
- `WorldRule`: ä¸–ç•Œè§‚è§„åˆ™èŠ‚ç‚¹ï¼ˆ5ç»´åº¦å±æ€§ï¼‰
- `Location`, `Item`, `Organization`, `Event`: æ‰©å±•èŠ‚ç‚¹ç±»å‹

### API Specifications

**Core Genesis Endpoints**:
```
POST /api/genesis/sessions          # åˆ›å»ºæ–°çš„åˆ›ä¸–ä¼šè¯
GET /api/genesis/sessions/{id}      # è·å–åˆ›ä¸–ä¼šè¯çŠ¶æ€
POST /api/genesis/sessions/{id}/advance  # æ¨è¿›åˆ°ä¸‹ä¸€é˜¶æ®µ
POST /api/genesis/sessions/{id}/interact # é˜¶æ®µå†…å¯¹è¯äº¤äº’
```

**SSE Endpoint**:
```
GET /api/genesis/sessions/{id}/events    # SSEäº‹ä»¶æµ
```

### Component Specifications

**Frontend Components**:
- `GenesisWizard`: ä¸»åˆ›ä¸–å‘å¯¼ç»„ä»¶
- `StageProgress`: é˜¶æ®µè¿›åº¦æ˜¾ç¤ºç»„ä»¶  
- `ConversationPanel`: å¯¹è¯äº¤äº’é¢æ¿
- `ContentReviewPanel`: å†…å®¹å®¡æ ¸ä¸‰é”®æ“ä½œç»„ä»¶

**Backend Services**:
- `GenesisOrchestrator`: åˆ›ä¸–æµç¨‹ç¼–æ’æœåŠ¡
- `StageManager`: é˜¶æ®µçŠ¶æ€ç®¡ç†æœåŠ¡
- `ConversationService`: å¯¹è¯äº¤äº’æœåŠ¡ï¼ˆå¤ç”¨ç°æœ‰ï¼‰
- `KnowledgeGraphService`: å›¾æ•°æ®åº“æ“ä½œæœåŠ¡ï¼ˆå¤ç”¨ç°æœ‰ï¼‰

### File Locations

åŸºäºç»Ÿä¸€åç«¯æ¶æ„ï¼š
- Backend Core: `/apps/backend/src/genesis/`
- Agent Services: `/apps/backend/src/agents/worldsmith/`
- Frontend: `/apps/frontend/src/pages/genesis/`
- Shared Types: `/packages/shared-types/src/genesis/`

### Testing Requirements

**å•å…ƒæµ‹è¯•**:
- GenesisSessionçŠ¶æ€è½¬æ¢é€»è¾‘
- é˜¶æ®µå®ŒæˆéªŒè¯ç®—æ³•
- çŸ¥è¯†åº“æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥

**é›†æˆæµ‹è¯•**:
- å®Œæ•´åˆ›ä¸–æµç¨‹ç«¯åˆ°ç«¯æµ‹è¯•
- å¤šæ•°æ®åº“äº‹åŠ¡ä¸€è‡´æ€§æµ‹è¯•
- SSEå®æ—¶æ›´æ–°åŠŸèƒ½æµ‹è¯•

### Technical Constraints

- å¿…é¡»éµå¾ªCQRS+äº‹ä»¶æº¯æº+Outboxæ¨¡å¼ (ADR-003)
- å¯¹è¯çŠ¶æ€å¿…é¡»æ”¯æŒRedisç¼“å­˜+PostgreSQLæŒä¹…åŒ– (ADR-001)
- å‘é‡åµŒå…¥å¿…é¡»ä½¿ç”¨Qwen3-Embedding 0.6Bæ¨¡å‹ (ADR-002)
- å†…å®¹ç‰ˆæœ¬æ§åˆ¶å¿…é¡»é‡‡ç”¨å¿«ç…§+å¢é‡æ··åˆæ–¹æ¡ˆ (ADR-004)
- çŸ¥è¯†å›¾è°±å¿…é¡»ä½¿ç”¨å±‚çº§+ç½‘çŠ¶æ··åˆæ¨¡å‹ (ADR-005)

## Dev Notes

### Testing

**éœ€è¦çš„æµ‹è¯•ç±»å‹**:
- [ ] å•å…ƒæµ‹è¯•: GenesisSessionçŠ¶æ€æœºé€»è¾‘æµ‹è¯• (coverage: 90%+)
- [ ] é›†æˆæµ‹è¯•: åˆ›ä¸–æµç¨‹å®Œæ•´æ€§æµ‹è¯•ï¼ŒåŒ…å«æ‰€æœ‰6ä¸ªé˜¶æ®µ
- [ ] æ€§èƒ½æµ‹è¯•: é¦–tokenå“åº”<3ç§’ï¼Œæ‰¹é‡ç”Ÿæˆ<5ç§’ (NFR-001)
- [ ] ç”¨æˆ·ä½“éªŒæµ‹è¯•: å¯¹è¯äº¤äº’æµç•…æ€§å’Œä¸‰é”®æ“ä½œå“åº”é€Ÿåº¦

**æ‰‹åŠ¨æµ‹è¯•æ­¥éª¤**:
1. å¯åŠ¨æ–°çš„åˆ›ä¸–ä¼šè¯ï¼ŒéªŒè¯Stage 0åˆå§‹åŒ–
2. å®Œæˆæ¯ä¸ªé˜¶æ®µçš„å¯¹è¯äº¤äº’ï¼ŒéªŒè¯çŠ¶æ€è½¬æ¢
3. æµ‹è¯•å†…å®¹ç”Ÿæˆçš„ä¸‰é”®æ“ä½œï¼ˆæ¥å—/ä¿®æ”¹/é‡æ–°ç”Ÿæˆï¼‰
4. éªŒè¯çŸ¥è¯†åº“æ•°æ®åœ¨å„é˜¶æ®µé—´çš„ä¸€è‡´æ€§
5. æ£€æŸ¥SSEå®æ—¶æ›´æ–°åŠŸèƒ½çš„ç¨³å®šæ€§

### Architecture Decision Records

**å·²æ¥å—çš„ADR**:
- ADR-001: å¯¹è¯çŠ¶æ€ç®¡ç†ï¼ˆé€šç”¨ä¼šè¯æ¶æ„ + Redisç¼“å­˜ + PostgreSQLæŒä¹…åŒ–ï¼‰
- ADR-002: å‘é‡åµŒå…¥æ¨¡å‹é€‰æ‹©ï¼ˆQwen3-Embedding 0.6Bè‡ªæ‰˜ç®¡ï¼‰  
- ADR-004: å†…å®¹ç‰ˆæœ¬æ§åˆ¶å®ç°ï¼ˆå¿«ç…§MinIO + å¢é‡PostgreSQLæ··åˆæ–¹æ¡ˆï¼‰
- ADR-005: çŸ¥è¯†å›¾è°±Schemaè®¾è®¡ï¼ˆå±‚çº§+ç½‘çŠ¶æ··åˆæ¨¡å‹ï¼Œ8ç»´åº¦è§’è‰²ï¼‰
- ADR-006: æ‰¹é‡ä»»åŠ¡è°ƒåº¦ç­–ç•¥ï¼ˆPrefectç¼–æ’+Outboxâ†’Kafka+Redisä¼˜å…ˆçº§é˜Ÿåˆ—ï¼‰

**å¾…å†³ç­–çš„ADR**:
- ADR-003: æç¤ºè¯æ¨¡æ¿ç®¡ç†ï¼ˆæ¨¡æ¿ä»“åº“+ç‰ˆæœ¬åŒ–ï¼‰

## Dev Agent Record

### Agent Model Used: Claude Opus 4.1

### Implementation Progress

**å½“å‰çŠ¶æ€**: Story 3.1æ­£åœ¨å®æ–½ä¸­
- âœ… **Task 1å®Œæˆ**: æ•°æ®åº“åŸºç¡€è®¾æ–½å·²å»ºç«‹ï¼ŒåŒ…å«PostgreSQLã€Neo4jã€Milvuså’ŒRedisé›†æˆ
- ğŸ”„ **Task 2è¿›è¡Œä¸­**: Neo4jå›¾æ•°æ®åº“æ¨¡å¼85%å®Œæˆï¼Œå…³ç³»çº¦æŸå¾…å®Œå–„
- â³ **Task 3-5å¾…å¼€å§‹**: çŠ¶æ€æœºã€UIäº¤äº’å’ŒçŸ¥è¯†åº“é›†æˆ

**æŠ€æœ¯å€ºåŠ¡å’Œæ”¹è¿›ç‚¹**:
- Neo4j CypheræŸ¥è¯¢å­˜åœ¨æ³¨å…¥é£é™©ï¼Œéœ€è¦å‚æ•°åŒ–æŸ¥è¯¢ (æ¥è‡ªcode-review-expertåé¦ˆ)
- ç¼ºä¹è¿æ¥æ± é…ç½®ï¼ŒRedis keys()æ“ä½œæˆæœ¬é«˜ (æ€§èƒ½ä¼˜åŒ–å»ºè®®)
- éœ€è¦Pydanticæ¨¡å‹éªŒè¯æ•°æ®å®Œæ•´æ€§

### File List

**å·²åˆ›å»ºçš„æ ¸å¿ƒæ–‡ä»¶**:
- `/apps/backend/src/db/bootstrap.py` - æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
- Database migration files (Alembic)
- Schema definition files

**è®¡åˆ’åˆ›å»ºçš„æ–‡ä»¶**:
- `/apps/backend/src/genesis/` - åˆ›ä¸–é˜¶æ®µæ ¸å¿ƒæœåŠ¡
- `/apps/frontend/src/pages/genesis/` - å‰ç«¯åˆ›ä¸–ç•Œé¢
- `/packages/shared-types/src/genesis/` - å…±äº«ç±»å‹å®šä¹‰

### Change Log

| Date | Version | Description | Author |
| :--- | :------ | :---------- | :----- |
| 2025-09-04 | 1.0.0 | åˆ›ä¸–é˜¶æ®µæ ¸å¿ƒæ•°æ®åŸºç¡€è®¾æ–½å®Œæˆ | Dev Agent |
| 2025-09-05 | 1.1.0 | Neo4jå›¾æ•°æ®åº“æ¨¡å¼å®ç°è¿›è¡Œä¸­ | Dev Agent |

## QA Results

**è´¨é‡éªŒè¯çŠ¶æ€**:
- âœ… Code-simplifieréªŒè¯é€šè¿‡ï¼šä»£ç é‡æ„ä¸ºç±»åŒ–æ¶æ„ï¼Œæé«˜75%ä»£ç å¤ç”¨ç‡
- âš ï¸  Code-review-expertéªŒè¯ï¼šæ¶æ„è‰¯å¥½ä½†å­˜åœ¨å®‰å…¨å’Œæ€§èƒ½é£é™©éœ€è§£å†³
- â³ ç«¯åˆ°ç«¯åŠŸèƒ½æµ‹è¯•ï¼šç­‰å¾…Task 3-5å®Œæˆåè¿›è¡Œ

**å¾…éªŒè¯é¡¹**:
- AIé‡‡çº³ç‡â‰¥70% (NFR-005)
- é¦–tokenå“åº”<3ç§’ (NFR-001)  
- æœˆåº¦å¯ç”¨æ€§â‰¥99.5% (NFR-002)