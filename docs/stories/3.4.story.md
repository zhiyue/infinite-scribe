# Story 3.4: Event-Driven Workflow Orchestration for Genesis

## Status: Planned

## Story

- As a **创世阶段系统**
- I want **一个可靠的事件驱动工作流编排系统，能够管理复杂的Agent协作流程和异步任务处理**
- so that **创世流程可以自动化执行，支持条件分支、错误恢复和动态任务调度，确保系统的可靠性和可扩展性**

## Acceptance Criteria (ACs)

1. **[Given]** 创世阶段启动 **[When]** 系统开始执行工作流 **[Then]** Prefect编排器必须能够管理所有6个阶段的任务序列。
2. **[Then]** 工作流必须支持条件分支，根据任务结果决定下一步执行路径。
3. **[Then]** 系统必须通过Kafka事件总线实现所有组件间的异步通信。
4. **[Given]** 任务执行失败 **[When]** 错误发生 **[Then]** 系统必须能够自动重试、回滚或转到错误处理流程。
5. **[Then]** 所有事件必须通过Outbox模式确保可靠投递。
6. **[Then]** 工作流状态必须可观测，支持实时监控和历史追踪。

## Tasks / Subtasks

- [x] Task 1: 事件驱动基础设施 (AC: 3, 5) - 已完成
  - [x] Subtask 1.1: 配置Kafka集群和核心Topics
  - [x] Subtask 1.2: 实现EventProducer和EventConsumer基类
  - [x] Subtask 1.3: 创建event_outbox表支持事务性事件发布
  - [x] Subtask 1.4: 实现MessageRelayService轮询outbox表
  - [x] Subtask 1.5: 配置Redis支持SSE实时推送

- [ ] Task 2: Prefect工作流编排器 (AC: 1, 2, 4)
  - [ ] Subtask 2.1: 设计创世阶段主工作流（GenesisOrchestrationFlow）
  - [ ] Subtask 2.2: 实现阶段任务（StageTask）和条件分支逻辑
  - [ ] Subtask 2.3: 创建Agent任务编排器（AgentTaskOrchestrator）
  - [ ] Subtask 2.4: 实现错误处理和重试策略
  - [ ] Subtask 2.5: 配置工作流状态持久化和恢复

- [ ] Task 3: 事件模式定义 (AC: 3, 5)
  - [ ] Subtask 3.1: 定义创世阶段核心事件类型
    - `genesis.stage.started`, `genesis.stage.completed`
    - `genesis.agent.task.requested`, `genesis.agent.task.completed`
    - `genesis.content.generated`, `genesis.content.approved`
    - `genesis.consistency.check.requested`, `genesis.consistency.check.completed`
  - [ ] Subtask 3.2: 实现事件版本化和兼容性管理
  - [ ] Subtask 3.3: 创建事件验证和序列化机制
  - [ ] Subtask 3.4: 实现事件路由和分发逻辑

- [ ] Task 4: 动态工作流支持 (AC: 2, 4)
  - [ ] Subtask 4.1: 实现条件分支工作流节点
    - 质量评分分支：高分→下一阶段，低分→重写流程
    - 一致性检查分支：通过→继续，失败→修正流程
    - 用户反馈分支：接受→确认，修改→Agent重写，重新生成→新任务
  - [ ] Subtask 4.2: 实现动态任务创建（新角色/世界观需求）
  - [ ] Subtask 4.3: 创建工作流中断和恢复机制
  - [ ] Subtask 4.4: 实现任务优先级和资源分配

- [ ] Task 5: 批量任务调度 (AC: 1, 3, 6) - 基于ADR-006
  - [ ] Subtask 5.1: 实现Outbox模式的批量任务发布
  - [ ] Subtask 5.2: 创建Redis优先级队列管理任务
  - [ ] Subtask 5.3: 实现Token Bucket限流控制API调用
  - [ ] Subtask 5.4: 添加任务批处理和合并逻辑
  - [ ] Subtask 5.5: 集成Prefect管理批量任务生命周期

- [ ] Task 6: 可观测性和监控 (AC: 6)
  - [ ] Subtask 6.1: 集成Langfuse监控工作流执行
  - [ ] Subtask 6.2: 实现工作流状态实时推送（SSE）
  - [ ] Subtask 6.3: 创建工作流性能指标收集
  - [ ] Subtask 6.4: 实现任务执行链路追踪
  - [ ] Subtask 6.5: 添加工作流健康检查和告警

## Dev Technical Guidance

### Previous Story Insights
- Story 3.1已建立CQRS+事件溯源+Outbox基础设施
- Story 3.2定义了Agent系统需要的工作流编排需求
- Story 3.3提供了知识库服务，工作流需要集成这些服务
- Kafka集群和基础事件处理框架已配置完成

### Data Models

**Workflow State Models**:
```python
class GenesisWorkflowState(BaseModel):
    """创世工作流状态"""
    workflow_id: UUID
    session_id: UUID
    current_stage: GenesisStage
    stage_status: Dict[GenesisStage, StageStatus]
    active_tasks: List[UUID]
    workflow_context: Dict[str, Any]
    created_at: datetime
    updated_at: datetime

class WorkflowTask(BaseModel):
    """工作流任务"""
    task_id: UUID
    workflow_id: UUID
    task_type: TaskType
    agent_type: Optional[AgentType]
    input_data: Dict[str, Any]
    output_data: Optional[Dict[str, Any]]
    status: TaskStatus
    retry_count: int
    max_retries: int
    created_at: datetime
    started_at: Optional[datetime]
    completed_at: Optional[datetime]
```

**Event Models** (基于ADR-003):
```python
class GenesisStageEvent(BaseDomainEvent):
    """创世阶段事件"""
    event_type: str
    session_id: UUID
    stage: GenesisStage
    stage_data: Dict[str, Any]
    correlation_id: UUID

class AgentTaskEvent(BaseDomainEvent):
    """Agent任务事件"""
    event_type: str
    task_id: UUID
    agent_type: AgentType
    task_data: Dict[str, Any]
    correlation_id: UUID

class WorkflowTransitionEvent(BaseDomainEvent):
    """工作流转换事件"""
    event_type: str
    workflow_id: UUID
    from_state: str
    to_state: str
    transition_data: Dict[str, Any]
```

### API Specifications

**Workflow Management Endpoints**:
```
POST /api/workflows/genesis                    # 启动创世工作流
GET /api/workflows/{workflow_id}               # 获取工作流状态
POST /api/workflows/{workflow_id}/pause        # 暂停工作流
POST /api/workflows/{workflow_id}/resume       # 恢复工作流
DELETE /api/workflows/{workflow_id}            # 取消工作流
```

**Workflow Events Endpoints**:
```
GET /api/workflows/{workflow_id}/events        # 获取工作流事件历史
GET /api/workflows/{workflow_id}/events/stream # SSE事件流
POST /api/workflows/events                     # 发布工作流事件
```

**Task Management Endpoints**:
```
GET /api/workflows/{workflow_id}/tasks         # 获取工作流任务列表
POST /api/workflows/{workflow_id}/tasks/{task_id}/retry  # 重试任务
POST /api/workflows/{workflow_id}/tasks/batch  # 批量任务操作
```

### Component Specifications

**Core Orchestration Components**:
```python
class GenesisOrchestrator:
    """创世阶段编排器"""
    def __init__(self):
        self.prefect_client = PrefectClient()
        self.event_bus = KafkaEventBus()
        self.task_scheduler = TaskScheduler()
    
    async def start_genesis_workflow(
        self, 
        session_id: UUID, 
        config: GenesisConfig
    ) -> UUID:
        """启动创世工作流"""
    
    async def handle_stage_completion(
        self, 
        event: GenesisStageCompletedEvent
    ) -> None:
        """处理阶段完成事件"""
    
    async def handle_task_failure(
        self, 
        task_id: UUID, 
        error: Exception
    ) -> None:
        """处理任务失败"""

class ConditionalFlowManager:
    """条件分支流程管理器"""
    async def evaluate_quality_branch(
        self, 
        content: str, 
        quality_score: float
    ) -> FlowDecision:
        """评估质量分支"""
    
    async def evaluate_consistency_branch(
        self, 
        consistency_report: ConsistencyReport
    ) -> FlowDecision:
        """评估一致性分支"""
    
    async def evaluate_user_feedback_branch(
        self, 
        feedback: UserFeedback
    ) -> FlowDecision:
        """评估用户反馈分支"""
```

**Specialized Workflow Components**:
- `StageTransitionManager`: 管理创世阶段之间的转换
- `AgentTaskDispatcher`: 分发和管理Agent任务
- `BatchTaskProcessor`: 处理批量任务调度
- `WorkflowRecoveryManager`: 处理工作流恢复和容错
- `TaskRetryHandler`: 管理任务重试逻辑

### File Locations

**工作流编排目录结构**:
```
/apps/backend/src/orchestration/
├── __init__.py
├── genesis_orchestrator.py     # 主编排器
├── workflows/
│   ├── __init__.py
│   ├── genesis_flow.py         # 创世主工作流
│   ├── stage_flows.py          # 各阶段子工作流
│   └── conditional_flows.py    # 条件分支工作流
├── tasks/
│   ├── __init__.py
│   ├── task_scheduler.py       # 任务调度器
│   ├── batch_processor.py      # 批量处理器
│   └── retry_handler.py        # 重试处理器
├── events/
│   ├── __init__.py
│   ├── workflow_events.py      # 工作流事件定义
│   └── event_handlers.py       # 事件处理器
└── monitoring/
    ├── __init__.py
    ├── workflow_monitor.py     # 工作流监控
    └── metrics_collector.py    # 指标收集器
```

**Prefect Flows目录结构**:
```
/apps/backend/src/flows/
├── __init__.py
├── genesis/
│   ├── __init__.py
│   ├── main_flow.py            # 主创世流程
│   ├── stage_flows/
│   │   ├── concept_selection.py
│   │   ├── story_conception.py
│   │   ├── worldview_building.py
│   │   ├── character_design.py
│   │   ├── plot_outline.py
│   │   └── finalization.py
│   └── agent_flows/
│       ├── agent_task_flow.py
│       └── agent_coordination_flow.py
```

### Testing Requirements

**工作流测试**:
- [ ] 端到端创世工作流执行测试
- [ ] 条件分支逻辑正确性测试
- [ ] 工作流中断和恢复测试
- [ ] 并发工作流处理能力测试

**事件系统测试**:
- [ ] Kafka事件可靠投递测试
- [ ] Outbox模式事务性测试
- [ ] 事件序列化和反序列化测试
- [ ] 事件重复和顺序处理测试

**任务调度测试**:
- [ ] 批量任务处理性能测试
- [ ] 任务优先级和资源分配测试
- [ ] Agent任务分发和收集测试
- [ ] 任务失败和重试逻辑测试

**可观测性测试**:
- [ ] 工作流状态追踪准确性测试
- [ ] SSE实时推送功能测试
- [ ] 指标收集和监控功能测试
- [ ] 链路追踪完整性测试

### Technical Constraints

**性能约束**:
- 工作流调度延迟必须<1秒
- 事件投递必须保证至少一次语义
- 批量任务处理必须支持背压控制
- SSE连接必须支持大规模并发

**可靠性约束**:
- 工作流状态必须持久化，支持崩溃恢复
- 事件必须支持重放和幂等处理
- 任务失败必须有合理的重试和降级机制
- 系统组件必须支持优雅关闭和重启

**扩展性约束**:
- 工作流引擎必须支持水平扩展
- Kafka必须支持分区扩展
- 任务队列必须支持动态分片
- 监控系统必须支持多实例聚合

## Dev Notes

### Testing

**工作流端到端测试场景**:
1. **标准创世流程测试**:
   - 启动 → 概念选择 → 故事构思 → 世界观建设 → 角色设计 → 情节大纲 → 完成
   - 验证每个阶段的数据传递和状态转换
   - 检查知识库的增量构建过程

2. **条件分支测试**:
   - 低质量分数触发重写流程
   - 一致性检查失败触发修正流程
   - 用户反馈触发相应的处理流程
   - 动态任务创建（新角色/设定需求）

3. **错误恢复测试**:
   - Agent任务超时和重试
   - 工作流中断和恢复
   - 数据库连接失败恢复
   - Kafka消息投递失败处理

4. **并发和负载测试**:
   - 多个创世会话并发执行
   - 大量Agent任务并发调度
   - 事件高峰期处理能力
   - 资源竞争和死锁检测

### Architecture Integration

**与现有系统集成**:
- 扩展现有EventBus支持工作流事件
- 复用现有Agent框架进行任务执行
- 集成现有KnowledgeService作为任务数据源
- 利用现有SSE服务推送工作流状态

**事件驱动架构模式**:
- Command-Query分离：命令通过工作流，查询直接访问
- 事件溯源：所有状态变更通过事件记录
- 最终一致性：通过事件确保跨服务数据同步
- 补偿事务：通过反向事件实现分布式事务回滚

### Performance Optimization

**工作流优化策略**:
- 任务并行执行：独立任务可以并行调度
- 状态缓存：热点工作流状态缓存到Redis
- 事件批处理：相似事件批量处理减少开销
- 资源池化：Agent和连接资源池化复用

**监控和调优**:
- 工作流执行时间分析和瓶颈识别
- 事件处理延迟监控和优化
- 任务队列长度和处理速度监控
- 资源使用率和扩展触发机制

## Dev Agent Record

### Agent Model Used: Claude Opus 4.1

### Implementation Strategy

**分阶段实现计划**:
1. **Phase 1**: 实现基础工作流编排（Task 2）
2. **Phase 2**: 完善事件模式和动态工作流（Task 3, 4）
3. **Phase 3**: 实现批量任务调度（Task 5）
4. **Phase 4**: 添加完整监控和可观测性（Task 6）

**技术选择理由**:
- **Prefect**: 相比Airflow更轻量，Python原生，更适合动态工作流
- **Kafka**: 高吞吐量事件总线，支持事件重放和分区扩展
- **Outbox Pattern**: 确保数据库事务和事件发布的一致性
- **Redis**: 高性能任务队列和状态缓存

### Risk Assessment

**主要技术风险**:
- ⚠️  Prefect工作流复杂度可能导致调试困难
- ⚠️  事件驱动系统的分布式调试挑战
- ⚠️  Kafka集群运维复杂度
- ✅ Outbox模式确保数据一致性

**缓解策略**:
- 详细的工作流日志和可视化监控
- 完整的事件链路追踪系统
- Kafka管理工具和监控告警
- 全面的单元测试和集成测试

### Quality Assurance

**代码质量要求**:
- 工作流定义必须声明式，避免命令式编程
- 事件处理必须幂等，支持重复执行
- 错误处理必须细粒度，避免级联失败
- 所有异步操作必须有超时和重试机制

**监控要求**:
- 工作流执行的端到端链路追踪
- 关键性能指标实时监控和告警
- 事件处理延迟和错误率监控
- 资源使用情况和瓶颈分析

### Change Log

| Date | Version | Description | Author |
| :--- | :------ | :---------- | :----- |
| 2025-09-05 | 1.0.0 | 事件驱动工作流编排设计文档创建 | Dev Agent |

## QA Results

**设计完整性评估**:
- ✅ 工作流编排架构设计完整
- ✅ 事件驱动模式定义清晰  
- ✅ 错误处理和恢复机制设计合理
- ⏳ 性能基准和扩展策略待验证

**技术可行性评估**:
- ✅ Prefect+Kafka技术栈成熟可靠
- ✅ 与现有系统集成方案可行
- ⚠️  复杂工作流的调试和运维挑战需要重点关注
- ✅ 事件驱动架构提供良好的可扩展性