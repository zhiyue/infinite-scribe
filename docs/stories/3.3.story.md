# Story 3.3: Knowledge Graph and Vector Embeddings for Genesis

## Status: In Progress

## Story

- As a **AI Agent系统**
- I want **一个智能的知识管理系统，结合图数据库和向量嵌入技术，维护小说创世阶段的复杂知识关系**
- so that **所有Agent都能够访问一致、准确、相关的背景信息，确保生成内容的连贯性和质量**

## Acceptance Criteria (ACs)

1. **[Given]** 创世阶段生成任何内容 **[When]** 内容涉及世界观、角色或情节元素 **[Then]** 系统必须自动将其存储到知识图谱和向量数据库中。
2. **[Then]** 知识图谱必须支持复杂的关系查询，包括角色关系、地理位置、物品归属等。
3. **[Then]** 向量嵌入系统必须支持语义搜索，快速找到相关的历史内容和设定。
4. **[Given]** Agent需要上下文信息 **[When]** 执行创作任务 **[Then]** 系统必须能在400ms内返回最相关的背景信息。
5. **[Then]** 系统必须能够检测和标记内容间的潜在冲突和不一致性。
6. **[Then]** 知识库必须支持版本控制，追踪设定的变化历史。

## Tasks / Subtasks

- [x] Task 1: 向量嵌入基础设施 (AC: 1, 3, 4) - 已完成
  - [x] Subtask 1.1: 配置Milvus向量数据库集合（novel_embeddings_v1，768维）
  - [x] Subtask 1.2: 集成Qwen3-Embedding 0.6B模型（基于ADR-002）
  - [x] Subtask 1.3: 实现MilvusSchemaManager管理集合和索引
  - [x] Subtask 1.4: 配置IVF_FLAT索引优化检索性能
  - [x] Subtask 1.5: 设置按novel_id的分区策略

- [x] Task 2: Neo4j图数据库基础 (AC: 1, 2, 5) - 85% 完成
  - [x] Subtask 2.1: 创建核心节点类型（Novel, Character, WorldRule, Location, Item, Organization, Event）
  - [x] Subtask 2.2: 实现Character节点8维度属性（外貌、性格、背景、动机、目标、障碍、转折、心结）
  - [x] Subtask 2.3: 实现WorldRule节点5维度世界观属性（地理、历史、文化、规则、社会）
  - [x] Subtask 2.4: 配置节点属性约束和索引
  - [ ] Subtask 2.5: 完善关系类型定义（CONTAINS, INTERACTS, BELONGS_TO, INFLUENCES等）

- [ ] Task 3: 知识图谱服务层 (AC: 2, 5, 6)
  - [ ] Subtask 3.1: 实现KnowledgeGraphService扩展创世阶段专用查询
  - [ ] Subtask 3.2: 创建RelationshipManager管理复杂关系网络
  - [ ] Subtask 3.3: 实现ConsistencyValidator检测内容冲突
  - [ ] Subtask 3.4: 添加图数据版本控制和变更追踪
  - [ ] Subtask 3.5: 实现智能关系推断和建议功能

- [ ] Task 4: 向量嵌入服务层 (AC: 3, 4)
  - [ ] Subtask 4.1: 实现EmbeddingService自动生成和更新嵌入
  - [ ] Subtask 4.2: 创建SemanticSearchService支持多种查询模式
  - [ ] Subtask 4.3: 实现上下文相关性排序算法
  - [ ] Subtask 4.4: 添加嵌入质量评估和优化机制
  - [ ] Subtask 4.5: 实现批量嵌入处理提高效率

- [ ] Task 5: 统一知识检索接口 (AC: 4)
  - [ ] Subtask 5.1: 创建UnifiedKnowledgeService整合图数据库和向量搜索
  - [ ] Subtask 5.2: 实现智能查询路由（结构化vs语义搜索）
  - [ ] Subtask 5.3: 添加查询结果融合和排序算法
  - [ ] Subtask 5.4: 实现查询缓存和性能优化
  - [ ] Subtask 5.5: 创建知识检索API适配不同Agent需求

- [ ] Task 6: 知识管理工具 (AC: 5, 6)
  - [ ] Subtask 6.1: 实现冲突检测和解决建议系统
  - [ ] Subtask 6.2: 创建知识图谱可视化工具
  - [ ] Subtask 6.3: 添加知识完整性检查和修复功能
  - [ ] Subtask 6.4: 实现知识导入导出功能
  - [ ] Subtask 6.5: 创建知识质量评估和监控系统

## Dev Technical Guidance

### Previous Story Insights
- Story 3.1已完成Milvus和Neo4j的基础配置
- Story 3.2定义了Agent访问知识库的需求模式
- MilvusSchemaManager和KnowledgeGraphService基础框架已存在
- Qwen3-Embedding模型已集成到系统中

### Data Models

**Knowledge Graph Schema** (基于ADR-005):
```python
class NovelEntity(BaseModel):
    """小说实体基类"""
    id: UUID
    novel_id: UUID
    entity_type: EntityType
    name: str
    description: str
    properties: Dict[str, Any]
    created_at: datetime
    updated_at: datetime

class CharacterNode(NovelEntity):
    """角色节点 - 8维度属性"""
    appearance: str          # 外貌描述
    personality: str         # 性格特征
    background: str          # 背景设定
    motivation: str          # 动机驱动
    goals: List[str]         # 目标列表
    obstacles: List[str]     # 障碍阻碍
    arc_turning_points: List[str]  # 转折点
    inner_conflicts: List[str]     # 内心心结

class WorldRuleNode(NovelEntity):
    """世界规则节点 - 5维度世界观"""
    geography: Dict[str, Any]    # 地理环境
    history: Dict[str, Any]      # 历史背景
    culture: Dict[str, Any]      # 文化设定
    rules: Dict[str, Any]        # 规则体系
    society: Dict[str, Any]      # 社会结构
```

**Vector Embedding Schema** (基于ADR-002):
```python
class ContentEmbedding(BaseModel):
    """内容向量嵌入"""
    id: UUID
    content_id: UUID
    content_type: str        # "character", "world_rule", "dialogue", etc.
    embedding_vector: List[float]  # 768维向量
    metadata: Dict[str, Any]
    novel_id: UUID           # 分区键
    created_at: datetime

class EmbeddingQuery(BaseModel):
    """嵌入查询请求"""
    query_text: str
    content_types: List[str] = []
    novel_id: Optional[UUID] = None
    similarity_threshold: float = 0.7
    top_k: int = 10
```

**Knowledge Relationships**:
```python
class KnowledgeRelationship(BaseModel):
    """知识关系定义"""
    from_entity: UUID
    to_entity: UUID
    relationship_type: RelationshipType  # CONTAINS, INTERACTS, BELONGS_TO, etc.
    properties: Dict[str, Any]
    strength: float          # 关系强度 0.0-1.0
    created_at: datetime
```

### API Specifications

**Knowledge Graph Endpoints**:
```
GET /api/knowledge/graph/{novel_id}                    # 获取小说知识图谱概览
POST /api/knowledge/entities                           # 创建新实体
GET /api/knowledge/entities/{entity_id}                # 获取实体详情
PUT /api/knowledge/entities/{entity_id}                # 更新实体
GET /api/knowledge/entities/{entity_id}/relationships  # 获取实体关系
POST /api/knowledge/relationships                      # 创建关系
```

**Vector Search Endpoints**:
```
POST /api/knowledge/search/semantic                    # 语义搜索
POST /api/knowledge/search/similar                     # 相似内容搜索
GET /api/knowledge/embeddings/{content_id}             # 获取内容嵌入
POST /api/knowledge/embeddings/batch                   # 批量生成嵌入
```

**Unified Knowledge Endpoints**:
```
POST /api/knowledge/query                              # 统一知识查询
GET /api/knowledge/context/{session_id}                # 获取会话上下文
POST /api/knowledge/consistency/check                  # 一致性检查
GET /api/knowledge/conflicts/{novel_id}                # 获取冲突列表
```

### Component Specifications

**Core Knowledge Services**:
```python
class UnifiedKnowledgeService:
    """统一知识服务"""
    def __init__(self):
        self.graph_service = KnowledgeGraphService()
        self.embedding_service = EmbeddingService()
        self.cache_service = Redis()
    
    async def get_relevant_context(
        self, 
        query: str, 
        novel_id: UUID,
        context_type: List[str] = None
    ) -> KnowledgeContext:
        """获取相关上下文信息"""
    
    async def check_consistency(
        self, 
        content: str, 
        novel_id: UUID
    ) -> ConsistencyReport:
        """检查内容一致性"""
    
    async def suggest_connections(
        self, 
        entity_id: UUID
    ) -> List[SuggestedConnection]:
        """建议可能的连接"""
```

**Specialized Components**:
- `ConsistencyValidator`: 检测内容冲突和不一致性
- `RelationshipInferenceEngine`: 推断可能的实体关系
- `ContextRanker`: 根据相关性排序上下文信息
- `KnowledgeVersionManager`: 管理知识的版本控制
- `EmbeddingQualityMonitor`: 监控嵌入质量和漂移

### File Locations

**知识管理服务目录结构**:
```
/apps/backend/src/knowledge/
├── __init__.py
├── unified_service.py           # 统一知识服务
├── graph/
│   ├── __init__.py
│   ├── graph_service.py         # 图数据库服务(扩展现有)
│   ├── relationship_manager.py  # 关系管理器
│   └── consistency_validator.py # 一致性验证器
├── embeddings/
│   ├── __init__.py
│   ├── embedding_service.py     # 嵌入服务
│   ├── semantic_search.py       # 语义搜索
│   └── quality_monitor.py       # 质量监控
├── context/
│   ├── __init__.py
│   ├── context_manager.py       # 上下文管理
│   └── relevance_ranker.py      # 相关性排序
└── versioning/
    ├── __init__.py
    └── version_manager.py       # 版本管理
```

### Testing Requirements

**功能测试**:
- [ ] 知识图谱CRUD操作测试
- [ ] 向量嵌入生成和搜索测试
- [ ] 一致性检查准确性测试
- [ ] 上下文检索相关性测试

**性能测试**:
- [ ] 400ms响应时间要求验证 (NFR-001)
- [ ] 大规模知识图谱查询性能测试
- [ ] 向量搜索在不同数据量下的表现
- [ ] 并发访问下的系统稳定性

**质量测试**:
- [ ] 嵌入质量评估（语义相关性）
- [ ] 冲突检测准确性和召回率
- [ ] 关系推断的精度评估
- [ ] 知识完整性验证

### Technical Constraints

**性能约束**:
- 上下文检索必须在400ms内完成 (NFR-001)
- 向量搜索必须支持毫秒级响应
- 图数据库查询必须优化索引避免全图扫描
- 嵌入生成必须支持批量处理提高效率

**数据约束**:
- 必须使用Qwen3-Embedding 0.6B模型，768维向量 (ADR-002)
- 图数据库必须采用层级+网状混合模型 (ADR-005)
- 所有变更必须支持版本控制和回滚 (ADR-004)
- 数据必须支持分区和水平扩展

**安全约束**:
- Neo4j查询必须使用参数化避免注入攻击
- API访问必须有适当的认证和授权
- 敏感内容必须加密存储
- 审计日志必须记录所有数据变更

## Dev Notes

### Testing

**知识图谱测试场景**:
- [ ] 创建角色节点并建立复杂关系网络
- [ ] 测试世界规则节点的5维度属性管理
- [ ] 验证关系查询的准确性和性能
- [ ] 测试大规模图数据的查询优化

**向量搜索测试场景**:
- [ ] 测试语义相似度搜索的准确性
- [ ] 验证不同查询长度下的搜索效果
- [ ] 测试跨语言和跨领域的语义理解
- [ ] 验证向量索引的更新和维护

**一致性检测测试场景**:
- [ ] 故意引入角色设定冲突，验证检测能力
- [ ] 测试世界观规则冲突的识别
- [ ] 验证时间线逻辑冲突检测
- [ ] 测试地理位置冲突识别

### Performance Optimization

**向量搜索优化**:
- 使用适当的索引类型（IVF_FLAT vs HNSW）
- 实现查询结果缓存机制
- 批量嵌入生成减少API调用
- 预计算常用查询的嵌入向量

**图数据库优化**:
- 优化Cypher查询，使用索引和约束
- 实现查询计划缓存
- 使用连接池管理数据库连接
- 分区大型图数据提高查询性能

### Integration Points

**与Agent系统集成**:
- Agent可通过统一接口访问知识库
- 自动上下文注入到Agent任务中
- Agent生成内容自动更新知识库
- 知识冲突自动通知相关Agent

**与创世阶段流程集成**:
- 每个创世阶段自动构建对应知识
- 阶段间知识传递和积累
- 知识完整性验证影响阶段推进
- 历史版本支持创世流程回溯

## Dev Agent Record

### Agent Model Used: Claude Opus 4.1

### Implementation Priority

**Phase 1 (高优先级)**:
- 完成Neo4j关系类型定义（Task 2.5）
- 实现统一知识检索接口（Task 5）
- 集成到现有Agent系统中

**Phase 2 (中优先级)**:
- 实现一致性检测和冲突解决
- 添加知识版本控制功能
- 优化查询性能到400ms要求

**Phase 3 (低优先级)**:
- 实现知识可视化工具
- 添加高级分析和洞察功能
- 扩展多模态知识支持

### Technical Decisions

**嵌入模型选择**: 使用Qwen3-Embedding 0.6B确保中文内容的语义理解准确性
**索引策略**: Milvus使用IVF_FLAT索引平衡精度和性能
**图模式设计**: 采用实体-关系-属性模型支持复杂查询
**缓存策略**: Redis缓存热点查询结果，TTL 30分钟

### Change Log

| Date | Version | Description | Author |
| :--- | :------ | :---------- | :----- |
| 2025-09-05 | 1.0.0 | 知识管理系统设计文档创建 | Dev Agent |

## QA Results

**当前实现状态验证**:
- ✅ Milvus向量数据库已配置，支持768维嵌入
- ✅ Neo4j图数据库基础节点已创建，85%完成
- ⏳ 统一知识服务接口待开发
- ⏳ 一致性检测功能待实现

**性能基准测试**:
- ⏳ 400ms响应时间要求待压力测试验证
- ⏳ 向量搜索准确性待评估
- ⏳ 图查询性能待优化验证