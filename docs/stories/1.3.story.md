# Story 1.3: 创建并部署健康的API网关服务

## Status: Draft

## Story

- As a 开发团队
- I want 一个基于FastAPI的、容器化的API网关服务，它能连接到数据库并提供一个健康的检查端点
- so that 我可以验证后端服务的基础配置和部署流程是通畅的

## Acceptance Criteria (ACs)

1. 在 `apps/backend/src/api` 目录下创建API Gateway的FastAPI应用。
2. 该应用能够成功读取环境变量并连接到Docker中运行的PostgreSQL和Neo4j数据库。
3. 提供一个 `/health` 的GET端点，当数据库连接正常时，该端点返回 `{"status": "ok"}` 和 `200` 状态码。
4. 使用统一的 `apps/backend/Dockerfile`，通过 `SERVICE_TYPE=api-gateway` 环境变量运行API Gateway。
5. 更新 `docker-compose.yml`，使其可以构建并启动 `api-gateway` 服务（使用统一的backend镜像）。
6. 启动后，可以通过 `http://localhost:8000/health` 成功访问到健康检查接口。

## Dev Technical Guidance

### Previous Story Insights
- Story 1.2 成功部署了所有核心服务到开发服务器 (192.168.2.201)
- Docker Compose环境已配置完整，包括PostgreSQL、Neo4j、Redis、Kafka、Milvus、Minio和Prefect
- 环境变量已结构化分层 (.env.infrastructure, .env.backend.example等)
- 数据库初始化脚本已创建，包含完整的表结构和触发器
- 健康检查服务脚本已存在 (check-services.js)
- 所有服务端口绑定到 0.0.0.0 支持内网访问，服务器IP: 192.168.2.201

### Data Models
- PostgreSQL schema已定义，包含novels、chapters、characters、worldview_entries等表 [Source: architecture/database-schema.md#PostgreSQL]
- 数据库连接需要验证以下表存在: novels, chapters, characters, worldview_entries, reviews, story_arcs [Source: architecture/database-schema.md#PostgreSQL]
- 所有表使用UUID主键，timestamps自动更新通过触发器 [Source: architecture/database-schema.md#PostgreSQL]

### API Specifications
- 健康检查端点 `/health` 必须返回 `{"status": "ok"}` 格式 [Source: architecture/rest-api-spec.md#/health]
- API基础路径应为 `/api/v1`，开发服务器URL: `http://localhost:8000/api/v1` [Source: architecture/rest-api-spec.md#servers]
- 必须设置CORS以支持前端开发 [Source: architecture/rest-api-spec.md]

### Component Specifications
- 使用FastAPI框架 `~0.115.13` 和Pydantic `~2.11.7` 进行数据校验 [Source: architecture/tech-stack.md#Tech Stack表]
- Python版本 `~3.11` [Source: architecture/tech-stack.md#Tech Stack表]

### File Locations
- API Gateway位置: `apps/backend/src/api/` [Source: architecture/source-tree.md#backend]
- API路由模块: `apps/backend/src/api/routes/` [Source: architecture/source-tree.md#backend]
- 核心配置: `apps/backend/src/core/` [Source: architecture/source-tree.md#backend]
- 共享服务层: `apps/backend/src/common/services/` [Source: architecture/source-tree.md#backend]
- 主入口: `apps/backend/src/api/main.py` [Source: architecture/source-tree.md#backend]
- 依赖文件: `apps/backend/pyproject.toml` [Source: architecture/source-tree.md#backend]
- Docker配置: `apps/backend/Dockerfile` (统一Dockerfile) [Source: architecture/source-tree.md#backend]

### Testing Requirements
- 使用Pytest `~8.1.0` 框架进行单元和集成测试 [Source: architecture/test-strategy-and-standards.md#单元测试]
- 单元测试覆盖率目标 85% [Source: architecture/test-strategy-and-standards.md#测试理念]
- 集成测试使用testcontainers启动临时PostgreSQL和Neo4j实例 [Source: architecture/test-strategy-and-standards.md#集成测试]
- 测试文件放在 `apps/backend/tests/` 目录 [Source: architecture/source-tree.md#backend]

### Technical Constraints
- 必须使用异步/非阻塞IO，Python后端使用 `async/await` [Source: architecture/coding-standards.md#关键规则]
- 禁止硬编码敏感信息，通过环境变量加载配置 [Source: architecture/coding-standards.md#关键规则]
- 严格类型提示，使用Python类型提示 [Source: architecture/coding-standards.md#关键规则]
- 结构化日志记录，使用Python `logging` JSON格式 [Source: architecture/error-handling-strategy.md#日志标准]
- 环境变量从 `.env.backend` 或 `.env.infrastructure` 文件读取，使用分层结构
- 数据库连接池配置，考虑容器环境下的连接管理
- 错误处理遵循定义的异常层级，基于Exception-based模型 [Source: architecture/error-handling-strategy.md#总体方法]
- 使用 `pyproject.toml` 管理Python依赖，遵循PEP 517/518标准 [Source: architecture/coding-standards.md#语言特定指南]
- 使用 `uv` 作为Python包管理器，提供更快的依赖解析和安装速度
- 统一使用根目录的 `pyproject.toml` 和 `.venv`，简化依赖管理 [Source: development/python-monorepo-setup-v3.md]

## Tasks / Subtasks

- [ ] Task 1: 创建API网关基础项目结构 (AC: 1)
  - [ ] Subtask 1.1: 在 `apps/backend/src/api` 创建API Gateway模块结构
  - [ ] Subtask 1.2: 创建/更新根目录 `pyproject.toml` 添加所有服务依赖（如果不存在）
  - [ ] Subtask 1.3: 在根目录运行 `uv venv` 和 `uv sync --dev` 初始化环境
  - [ ] Subtask 1.4: 创建 `src/api/main.py` 主入口文件和基础FastAPI应用
  - [ ] Subtask 1.5: 设置 `src/core/config.py` 配置管理（环境变量读取）

- [ ] Task 2: 实现数据库连接服务 (AC: 2)
  - [ ] Subtask 2.1: 在 `src/common/services/` 创建PostgreSQL连接服务 (`postgres_service.py`)
  - [ ] Subtask 2.2: 在 `src/common/services/` 创建Neo4j连接服务 (`neo4j_service.py`)
  - [ ] Subtask 2.3: 实现异步数据库连接池管理和连接验证函数
  - [ ] Subtask 2.4: 在启动时测试数据库连接并记录连接状态

- [ ] Task 3: 实现健康检查端点 (AC: 3)
  - [ ] Subtask 3.1: 在 `src/api/routes/v1/` 创建health路由模块 (`health.py`)
  - [ ] Subtask 3.2: 实现 `/health` GET端点，检查PostgreSQL和Neo4j连接状态
  - [ ] Subtask 3.3: 确保端点返回正确的JSON格式 `{"status": "ok"}` 和HTTP 200
  - [ ] Subtask 3.4: 添加错误处理，数据库连接失败时返回适当错误状态

- [ ] Task 4: 配置Docker容器化 (AC: 4, 5)
  - [ ] Subtask 4.1: 使用 `apps/backend/Dockerfile` 统一镜像，配置 SERVICE_TYPE=api-gateway
  - [ ] Subtask 4.2: 确保Dockerfile支持通过环境变量选择运行的服务
  - [ ] Subtask 4.3: 更新根目录 `docker-compose.yml` 添加api-gateway服务定义
  - [ ] Subtask 4.4: 配置服务端口映射8000，确保与开发服务器网络连通

- [ ] Task 5: 环境变量和配置管理 (AC: 2, 6)
  - [ ] Subtask 5.1: 更新 `.env.backend.example` 添加数据库连接变量
  - [ ] Subtask 5.2: 在开发服务器创建 `.env.backend` 文件并设置生产值
  - [ ] Subtask 5.3: 配置API网关读取分层环境变量 (infrastructure + backend)
  - [ ] Subtask 5.4: 验证从容器内可以连接到开发服务器上的数据库服务

- [ ] Task 6: 测试和验证部署 (AC: 6)
  - [ ] Subtask 6.1: 创建单元测试验证健康检查逻辑
  - [ ] Subtask 6.2: 创建集成测试验证数据库连接
  - [ ] Subtask 6.3: 在开发服务器部署并验证 `http://192.168.2.201:8000/health` 可访问
  - [ ] Subtask 6.4: 更新健康检查脚本包含API网关服务验证

## Dev Notes

### Testing

Dev Note: Story Requires the following tests:

- [ ] Pytest Unit Tests: (nextToFile: true), coverage requirement: 85%
  - 测试健康检查端点响应格式
  - 测试数据库连接服务的各种状态
  - 测试配置管理和环境变量读取

- [ ] Pytest Integration Tests: location: `apps/api-gateway/tests/integration/`
  - 使用testcontainers测试真实数据库连接
  - 测试API端点与数据库交互
  - 测试Docker容器启动和健康状态

Manual Test Steps:
- SSH到开发服务器: `ssh zhiyue@192.168.2.201`
- 在服务器上运行 `docker-compose up -d` 启动所有服务包括新的api-gateway
- 通过浏览器访问 `http://192.168.2.201:8000/health` 验证返回 `{"status": "ok"}`
- 执行 `pnpm run check:services` 验证API网关健康状态
- 检查API网关容器日志确认数据库连接成功: `docker-compose logs api-gateway`
- 验证API端点响应时间合理（< 1秒）

## Dev Agent Record

### Agent Model Used: {{Agent Model Name/Version}}

### Debug Log References

[[LLM: (Dev Agent) If the debug is logged to during the current story progress, create a table with the debug log and the specific task section in the debug log - do not repeat all the details in the story]]

### Completion Notes List

[[LLM: (Dev Agent) Anything the SM needs to know that deviated from the story that might impact drafting the next story.]]

### File List

[[LLM: (Dev Agent) List every new file created, or existing file modified in a bullet list.]]

### Change Log

[[LLM: (Dev Agent) Track document versions and changes during development that deviate from story dev start]]

| Date | Version | Description | Author |
| :--- | :------ | :---------- | :----- |

## QA Results

[[LLM: QA Agent Results]]