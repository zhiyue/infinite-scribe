# Story 2.1: 设计并实现创世数据模型

## Status: Approved

## Story

- As a 系统
- I want 在PostgreSQL中创建用于存储小说核心设定属性的数据表，在Neo4j中定义核心节点标签和关系类型，并通过Pydantic/TypeScript定义好对应的数据模型
- so that 我有一个结构化的、类型安全的方式来持久化、校验和关联用户在创世阶段输入的所有信息

## Acceptance Criteria (ACs)

1. 在PostgreSQL中创建 `novels`, `worldview_entries`, `characters`, `story_arcs` 等核心属性表，以及 `chapter_versions`, `agent_activities` 等支持性表。
2. 在Monorepo的 `packages/shared-types` 中，使用Pydantic为PostgreSQL表创建Python数据模型，并为前端创建对应的TypeScript接口。
3. API网关服务能够导入这些模型，用于API请求和响应的校验。
4. API网关服务能够连接到Neo4j实例，并具备执行数据库管理命令（如 `CREATE DATABASE`）的权限。

## Dev Technical Guidance

### Previous Story Insights
- Story 1.2已创建基础的PostgreSQL表结构（novels, chapters, characters, worldview_entries）
- 数据库初始化脚本位于`/infrastructure/docker/init/postgres/`
- 开发服务器上PostgreSQL和Neo4j服务已运行
- Story 1.3已实现API Gateway与数据库的基础连接
- 需要扩展现有表结构并添加更多创世相关的表

### Data Models
完整的数据模型架构已在文档中定义 [Source: architecture/database-schema.md]

**核心实体表（需要创建/更新）**：
- `novels` - 已存在，需添加version、agent_type字段 [Source: architecture/database-schema.md#novels]
- `worldview_entries` - 已存在基础版本，需添加version、agent_type字段 [Source: architecture/database-schema.md#worldview_entries]
- `characters` - 已存在基础版本，需添加personality_traits、goals等字段 [Source: architecture/database-schema.md#characters]
- `story_arcs` - 新增表，管理故事弧线 [Source: architecture/database-schema.md#story_arcs]
- `chapter_versions` - 新增表，支持章节版本化 [Source: architecture/database-schema.md#chapter_versions]

**创世流程追踪表（新增）**：
- `genesis_sessions` - 追踪创世会话状态 [Source: architecture/database-schema.md#genesis_sessions]
- `genesis_steps` - 记录创世过程中的每个步骤 [Source: architecture/database-schema.md#genesis_steps]

**追踪与日志表（新增）**：
- `agent_activities` - 记录Agent活动（分区表） [Source: architecture/database-schema.md#agent_activities]
- `workflow_runs` - 工作流运行记录 [Source: architecture/database-schema.md#workflow_runs]
- `events` - 事件日志 [Source: architecture/database-schema.md#events]
- `agent_configurations` - Agent配置管理 [Source: architecture/database-schema.md#agent_configurations]

**Neo4j节点和关系**：
- 所有节点必须包含`app_id`属性（对应PostgreSQL主键） [Source: architecture/database-schema.md#Neo4j]
- 核心节点：`:Novel`, `:Chapter`, `:Character`, `:WorldviewEntry`, `:StoryArc`
- 所有数据必须通过关系连接到`:Novel`根节点

### API Specifications
- 数据模型将用于验证API请求和响应 [Source: architecture/components.md#API网关]
- Pydantic模型提供自动的数据验证和序列化

### Component Specifications
- 本story主要涉及数据层，不涉及UI组件

### File Locations
- `/infrastructure/docker/init/postgres/` - PostgreSQL初始化脚本目录 [Source: Story 1.2]
- `/packages/shared-types/` - 共享数据模型包（需创建） [Source: architecture/source-tree.md#L73]
- `/packages/shared-types/src/models_db.py` - Pydantic数据库模型 [Source: architecture/source-tree.md#L75]
- `/packages/shared-types/src/models_api.py` - Pydantic API模型 [Source: architecture/source-tree.md#L76]
- `/packages/shared-types/src/events.py` - Kafka事件Schema [Source: architecture/source-tree.md#L77]
- `/packages/shared-types/src/index.ts` - TypeScript类型导出 [Source: architecture/source-tree.md#L78]
- `/apps/backend/src/core/database.py` - 数据库连接（需更新Neo4j权限）

### Testing Requirements
- 单元测试验证Pydantic模型的验证逻辑
- 集成测试验证数据库表创建和约束
- 测试Neo4j连接和数据库创建权限

### Technical Constraints
- PostgreSQL 16 [Source: architecture/tech-stack.md#关系型数据库]
- Neo4j 5.x [Source: architecture/tech-stack.md#图数据库]
- Pydantic ~2.11.7用于数据验证 [Source: architecture/tech-stack.md#数据校验]
- 所有表必须遵循命名约定：snake_case [Source: architecture/coding-standards.md#命名约定]
- ENUM类型定义必须在使用前创建
- 分区表需要特殊处理（agent_activities）

## Tasks / Subtasks

- [x] Task 1: 创建shared-types包结构 (AC: 2)
  - [x] 创建`packages/shared-types`目录
  - [x] 初始化Python包结构（pyproject.toml）
  - [x] 初始化TypeScript包结构（package.json, tsconfig.json）
  - [x] 配置构建脚本

- [ ] Task 2: 创建完整的数据库迁移脚本 (AC: 1)
  - [ ] 创建ENUM类型定义（agent_type, activity_status等）
  - [ ] 创建核心实体表的完整DDL
  - [ ] 创建创世流程追踪表
  - [ ] 创建追踪与日志表（包括分区配置）
  - [ ] 创建所有必要的索引和约束
  - [ ] 创建触发器（如updated_at自动更新）

- [ ] Task 3: 实现Pydantic数据模型 (AC: 2)
  - [ ] 在`models_db.py`中实现所有数据库表对应的Pydantic模型
  - [ ] 添加字段验证规则和约束
  - [ ] 实现模型间的关系引用
  - [ ] 添加文档字符串和示例

- [ ] Task 4: 创建TypeScript接口定义 (AC: 2)
  - [ ] 在`index.ts`中定义对应的TypeScript接口
  - [ ] 确保类型与Pydantic模型保持一致
  - [ ] 导出所有接口供前端使用
  - [ ] 添加JSDoc注释

- [ ] Task 5: 创建API请求/响应模型 (AC: 3)
  - [ ] 在`models_api.py`中定义API专用的Pydantic模型
  - [ ] 实现创世流程相关的请求/响应模型
  - [ ] 添加验证规则和错误消息

- [ ] Task 6: 更新Neo4j连接配置 (AC: 4)
  - [ ] 更新`apps/backend/src/core/database.py`
  - [ ] 添加Neo4j数据库管理权限配置
  - [ ] 实现创建数据库的辅助函数
  - [ ] 添加连接池和会话管理

- [ ] Task 7: 集成数据模型到API Gateway (AC: 3)
  - [ ] 更新API Gateway依赖，引入shared-types包
  - [ ] 在API路由中使用Pydantic模型进行验证
  - [ ] 添加模型导入和使用示例

- [ ] Task 8: 创建测试套件
  - [ ] 为Pydantic模型创建单元测试
  - [ ] 测试字段验证规则
  - [ ] 测试数据库迁移脚本
  - [ ] 测试Neo4j连接和权限

- [ ] Task 9: 文档和部署验证
  - [ ] 更新数据库文档，记录新增的表和字段
  - [ ] 在开发服务器上执行迁移脚本
  - [ ] 验证所有表和约束正确创建
  - [ ] 验证Neo4j数据库创建权限

## Deviation Analysis
- 需要更新现有的基础表结构，添加架构文档中定义的完整字段
- agent_activities表使用分区表设计，需要特殊的创建和管理策略
- Neo4j数据库创建权限可能需要特殊配置

## Dev Notes

### Testing

Dev Note: Story Requires the following tests:

- [x] Pytest Unit Tests: (nextToFile: false), coverage requirement: 85%
- [x] Integration Tests: location: `apps/backend/tests/integration/test_database_models.py`
- [ ] E2E: 本story暂不需要E2E测试

Manual Test Steps:
- 连接到开发服务器的PostgreSQL，验证所有表正确创建
- 检查表字段、约束、索引是否与设计匹配
- 使用psql验证ENUM类型和触发器工作正常
- 连接Neo4j，验证能够创建新数据库
- 在Python环境中导入Pydantic模型，验证无错误
- 测试模型验证功能（传入无效数据应报错）

## Dev Agent Record

### Agent Model Used: Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References

[[LLM: (Dev Agent) If the debug is logged to during the current story progress, create a table with the debug log and the specific task section in the debug log - do not repeat all the details in the story]]

### Completion Notes List

[[LLM: (Dev Agent) Anything the SM needs to know that deviated from the story that might impact drafting the next story.]]

### File List

Task 1 完成 - 创建 shared-types 包结构:
- **新建:** `/packages/shared-types/` - 包根目录
- **新建:** `/packages/shared-types/pyproject.toml` - Python 包配置  
- **新建:** `/packages/shared-types/package.json` - TypeScript 包配置
- **新建:** `/packages/shared-types/tsconfig.json` - TypeScript 编译配置
- **新建:** `/packages/shared-types/src/__init__.py` - Python 包初始化
- **新建:** `/packages/shared-types/src/models_db.py` - 数据库模型（基础结构）
- **新建:** `/packages/shared-types/src/models_api.py` - API 模型（基础结构）
- **新建:** `/packages/shared-types/src/events.py` - 事件模型（基础结构）
- **新建:** `/packages/shared-types/src/index.ts` - TypeScript 类型定义（基础结构）
- **新建:** `/packages/shared-types/build.sh` - 构建脚本
- **新建:** `/packages/shared-types/dev-check.sh` - 开发检查脚本
- **新建:** `/packages/shared-types/README.md` - 包文档
- **新建:** `/packages/shared-types/eslint.config.js` - ESLint 配置（基础版）

### Change Log

[[LLM: (Dev Agent) Track document versions and changes during development that deviate from story dev start]]

| Date | Version | Description | Author |
| :--- | :------ | :---------- | :----- |

## QA Results

[[LLM: QA Agent Results]]