#!/bin/bash
# åŒæ­¥å‰ç«¯çŽ¯å¢ƒé…ç½®è„šæœ¬
# å°†æ ¹ç›®å½•çš„çŽ¯å¢ƒé…ç½®è½¬æ¢ä¸º VITE_ å‰ç¼€æ ¼å¼ï¼Œä¾›å‰ç«¯ä½¿ç”¨

set -e

# èŽ·å–è„šæœ¬æ‰€åœ¨ç›®å½•çš„ç»å¯¹è·¯å¾„
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# çŽ¯å¢ƒæ–‡ä»¶è·¯å¾„
ROOT_ENV="$PROJECT_ROOT/.env"
FRONTEND_DIR="$PROJECT_ROOT/apps/frontend"

echo "ðŸ”„ åŒæ­¥å‰ç«¯çŽ¯å¢ƒé…ç½®..."

# æ£€æŸ¥æ ¹çŽ¯å¢ƒæ–‡ä»¶æ˜¯å¦å­˜åœ¨
if [[ ! -f "$ROOT_ENV" ]]; then
    echo "âŒ é”™è¯¯: æ ¹ç›®å½• .env æ–‡ä»¶ä¸å­˜åœ¨: $ROOT_ENV"
    exit 1
fi

# è¯»å–å½“å‰çŽ¯å¢ƒç±»åž‹
if [[ -L "$ROOT_ENV" ]]; then
    ENV_TYPE=$(basename "$(readlink "$ROOT_ENV")" .env)
    ENV_TYPE=${ENV_TYPE#.env.}
    echo "ðŸ“ å½“å‰çŽ¯å¢ƒ: $ENV_TYPE"
else
    echo "âš ï¸  è­¦å‘Š: .env ä¸æ˜¯ç¬¦å·é“¾æŽ¥ï¼Œä½¿ç”¨é»˜è®¤é…ç½®"
    ENV_TYPE="dev"
fi

# ç›®æ ‡å‰ç«¯çŽ¯å¢ƒæ–‡ä»¶
FRONTEND_ENV="$FRONTEND_DIR/.env.$ENV_TYPE"

echo "ðŸ“ åˆ›å»ºå‰ç«¯çŽ¯å¢ƒæ–‡ä»¶: $FRONTEND_ENV"

# ä»Žæ ¹çŽ¯å¢ƒæ–‡ä»¶æå–é…ç½®å¹¶è½¬æ¢ä¸º VITE_ æ ¼å¼
cat > "$FRONTEND_ENV" << EOF
# Frontend Environment Configuration ($ENV_TYPE)
# Auto-generated by sync-frontend-env.sh
# This file contains VITE_ prefixed variables for frontend development

EOF

# æå–ç›¸å…³é…ç½®å¹¶è½¬æ¢
source "$ROOT_ENV"

# API URL é…ç½®
if [[ -n "$NEXT_PUBLIC_API_URL" ]]; then
    echo "VITE_API_BASE_URL=$NEXT_PUBLIC_API_URL" >> "$FRONTEND_ENV"
elif [[ -n "$API_HOST" && -n "$API_PORT" ]]; then
    if [[ "$API_HOST" == "0.0.0.0" ]]; then
        # æ ¹æ®çŽ¯å¢ƒç±»åž‹è®¾ç½®æ­£ç¡®çš„ä¸»æœº
        case "$ENV_TYPE" in
            "dev")
                echo "VITE_API_BASE_URL=http://192.168.2.201:$API_PORT" >> "$FRONTEND_ENV"
                ;;
            "test")
                echo "VITE_API_BASE_URL=http://\${TEST_MACHINE_IP:-192.168.2.202}:$API_PORT" >> "$FRONTEND_ENV"
                ;;
            *)
                echo "VITE_API_BASE_URL=http://localhost:$API_PORT" >> "$FRONTEND_ENV"
                ;;
        esac
    else
        echo "VITE_API_BASE_URL=http://$API_HOST:$API_PORT" >> "$FRONTEND_ENV"
    fi
fi

# å…¶ä»–å‰ç«¯éœ€è¦çš„é…ç½®å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ 
# æ³¨æ„ï¼šä¸è¦æš´éœ²åŽç«¯ API Keys åˆ°å‰ç«¯

# æ›´æ–°å‰ç«¯ .env ç¬¦å·é“¾æŽ¥
cd "$FRONTEND_DIR"
if [[ -L ".env" ]]; then
    rm ".env"
fi
ln -sf ".env.$ENV_TYPE" ".env"

echo "âœ… å‰ç«¯çŽ¯å¢ƒé…ç½®å·²åŒæ­¥å®Œæˆ"
echo "ðŸ“‚ æ–‡ä»¶ä½ç½®: $FRONTEND_ENV"
echo "ðŸ”— ç¬¦å·é“¾æŽ¥: $FRONTEND_DIR/.env -> .env.$ENV_TYPE"